{"config":{"lang":["en"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"\u7b2c\u4e8c\u671f\u4e66\u751f\u00b7\u6d66\u8bed\u5b9e\u6218\u8425\u5b66\u4e60\u7b14\u8bb0\u53ca\u4f5c\u4e1a\u63d0\u4ea4","text":""},{"location":"#_2","title":"\u8bfe\u65f6\u4e00 \u4e66\u751f\u00b7\u6d66\u8bed\u5927\u6a21\u578b\u5168\u94fe\u8def\u5f00\u6e90\u5f00\u653e\u4f53\u7cfb","text":""},{"location":"#demo","title":"\u8bfe\u65f6\u4e8c \u8f7b\u677e\u5206\u949f\u73a9\u8f6c\u4e66\u751f\u00b7\u6d66\u8bed\u5927\u6a21\u578b\u8da3\u5473 Demo","text":""},{"location":"#rag","title":"\u8bfe\u65f6\u4e09 \"\u8334\u9999\u8c46\":\u96f6\u4ee3\u7801\u642d\u5efa\u4f60\u7684 RAG \u667a\u80fd\u52a9\u7406","text":""},{"location":"#xtuneragent","title":"\u8bfe\u65f6\u56db XTuner\u5fae\u8c03\u591a\u6a21\u6001Agent","text":""},{"location":"#lmdeployllm","title":"\u8bfe\u65f6\u4e94 LMDeploy\u91cf\u5316\u90e8\u7f72LLM\u5b9e\u8df5","text":""},{"location":"#lagent-agentlego","title":"\u8bfe\u65f6\u516d Lagent &amp; AgentLego \u667a\u80fd\u4f53\u5e94\u7528\u642d\u5efa","text":""},{"location":"#opencompass","title":"\u8bfe\u65f6\u4e03 OpenCompass \u5927\u6a21\u578b\u6d4b\u8bc4","text":""},{"location":"#_3","title":"\u8bc1\u4e66 &amp; \u8363\u8a89","text":""},{"location":"chapter1/","title":"\u8bfe\u65f6\u4e00 \u4e66\u751f\u00b7\u6d66\u8bed\u5927\u6a21\u578b\u5168\u94fe\u8def\u5f00\u6e90\u5f00\u653e\u4f53\u7cfb","text":"<p>\u4f5c\u4e1a\u8981\u6c42</p>"},{"location":"chapter1/#_2","title":"\u89c6\u9891\u7b14\u8bb0","text":"<p>\u89c6\u9891\u94fe\u63a5</p>"},{"location":"chapter1/#_3","title":"\u4e66\u751f\u00b7\u6d66\u8bed\u5927\u6a21\u578b\u4ecb\u7ecd","text":"<ul> <li>\u5168\u5e74\u5ea6\u5f00\u6e90\u4f53\u7cfb\uff1a\u4ecb\u7ecd\u4e86\u4e66\u751f\u00b7\u6d66\u8bed\u5927\u6a21\u578b\u7684\u53d1\u5c55\u5386\u7a0b\u3001\u7279\u70b9\uff0c\u5305\u62ec\u8f7b\u91cf\u7ea7\u548c\u91cd\u91cf\u7ea7\u6a21\u578b\u4ee5\u53ca\u4e0d\u540c\u80fd\u529b\u7684\u6a21\u578b\u3002</li> <li>\u901a\u7528\u5927\u6a21\u578b\u8d8b\u52bf\uff1a\u5f3a\u8c03\u4e86\u901a\u7528\u5927\u6a21\u578b\u6210\u4e3a\u4eba\u5de5\u667a\u80fd\u53d1\u5c55\u8d8b\u52bf\uff0c\u4ee5\u53ca\u4e66\u751f\u00b7\u6d66\u8bed\u5927\u6a21\u578b\u7684\u5f00\u6e90\u5386\u7a0b\u3002</li> </ul>"},{"location":"chapter1/#_4","title":"\u6a21\u578b\u6027\u80fd\u4e0e\u5e94\u7528","text":"<ul> <li>20B\u6a21\u578b\u6027\u80fd\uff1a\u5c55\u793a\u4e8620B\u6a21\u578b\u5728\u63a8\u7406\u3001\u6570\u5b66\u3001\u4ee3\u7801\u7b49\u65b9\u9762\u7684\u6027\u80fd\uff0c\u4e0eGPT-3.5\u548cGemini Pro\u7b49\u6a21\u578b\u8fdb\u884c\u4e86\u6bd4\u8f83\u3002</li> <li>\u7efc\u5408\u6027\u80fd\uff1a\u8ba8\u8bba\u4e86\u6a21\u578b\u7684\u7efc\u5408\u6027\u80fd\u8fbe\u5230\u540c\u91cf\u7ea7\u5f00\u6e90\u6a21\u578b\u9886\u5148\u6c34\u5e73\uff0c\u5e76\u4ecb\u7ecd\u4e86\u6a21\u578b\u7684\u8ba1\u7b97\u80fd\u529b\u548c\u6570\u636e\u5206\u6790\u529f\u80fd\u3002</li> </ul>"},{"location":"chapter1/#_5","title":"\u6a21\u578b\u9009\u578b\u4e0e\u5e94\u7528\u6d41\u7a0b","text":"<ul> <li>\u6a21\u578b\u9009\u578b\uff1a\u4ece\u6a21\u578b\u9009\u578b\u5230\u5e94\u7528\u7684\u6574\u4e2a\u6d41\u7a0b\uff0c\u5305\u62ec\u5404\u4e2a\u73af\u8282\u9700\u8981\u505a\u7684\u4e8b\u60c5\u3002</li> <li>\u5168\u94fe\u6761\u5de5\u5177\u4f53\u7cfb\uff1a\u4ecb\u7ecd\u4e86\u4e66\u751f\u00b7\u6d66\u8bed\u7684\u5168\u94fe\u6761\u5de5\u5177\u4f53\u7cfb\u548c\u5f00\u6e90\u6570\u636e\u96c6\uff0c\u5305\u62ec\u6570\u636e\u3001\u9884\u8bad\u7ec3\u3001\u5fae\u8c03\u3001\u90e8\u7f72\u3001\u8bc4\u6d4b\u3001\u5e94\u7528\u7b49\u73af\u8282\u3002</li> </ul>"},{"location":"chapter1/#open-compass-20","title":"Open Compass 2.0\u8bc4\u6d4b\u4f53\u7cfb","text":"<ul> <li>\u8bc4\u6d4b\u4f53\u7cfb\u5f00\u53d1\uff1a\u4ecb\u7ecd\u4e86Open Compass 2.0\u601d\u5357\u5927\u6a21\u578b\u8bc4\u6d4b\u4f53\u7cfb\u7684\u5f00\u53d1\u548c\u5f00\u6e90\uff0c\u4ee5\u53ca\u8bc4\u6d4b\u57fa\u51c6\u793e\u533a\u7684\u5efa\u7acb\u3002</li> <li>\u8bc4\u6d4b\u96c6\u9002\u914d\uff1a\u5f3a\u8c03\u4e86Open Compass\u5df2\u7ecf\u9002\u914d\u8d85\u8fc7100\u4e2a\u8bc4\u6d4b\u96c6\uff0c\u662f\u56fd\u5185\u6700\u5b8c\u5584\u7684\u8bc4\u6d4b\u4f53\u7cfb\u4e4b\u4e00\u3002</li> </ul>"},{"location":"chapter1/#_6","title":"\u63a8\u7406\u548c\u90e8\u7f72\u5de5\u5177","text":"<ul> <li>\u5f00\u6e90\u793e\u533a\u8d8b\u52bf\uff1a\u8ba8\u8bba\u4e86\u82f1\u7279\u5c14\u5f00\u6e90\u6a21\u578b\u63a8\u7406\u548c\u90e8\u7f72\u5de5\u5177\u7684\u8bc4\u6d4b\u548c\u53d1\u5c55\u8d8b\u52bf\u3002</li> <li>\u667a\u80fd\u4f53\u6846\u67b6\uff1a\u4ecb\u7ecd\u4e86\u667a\u80fd\u4f53\u6846\u67b6Legend\u548c\u591a\u5a92\u4f53\u591a\u6a21\u6001\u667a\u80fd\u4f53\u5de5\u5177\u7bb1\u7684\u4f7f\u7528\u548c\u5f00\u53d1\u3002</li> </ul>"},{"location":"chapter1/#_7","title":"\u6280\u672f\u62a5\u544a\u7b14\u8bb0","text":"<p>InternLM2 \u6280\u672f\u62a5\u544a</p>"},{"location":"chapter1/#_8","title":"\u603b\u7ed3\uff1a","text":"<ul> <li>\u6a21\u578b\u4ecb\u7ecd\uff1a</li> <li>InternLM2\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u5927\u578b\u8bed\u8a00\u6a21\u578b\uff0c\u65e8\u5728\u901a\u8fc7\u521b\u65b0\u7684\u9884\u8bad\u7ec3\u548c\u4f18\u5316\u6280\u672f\uff0c\u5728\u516d\u4e2a\u7ef4\u5ea6\u548c30\u4e2a\u57fa\u51c6\u6d4b\u8bd5\u4e2d\u8d85\u8d8a\u5176\u524d\u8eab\u3002</li> <li> <p>\u6a21\u578b\u901a\u8fc7\u7cbe\u5fc3\u51c6\u5907\u7684\u591a\u6837\u5316\u6570\u636e\u7c7b\u578b\uff08\u5305\u62ec\u6587\u672c\u3001\u4ee3\u7801\u548c\u957f\u6587\u672c\u6570\u636e\uff09\u8fdb\u884c\u9884\u8bad\u7ec3\uff0c\u6709\u6548\u6355\u6349\u957f\u671f\u4f9d\u8d56\u5173\u7cfb\u3002</p> </li> <li> <p>\u6280\u672f\u7279\u70b9\uff1a</p> <ul> <li>\u91c7\u7528Group Query Attention (GQA)\u6280\u672f\uff0c\u63d0\u9ad8\u957f\u5e8f\u5217\u63a8\u7406\u7684\u6548\u7387\u3002</li> <li>\u901a\u8fc7Supervised Fine-Tuning (SFT)\u548cConditional Online Reinforcement Learning from Human Feedback (COOL RLHF)\u7b56\u7565\u8fdb\u884c\u6a21\u578b\u5bf9\u9f50\uff0c\u89e3\u51b3\u4eba\u7c7b\u504f\u597d\u51b2\u7a81\u548c\u5956\u52b1\u9ed1\u5ba2\u95ee\u9898\u3002</li> </ul> </li> <li> <p>\u6a21\u578b\u6027\u80fd\uff1a</p> <ul> <li>InternLM2\u5728\u957f\u6587\u672c\u5efa\u6a21\u65b9\u9762\u8868\u73b0\u51fa\u8272\uff0c\u80fd\u591f\u5728200k\u7684\u201c\u9488\u5806\u201d\u6d4b\u8bd5\u4e2d\u51c6\u786e\u8bc6\u522b\u6240\u6709\u201c\u9488\u201d\u3002</li> <li>\u901a\u8fc7\u4e0d\u540c\u8bad\u7ec3\u9636\u6bb5\u548c\u6a21\u578b\u5927\u5c0f\u7684\u53d1\u5e03\uff0c\u63d0\u4f9b\u4e86\u6a21\u578b\u6f14\u5316\u7684\u6d1e\u5bdf\u3002</li> </ul> </li> <li> <p>\u6570\u636e\u51c6\u5907\uff1a</p> <ul> <li>\u8be6\u7ec6\u4ecb\u7ecd\u4e86\u6587\u672c\u6570\u636e\u3001\u4ee3\u7801\u6570\u636e\u548c\u957f\u6587\u672c\u6570\u636e\u7684\u9884\u5904\u7406\u6d41\u7a0b\u3002</li> <li>\u5f3a\u8c03\u4e86\u6570\u636e\u8fc7\u6ee4\u3001\u53bb\u91cd\u548c\u8d28\u91cf\u7b5b\u9009\u7684\u91cd\u8981\u6027\u3002</li> </ul> </li> <li> <p>\u8bad\u7ec3\u6846\u67b6\uff1a</p> <ul> <li>\u4f7f\u7528InternEvo\u6846\u67b6\u8fdb\u884c\u6a21\u578b\u8bad\u7ec3\uff0c\u652f\u6301\u9ad8\u6548\u7684GPU\u5185\u5b58\u7ba1\u7406\u548c\u901a\u4fe1\u4f18\u5316\u3002</li> <li>\u4ecb\u7ecd\u4e86\u6a21\u578b\u7ed3\u6784\u7684\u8bbe\u8ba1\uff0c\u5305\u62ec\u5bf9Transformer\u67b6\u6784\u7684\u6539\u8fdb\u3002</li> </ul> </li> <li> <p>\u8bc4\u4f30\u4e0e\u5206\u6790\uff1a</p> <ul> <li>\u5728\u591a\u4e2a\u4e0b\u6e38\u4efb\u52a1\u4e0a\u8bc4\u4f30\u6a21\u578b\u6027\u80fd\uff0c\u5305\u62ec\u8bed\u8a00\u548c\u77e5\u8bc6\u3001\u63a8\u7406\u548c\u6570\u5b66\u3001\u7f16\u7801\u7b49\u3002</li> <li>\u5bf9\u6a21\u578b\u5728\u5bf9\u9f50\u4efb\u52a1\u4e0a\u7684\u6027\u80fd\u8fdb\u884c\u4e86\u8bc4\u4f30\uff0c\u5305\u62ec\u82f1\u8bed\u548c\u4e2d\u6587\u7684\u4e3b\u89c2\u8bc4\u4f30\u3002</li> </ul> </li> </ul>"},{"location":"chapter1/#_9","title":"\u5b66\u4e60\u7b14\u8bb0\uff1a","text":"<ul> <li>\u957f\u6587\u672c\u5efa\u6a21\uff1aInternLM2\u901a\u8fc7GQA\u548c\u957f\u6587\u672c\u9884\u8bad\u7ec3\u6570\u636e\uff0c\u63d0\u9ad8\u4e86\u5904\u7406\u957f\u6587\u672c\u7684\u80fd\u529b\u3002</li> <li>\u6a21\u578b\u5bf9\u9f50\uff1aCOOL RLHF\u7b56\u7565\u901a\u8fc7\u6761\u4ef6\u5956\u52b1\u6a21\u578b\u548c\u591a\u8f6e\u5728\u7ebfRLHF\uff0c\u63d0\u9ad8\u4e86\u6a21\u578b\u4e0e\u4eba\u7c7b\u504f\u597d\u7684\u4e00\u81f4\u6027\u3002</li> <li>\u6570\u636e\u51c6\u5907\uff1a\u5728\u9884\u8bad\u7ec3\u8fc7\u7a0b\u4e2d\uff0c\u5bf9\u6570\u636e\u7684\u7b5b\u9009\u548c\u5904\u7406\u81f3\u5173\u91cd\u8981\uff0c\u8fd9\u76f4\u63a5\u5f71\u54cd\u6a21\u578b\u7684\u6027\u80fd\u548c\u5b89\u5168\u6027\u3002</li> <li>\u8bad\u7ec3\u6846\u67b6\uff1aInternEvo\u6846\u67b6\u901a\u8fc7\u6df7\u5408\u5e76\u884c\u548c\u5197\u4f59\u5206\u7247\u6280\u672f\uff0c\u63d0\u9ad8\u4e86\u6a21\u578b\u8bad\u7ec3\u7684\u6548\u7387\u548c\u53ef\u6269\u5c55\u6027\u3002</li> <li>\u8bc4\u4f30\u65b9\u6cd5\uff1a\u6a21\u578b\u7684\u8bc4\u4f30\u4e0d\u4ec5\u8981\u5173\u6ce8\u5ba2\u89c2\u6027\u80fd\u6307\u6807\uff0c\u8fd8\u8981\u8003\u8651\u4e3b\u89c2\u8bc4\u4f30\uff0c\u4ee5\u786e\u4fdd\u6a21\u578b\u7684\u8f93\u51fa\u4e0e\u4eba\u7c7b\u504f\u597d\u76f8\u7b26\u3002</li> </ul>"},{"location":"chapter2/","title":"\u8bfe\u65f6\u4e8c \u8f7b\u677e\u5206\u949f\u73a9\u8f6c\u4e66\u751f\u00b7\u6d66\u8bed\u5927\u6a21\u578b\u8da3\u5473 Demo","text":"<p>\u98de\u4e66\u5730\u5740</p>"},{"location":"chapter2/#1","title":"1. \u63d0\u4ea4\u7684\u4f5c\u4e1a\u7ed3\u679c","text":"<p>\u4f5c\u4e1a\u8981\u6c42</p>"},{"location":"chapter2/#11-1","title":"1.1 \u4f5c\u4e1a1","text":"<ul> <li>\u4f7f\u7528 InternLM2-Chat-1.8B \u6a21\u578b\u751f\u6210 300 \u5b57\u7684\u5c0f\u6545\u4e8b\uff08\u622a\u56fe\uff09</li> </ul>"},{"location":"chapter2/#12-2","title":"1.2 \u4f5c\u4e1a2","text":"<ul> <li>\u719f\u6089 huggingface \u4e0b\u8f7d\u529f\u80fd\uff0c\u4f7f\u7528 huggingface_hub python \u5305\uff0c\u4e0b\u8f7d InternLM2-Chat-7B \u7684 config.json \u6587\u4ef6\u5230\u672c\u5730\uff08\u622a\u56fe\u4e0b\u8f7d\u8fc7\u7a0b\uff09</li> </ul>"},{"location":"chapter2/#13-3","title":"1.3 \u4f5c\u4e1a3","text":"<ul> <li> <p>\u5b8c\u6210 Lagent \u5de5\u5177\u8c03\u7528 \u6570\u636e\u5206\u6790 Demo \u90e8\u7f72\uff08\u622a\u56fe\uff09</p> </li> <li> <p>\u89c2\u5bdf\u6a21\u578b\u52a0\u8f7d\u8fdb\u5ea6</p> <p></p> </li> <li> <p>\u52fe\u9009\u6570\u636e\u5206\u6790</p> <p></p> </li> </ul>"},{"location":"chapter2/#14-4","title":"1.4 \u4f5c\u4e1a4","text":"<ul> <li> <p>\u5b8c\u6210 \u6d66\u8bed\u00b7\u7075\u7b142 \u7684 \u56fe\u6587\u521b\u4f5c \u53ca \u89c6\u89c9\u95ee\u7b54 \u90e8\u7f72\uff08\u622a\u56fe\uff09</p> </li> <li> <p>\u56fe\u6587\u521b\u4f5c     </p> </li> <li> <p>\u89c6\u89c9\u95ee\u7b54     </p> </li> </ul>"},{"location":"chapter2/#15","title":"1.5 \u4e1a\u7b14\u8bb0","text":""},{"location":"chapter2/#151","title":"1.5.1 \u6a21\u578b\u751f\u6210\u5c0f\u6545\u4e8b","text":""},{"location":"chapter2/#152-huggingface","title":"1.5.2 huggingface\u4e0b\u8f7d\u6a21\u578b","text":"<ul> <li> <p>\u6a21\u578b\u5730\u5740</p> </li> <li> <p>huggingface hub python\u6587\u6863</p> </li> </ul> <p>\u8fdb\u5165demo\u73af\u5883\uff08conda\uff09\uff0c\u8f93\u5165python\u8fdb\u5165python\u547d\u4ee4\u7f16\u5199\u5982\u4e0b\u4ee3\u7801\u8fdb\u884c\u6a21\u578bconfig\u4e0b\u8f7d</p> <pre><code>from huggingface_hub import hf_hub_download\nhf_hub_download(repo_id=\"internlm/internlm2-chat-1_8b\", filename=\"config.json\")\n</code></pre> <p></p>"},{"location":"chapter2/#153-lagent","title":"1.5.3 Lagent \u667a\u80fd\u4f53","text":""},{"location":"chapter2/#154-2","title":"1.5.4 \u7075\u7b142\u90e8\u7f72","text":"<ul> <li> <p>\u56fe\u6587\u521b\u4f5c</p> </li> <li> <p>\u89c6\u89c9\u95ee\u7b54</p> </li> </ul>"},{"location":"chapter2/#2","title":"2. \u89c6\u9891\u7b14\u8bb0","text":"<p>\u89c6\u9891\u94fe\u63a5</p>"},{"location":"chapter2/#_1","title":"\u5b9e\u6218\u4efb\u52a1","text":"<ul> <li>\u5217\u8868   </li> </ul>"},{"location":"chapter2/#3","title":"3. \u6587\u6863\u590d\u73b0\u7b14\u8bb0","text":"<p>\u6587\u6863\u94fe\u63a5</p>"},{"location":"chapter2/#31-internlm2-chat-18b","title":"3.1 \u90e8\u7f72InternLM2-Chat-1.8B \u6a21\u578b\u8fdb\u884c\u667a\u80fd\u5bf9\u8bdd","text":""},{"location":"chapter2/#311","title":"3.1.1 \u914d\u7f6e\u57fa\u7840\u73af\u5883","text":"<ul> <li>\u521b\u5efa\u5f00\u53d1\u673a</li> </ul> <p>\u8fdb\u5165\u7b97\u529b\u5e73\u53f0\u70b9\u51fb\u521b\u5efa\u5f00\u53d1\u673a\uff0c\u9009\u62e9\u7b97\u529b\u2014\u2014&gt;\u5f00\u53d1\u673a\u547d\u540d\u2014\u2014&gt;\u9009\u62e9\u955c\u50cf\uff08cuda11.7-conda\uff09\u2014\u2014&gt;\u8bbe\u7f6e\u7b97\u529b\u7528\u65f6\u3002</p> <p></p> <ul> <li>\u914d\u7f6e\u5f00\u53d1\u673a\u5f00\u53d1\u73af\u5883</li> </ul> <p>\u8fdb\u5165\u5f00\u53d1\u673a\u7ec8\u7aef\uff0c\u8f93\u5165\u5982\u4e0b\u547d\u4ee4\u5b89\u88c5conda\u5f00\u53d1\u73af\u5883\uff08\u5b9e\u6d4b\u8fd0\u884c12\u5206\u949f\u5de6\u53f3\uff09</p> <p><pre><code>studio-conda -o internlm-base -t demo\n# \u4e0e studio-conda \u7b49\u6548\u7684\u914d\u7f6e\u65b9\u6848\n# conda create -n demo python==3.10 -y\n# conda activate demo\n# conda install pytorch==2.0.1 torchvision==0.15.2 torchaudio==2.0.2 pytorch-cuda=11.7 -c pytorch -c nvidia\n</code></pre> </p> <ul> <li> <p>conda create -n demo python==3.10 -y: \u8fd9\u4e2a\u547d\u4ee4\u4f7f\u7528conda\u5305\u7ba1\u7406\u5668\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a\"demo\"\u7684\u73af\u5883\uff0c\u5e76\u6307\u5b9a\u4f7f\u7528Python 3.10\u7248\u672c\u3002-y\u9009\u9879\u8868\u793a\u5728\u521b\u5efa\u73af\u5883\u65f6\u81ea\u52a8\u786e\u8ba4\u6240\u6709\u63d0\u793a\uff0c\u65e0\u9700\u624b\u52a8\u786e\u8ba4\u3002</p> </li> <li> <p>conda activate demo: \u8fd9\u4e2a\u547d\u4ee4\u7528\u4e8e\u6fc0\u6d3b\u540d\u4e3a\"demo\"\u7684\u73af\u5883\u3002\u6fc0\u6d3b\u73af\u5883\u540e\uff0c\u6240\u6709\u540e\u7eed\u7684\u547d\u4ee4\u548c\u64cd\u4f5c\u90fd\u5c06\u5728\u8be5\u73af\u5883\u4e2d\u8fdb\u884c\u3002</p> </li> <li> <p>conda install pytorch==2.0.1 torchvision==0.15.2 torchaudio==2.0.2 pytorch-cuda=11.7 -c pytorch -c nvidia: \u8fd9\u4e2a\u547d\u4ee4\u4f7f\u7528conda\u5b89\u88c5\u7279\u5b9a\u7248\u672c\u7684PyTorch\u53ca\u5176\u76f8\u5173\u5e93\u3002pytorch==2.0.1\u8868\u793a\u5b89\u88c5PyTorch 2.0.1\u7248\u672c\uff0ctorchvision==0.15.2\u8868\u793a\u5b89\u88c5torchvision\u5e93\u76840.15.2\u7248\u672c\uff0ctorchaudio==2.0.2\u8868\u793a\u5b89\u88c5torchaudio\u5e93\u76842.0.2\u7248\u672c\u3002pytorch-cuda=11.7\u8868\u793a\u5b89\u88c5\u652f\u6301CUDA 11.7\u7684PyTorch\u7248\u672c\u3002-c pytorch -c nvidia\u6307\u5b9a\u4e86\u4ecepytorch\u548cnvidia\u8fd9\u4e24\u4e2a\u6e20\u9053\u8fdb\u884c\u5b89\u88c5\u3002</p> </li> </ul> <p></p> <p></p> <p>\u67e5\u770bconda\u73af\u5883list</p> <p></p> <p>\u8fdb\u5165\u5f00\u53d1\u73af\u5883   <pre><code>  conda activate demo\n</code></pre></p> <p>\u8fdb\u884c\u73af\u5883\u4f9d\u8d56\u5305\u5b89\u88c5</p> <pre><code> pip install huggingface-hub==0.17.3\n pip install transformers==4.34 \n pip install psutil==5.9.8\n pip install accelerate==0.24.1\n pip install streamlit==1.32.2 \n pip install matplotlib==3.8.3 \n pip install modelscope==1.9.5\n pip install sentencepiece==0.1.99\n</code></pre> <pre><code>- huggingface-hub: \u63d0\u4f9b\u4e86\u4e0eHugging Face\u6a21\u578b\u548c\u6570\u636e\u96c6\u5e93\u7684\u4ea4\u4e92\u529f\u80fd\u3002\n\n- transformers: \u63d0\u4f9b\u4e86\u7528\u4e8e\u81ea\u7136\u8bed\u8a00\u5904\u7406\u4efb\u52a1\u7684\u9884\u8bad\u7ec3\u6a21\u578b\u548c\u76f8\u5173\u5de5\u5177\u3002\n\n- psutil: \u63d0\u4f9b\u4e86\u4e00\u4e2a\u8de8\u5e73\u53f0\u7684\u5e93\uff0c\u7528\u4e8e\u83b7\u53d6\u7cfb\u7edf\u4fe1\u606f\u548c\u8fdb\u7a0b\u7ba1\u7406\u3002\n\n- accelerate: \u63d0\u4f9b\u4e86\u7528\u4e8e\u52a0\u901f\u6df1\u5ea6\u5b66\u4e60\u8bad\u7ec3\u7684\u5de5\u5177\u548cAPI\u3002\n\n- streamlit: \u63d0\u4f9b\u4e86\u4e00\u4e2a\u7528\u4e8e\u6784\u5efa\u4ea4\u4e92\u5f0fWeb\u5e94\u7528\u7a0b\u5e8f\u7684Python\u5e93\u3002\n\n- matplotlib: \u63d0\u4f9b\u4e86\u4e00\u4e2a\u7528\u4e8e\u7ed8\u5236\u56fe\u8868\u548c\u53ef\u89c6\u5316\u6570\u636e\u7684Python\u5e93\u3002\n\n- modelscope: \u63d0\u4f9b\u4e86\u4e00\u4e2a\u7528\u4e8e\u5206\u6790\u548c\u6bd4\u8f83\u673a\u5668\u5b66\u4e60\u6a21\u578b\u7684Python\u5e93\u3002\n\n- sentencepiece: \u63d0\u4f9b\u4e86\u4e00\u4e2a\u7528\u4e8e\u5206\u8bcd\u548c\u751f\u6210\u5b50\u8bcd\u5355\u5143\u7684\u5de5\u5177\u548c\u5e93\u3002\n</code></pre>"},{"location":"chapter2/#312","title":"3.1.2 \u4e0b\u8f7d\u5927\u6a21\u578b","text":"<p>\u8fdb\u5165jupyter\u7ec8\u7aef\uff0c\u8fdb\u5165demo\u73af\u5883\uff08conda\uff09\uff0ccd\u5230\u5f53\u524djupyter\u8def\u5f84\u4e0b\u3002</p> <p><pre><code>  cd /root\n  conda activate demo\n</code></pre> </p> <p>\u521b\u5efa\u6587\u4ef6\u5939&amp;python\u6587\u4ef6</p> <pre><code> mkdir demo\n cd demo\n tourch cli_demo.py\n tourch download_mini.py\n</code></pre> <p></p> <p>\u7f16\u5199\u811a\u672c\u2014\u2014download_mini.py</p> <pre><code>import os  # \u5bfc\u5165os\u6a21\u5757\uff0c\u7528\u4e8e\u64cd\u4f5c\u7cfb\u7edf\u76f8\u5173\u7684\u64cd\u4f5c\nfrom modelscope.hub.snapshot_download import snapshot_download  # \u4ecemodelscope.hub\u6a21\u5757\u5bfc\u5165snapshot_download\u51fd\u6570\uff0c\u7528\u4e8e\u4e0b\u8f7d\u6a21\u578b\n\n# \u521b\u5efa\u4fdd\u5b58\u6a21\u578b\u76ee\u5f55\nos.system(\"mkdir /root/models\")  # \u4f7f\u7528os.system\u6267\u884c\u547d\u4ee4\u884c\u547d\u4ee4\uff0c\u521b\u5efa\u4e00\u4e2a\u540d\u4e3amodels\u7684\u76ee\u5f55\u5728/root\u8def\u5f84\u4e0b\n\n# save_dir\u662f\u6a21\u578b\u4fdd\u5b58\u5230\u672c\u5730\u7684\u76ee\u5f55\nsave_dir=\"/root/models\"  # \u5b9a\u4e49\u53d8\u91cfsave_dir\uff0c\u5176\u503c\u4e3a\u6a21\u578b\u4fdd\u5b58\u7684\u76ee\u5f55\u8def\u5f84\n\n# \u4f7f\u7528snapshot_download\u51fd\u6570\u4e0b\u8f7d\u6a21\u578b\uff0c\u53c2\u6570\u5305\u62ec\u6a21\u578b\u7684\u540d\u5b57\uff0c\u7f13\u5b58\u76ee\u5f55\u548c\u7248\u672c\u53f7\nsnapshot_download(\"Shanghai_AI_Laboratory/internlm2-chat-1_8b\", \n                  cache_dir=save_dir, \n                  revision='v1.1.0')\n</code></pre> <p>\u6267\u884c\u547d\u4ee4\u4e0b\u8f7d\u6a21\u578b</p> <p><pre><code>  python download_mini.py\n</code></pre> </p> <p></p> <p>#### 3.1.3 \u57fa\u4e8e\u5927\u6a21\u578b\u5bf9\u8bdd</p> <pre><code>\u7f16\u5199cli_demo.py\u811a\u672c\n</code></pre> <pre><code>      import torch  # \u5bfc\u5165torch\u5e93\uff0c\u7528\u4e8e\u8fdb\u884c\u6df1\u5ea6\u5b66\u4e60\u6a21\u578b\u7684\u64cd\u4f5c\n      from transformers import AutoTokenizer, AutoModelForCausalLM  # \u4ecetransformers\u5e93\u4e2d\u5bfc\u5165AutoTokenizer\u548cAutoModelForCausalLM\uff0c\u7528\u4e8e\u5904\u7406\u81ea\u7136\u8bed\u8a00\u548c\u52a0\u8f7d\u6a21\u578b\n\n      model_name_or_path = \"/root/models/Shanghai_AI_Laboratory/internlm2-chat-1_8b\"  # \u6a21\u578b\u7684\u540d\u79f0\u6216\u8def\u5f84\n\n      tokenizer = AutoTokenizer.from_pretrained(model_name_or_path, trust_remote_code=True, device_map='cuda:0')  # \u52a0\u8f7d\u9884\u8bad\u7ec3\u7684tokenizer\n      model = AutoModelForCausalLM.from_pretrained(model_name_or_path, trust_remote_code=True, torch_dtype=torch.bfloat16, device_map='cuda:0')  # \u52a0\u8f7d\u9884\u8bad\u7ec3\u7684\u6a21\u578b\n      model = model.eval()  # \u5c06\u6a21\u578b\u8bbe\u7f6e\u4e3a\u8bc4\u4f30\u6a21\u5f0f\n\n      system_prompt = \"\"\"You are an AI assistant whose name is InternLM (\u4e66\u751f\u00b7\u6d66\u8bed).\n      - InternLM (\u4e66\u751f\u00b7\u6d66\u8bed) is a conversational language model that is developed by Shanghai AI Laboratory (\u4e0a\u6d77\u4eba\u5de5\u667a\u80fd\u5b9e\u9a8c\u5ba4). It is designed to be helpful, honest, and harmless.\n      - InternLM (\u4e66\u751f\u00b7\u6d66\u8bed) can understand and communicate fluently in the language chosen by the user such as English and \u4e2d\u6587.\n      \"\"\"  # \u7cfb\u7edf\u63d0\u793a\u4fe1\u606f\n\n      messages = [(system_prompt, '')]  # \u521d\u59cb\u5316\u6d88\u606f\u5217\u8868\n\n      print(\"=============Welcome to InternLM chatbot, type 'exit' to exit.=============\")  # \u6253\u5370\u6b22\u8fce\u4fe1\u606f\n\n      while True:  # \u5faa\u73af\u63a5\u6536\u7528\u6237\u8f93\u5165\n        input_text = input(\"\\nUser  &gt;&gt;&gt; \")  # \u83b7\u53d6\u7528\u6237\u8f93\u5165\n        input_text = input_text.replace(' ', '')  # \u53bb\u9664\u7528\u6237\u8f93\u5165\u7684\u7a7a\u683c\n        if input_text == \"exit\":  # \u5982\u679c\u7528\u6237\u8f93\u5165'exit'\uff0c\u5219\u9000\u51fa\u5faa\u73af\n          break\n\n        length = 0\n        for response, _ in model.stream_chat(tokenizer, input_text, messages):  # \u4f7f\u7528\u6a21\u578b\u8fdb\u884c\u804a\u5929\n          if response is not None:  # \u5982\u679c\u54cd\u5e94\u4e0d\u4e3a\u7a7a\n            print(response[length:], flush=True, end=\"\")  # \u6253\u5370\u54cd\u5e94\n            length = len(response)  # \u66f4\u65b0\u54cd\u5e94\u957f\u5ea6\n</code></pre> <p></p> <p>\u8f93\u5165\u63d0\u793a\u8bcd\uff1a\u521b\u4f5c\u4e00\u4e2a300\u5b57\u7684\u5bd3\u8a00\u6545\u4e8b\uff0c\u8981\u6c42\u6709\u8da3   </p>"},{"location":"chapter2/#32-chat-18b","title":"3.2 \u90e8\u7f72\u516b\u6212-Chat-1.8B\u6a21\u578b","text":""},{"location":"chapter2/#321","title":"3.2.1 \u8fdb\u5165\u73af\u5883&amp;\u4e0b\u8f7d\u6e90\u7801","text":"<pre><code>conda activate demo\ncd /root/\ngit clone https://gitee.com/InternLM/Tutorial -b camp2\n# git clone https://github.com/InternLM/Tutorial -b camp2\ncd /root/Tutorial\n</code></pre>"},{"location":"chapter2/#322-chat-","title":"3.2.2 \u8fd0\u884cChat-\u516b\u6212","text":"<ul> <li>bajie_download.py</li> </ul> <pre><code>import os\n#\u6a21\u578b\u4e0b\u8f7d\nfrom modelscope.hub.snapshot_download import snapshot_download\n\n# \u521b\u5efa\u4fdd\u5b58\u6a21\u578b\u76ee\u5f55\nos.system(\"mkdir -p /root/models\")\n\n# save_dir\u662f\u6a21\u578b\u4fdd\u5b58\u5230\u672c\u5730\u7684\u76ee\u5f55\nsave_dir=\"/root/models\"\n\nsnapshot_download('JimmyMa99/BaJie-Chat-mini', \n                  cache_dir=save_dir)\n</code></pre> <ul> <li>\u8fd0\u884c\u6a21\u578b\u4e0b\u8f7d\u4ee3\u7801 <pre><code>python /root/Tutorial/helloworld/bajie_download.py\n</code></pre></li> </ul> <ul> <li>\u8fd0\u884c\u542f\u52a8streamlit\u524d\u7aef\u9875\u9762</li> </ul> <pre><code>streamlit run /root/Tutorial/helloworld/bajie_chat.py --server.address 127.0.0.1 --server.port 6006\n</code></pre> <ul> <li>\u672c\u5730\u7aef\u53e3\u6620\u5c04</li> </ul> <p>\u70b9\u51fbSSH\u8fde\u63a5\uff0c\u627e\u5bfb\u81ea\u5df1\u7684\u7aef\u53e3\u53f7\uff0c\u5e76\u5bf9\u5e94\u4fee\u6539ssh\u6620\u5c04\u547d\u4ee4\u7684\u7aef\u53e3\u53f7</p> <pre><code># \u4ece\u672c\u5730\u4f7f\u7528 ssh \u8fde\u63a5 studio \u7aef\u53e3\n# \u5c06\u4e0b\u65b9\u7aef\u53e3\u53f7 38374 \u66ff\u6362\u6210\u81ea\u5df1\u7684\u7aef\u53e3\u53f7\nssh -CNg -L 6006:127.0.0.1:6006 root@ssh.intern-ai.org.cn -p 38374\n</code></pre> <p><pre><code>ssh: \u8fd9\u662fSSH\u5ba2\u6237\u7aef\u547d\u4ee4\uff0c\u7528\u4e8e\u5efa\u7acb\u5b89\u5168\u7684\u8fdc\u7a0b\u8fde\u63a5\u3002\n\n-CNg: \u8fd9\u662fssh\u547d\u4ee4\u7684\u9009\u9879\u3002-C\u9009\u9879\u542f\u7528\u538b\u7f29\uff0c-N\u9009\u9879\u6307\u793assh\u4e0d\u8981\u6267\u884c\u8fdc\u7a0b\u547d\u4ee4\uff0c-g\u9009\u9879\u5141\u8bb8\u8fdc\u7a0b\u4e3b\u673a\u901a\u8fc7\u96a7\u9053\u8fde\u63a5\u5230\u672c\u5730\u4e3b\u673a\u3002\n\n-L 6006:127.0.0.1:6006: \u8fd9\u662fssh\u547d\u4ee4\u7684\u7aef\u53e3\u8f6c\u53d1\u9009\u9879\u3002\u5b83\u6307\u793assh\u5728\u672c\u5730\u4e3b\u673a\u7684\u7aef\u53e36006\u4e0a\u76d1\u542c\uff0c\u5e76\u5c06\u6240\u6709\u4f20\u5165\u7684\u8fde\u63a5\u8f6c\u53d1\u5230\u8fdc\u7a0b\u4e3b\u673a\u7684127.0.0.1:6006\u3002\n\nroot@ssh.intern-ai.org.cn: \u8fd9\u662f\u8fdc\u7a0b\u4e3b\u673a\u7684\u7528\u6237\u540d\u548c\u4e3b\u673a\u540d\u3002\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u7528\u6237\u540d\u662froot\uff0c\u4e3b\u673a\u540d\u662fssh.intern-ai.org.cn\u3002\n\n-p 38374: \u8fd9\u662fssh\u547d\u4ee4\u7684\u7aef\u53e3\u9009\u9879\u3002\u5b83\u6307\u793assh\u4f7f\u752838374\u7aef\u53e3\u8fde\u63a5\u5230\u8fdc\u7a0b\u4e3b\u673a\u3002\n</code></pre> </p> <ul> <li>\u6a21\u578b\u52a0\u8f7d\u4e2d   </li> <li>\u52a0\u8f7d\u5b8c\u6210\u754c\u9762   </li> <li>\u5bf9\u8bdd   </li> </ul>"},{"location":"chapter2/#33-lagent","title":"3.3 Lagent \u667a\u80fd\u4f53","text":""},{"location":"chapter2/#331","title":"3.3.1 \u524d\u7f6e\u77e5\u8bc6","text":"<p>Lagent \u662f\u4e00\u4e2a\u8f7b\u91cf\u7ea7\u3001\u5f00\u6e90\u7684\u57fa\u4e8e\u5927\u8bed\u8a00\u6a21\u578b\u7684\u667a\u80fd\u4f53\uff08agent\uff09\u6846\u67b6\uff0c\u652f\u6301\u7528\u6237\u5feb\u901f\u5730\u5c06\u4e00\u4e2a\u5927\u8bed\u8a00\u6a21\u578b\u8f6c\u53d8\u4e3a\u591a\u79cd\u7c7b\u578b\u7684\u667a\u80fd\u4f53\uff0c\u5e76\u63d0\u4f9b\u4e86\u4e00\u4e9b\u5178\u578b\u5de5\u5177\u4e3a\u5927\u8bed\u8a00\u6a21\u578b\u8d4b\u80fd\u3002\u5b83\u7684\u6574\u4e2a\u6846\u67b6\u56fe\u5982\u4e0b:</p> <p></p>"},{"location":"chapter2/#332","title":"3.3.2 \u5b9e\u73b0\u8fc7\u7a0b","text":""},{"location":"chapter2/#3321","title":"3.3.2.1 \u5f00\u53d1\u673a\u8bbe\u7f6e","text":"<ul> <li>\u5f00\u542f 30% A100</li> </ul> <p>\u521b\u5efa\u5f00\u53d1\u673a\u547d\u540d\u4e3aLagentPro\uff0c\u955c\u50cf\u9009\u62e9Cuda11.7\uff0c\u8d44\u6e90\u914d\u7f6e\u73b0\u5b5820G\uff0c\u5185\u5b5872G</p> <p></p> <ul> <li>\u8fdb\u5165\u5f00\u53d1\u673a\uff0c\u8fdb\u5165demo\u73af\u5883</li> </ul> <p><pre><code>conda activate demo\n</code></pre> </p> <ul> <li>\u4e0b\u8f7dLagent\u6e90\u7801</li> </ul> <pre><code>cd /root/demo\ngit clone https://gitee.com/internlm/lagent.git\n# git clone https://github.com/internlm/lagent.git\ncd /root/demo/lagent\ngit checkout 581d9fb8987a5d9b72bb9ebd37a95efd47d479ac\npip install -e . # \u6e90\u7801\u5b89\u88c5\n</code></pre> <p></p> <p></p>"},{"location":"chapter2/#3322-lagentinternlm2","title":"3.3.2.2 \u4f7f\u7528Lagent\u8fd0\u884cInternLM2\u5927\u6a21\u578b\u7684\u667a\u80fd\u4f53","text":"<ul> <li>\u6784\u9020\u8f6f\u94fe\u63a5\u5feb\u6377\u8bbf\u95ee\u65b9\u5f0f</li> </ul> <p><pre><code>ln -s /root/share/new_models/Shanghai_AI_Laboratory/internlm2-chat-7b /root/models/internlm2-chat-7b\n</code></pre> - \u4fee\u6539lagent\u8def\u5f84\u4e0b examples/internlm2_agent_web_demo_hf.py \u811a\u672c\u6a21\u578b\u52a0\u8f7d\u8def\u5f84</p> <pre><code>model_path = st.sidebar.text_input('\u6a21\u578b\u8def\u5f84\uff1a', value='/root/models/internlm2-chat-7b')\n</code></pre> <p></p> <ul> <li>\u8fd0\u884cstreamlit\u524d\u7aef\u9875\u9762</li> </ul> <pre><code>streamlit run /root/demo/lagent/examples/internlm2_agent_web_demo_hf.py --server.address 127.0.0.1 --server.port 6006\n</code></pre> <p></p> <ul> <li>\u672c\u5730ssh\u8fde\u63a5\u8bbe\u7f6e</li> </ul> <pre><code>ssh -CNg -L 6006:127.0.0.1:6006 root@ssh.intern-ai.org.cn -p 41227\n</code></pre> <p></p> <ul> <li>\u672c\u5730\u8fd0\u884cstreamlit \u524d\u7aef\u9875\u9762</li> </ul> <p>http://127.0.0.1:6006/</p> <ul> <li>\u6ce8\u610f\uff1a\u89c2\u5bdf\u6a21\u578b\u52a0\u8f7d\u8fdb\u5ea6   </li> <li> <p>\u6ce8\u610f\u52fe\u9009\u6570\u636e\u5206\u6790\uff08\u53ef\u89c2\u6d4bAgent\u667a\u80fd\u4f53\u7684\u8c03\u7528\u8fc7\u7a0b\u2014\u2014\u8c03\u7528\u4e86\u4ec0\u4e48\u65b9\u6cd5\u7ec4\u5408\u8fdb\u884c\u89e3\u9898\uff09   </p> </li> <li> <p>\u8ba9\u667a\u80fd\u4f53\u544a\u8bc9\u6211\u4ed6\u7684\u80fd\u529b\u5e76\u6d4b\u9a8c\u80fd\u529b</p> </li> </ul> <p>Q:\u4f60\u4f5c\u4e3aAgent\u667a\u80fd\u4f53\uff0c\u80fd\u7ed9\u6211\u4e00\u4e2a\u793a\u4f8b\u80fd\u4f53\u73b0\u4f60\u80fd\u529b\u5417\uff1f   A:</p>"},{"location":"chapter2/#333","title":"3.3.3 \u6e90\u7801\u89e3\u6790","text":"<pre><code>import copy\nimport hashlib\nimport json\nimport os\n\nimport streamlit as st\n\nfrom lagent.actions import ActionExecutor, ArxivSearch, IPythonInterpreter\nfrom lagent.agents.internlm2_agent import INTERPRETER_CN, META_CN, PLUGIN_CN, Internlm2Agent, Internlm2Protocol\nfrom lagent.llms import HFTransformer\nfrom lagent.llms.meta_template import INTERNLM2_META as META\nfrom lagent.schema import AgentStatusCode\n\n# \u4ecestreamlit.logger\u5bfc\u5165get_logger\u51fd\u6570\uff0c\u4f46\u672a\u4f7f\u7528\n\n\nclass SessionState:\n    def init_state(self):\n        \"\"\"\u521d\u59cb\u5316\u4f1a\u8bdd\u72b6\u6001\u53d8\u91cf.\"\"\"\n        # \u5728st.session_state\u4e2d\u521b\u5efa'assistant'\u548c'user'\u5217\u8868\uff0c\u7528\u4e8e\u5b58\u50a8\u5bf9\u8bdd\u5386\u53f2\u8bb0\u5f55\n        st.session_state['assistant'] = []\n        st.session_state['user'] = []\n\n        # \u521b\u5efa\u52a8\u4f5c\u5217\u8868\uff0c\u5305\u62ecArxivSearch()\n        action_list = [\n            ArxivSearch(),\n        ]\n        # \u5728st.session_state\u4e2d\u521b\u5efa'plugin_map'\u5b57\u5178\uff0c\u5c06\u52a8\u4f5c\u540d\u79f0\u6620\u5c04\u5230\u52a8\u4f5c\u5bf9\u8c61\n        st.session_state['plugin_map'] = {\n            action.name: action\n            for action in action_list\n        }\n        # \u5728st.session_state\u4e2d\u521b\u5efa\u7a7a\u7684'model_map'\u5b57\u5178\uff0c\u7528\u4e8e\u5b58\u50a8\u6a21\u578b\u5bf9\u8c61\n        st.session_state['model_map'] = {}\n        # \u5728st.session_state\u4e2d\u521b\u5efa'model_selected'\u53d8\u91cf\uff0c\u7528\u4e8e\u5b58\u50a8\u5f53\u524d\u9009\u62e9\u7684\u6a21\u578b\u540d\u79f0\n        st.session_state['model_selected'] = None\n        # \u5728st.session_state\u4e2d\u521b\u5efa\u7a7a\u7684'plugin_actions'\u96c6\u5408\uff0c\u7528\u4e8e\u5b58\u50a8\u5f53\u524d\u9009\u62e9\u7684\u63d2\u4ef6\u52a8\u4f5c\n        st.session_state['plugin_actions'] = set()\n        # \u5728st.session_state\u4e2d\u521b\u5efa\u7a7a\u7684'history'\u5217\u8868\uff0c\u7528\u4e8e\u5b58\u50a8\u5bf9\u8bdd\u5386\u53f2\u8bb0\u5f55\n        st.session_state['history'] = []\n\n    def clear_state(self):\n        \"\"\"\u6e05\u9664\u73b0\u6709\u7684\u4f1a\u8bdd\u72b6\u6001.\"\"\"\n        # \u6e05\u7a7a'assistant'\u548c'user'\u5217\u8868\uff0c\u4ee5\u53ca'model_selected'\u53d8\u91cf\u548c'file'\u96c6\u5408\n        st.session_state['assistant'] = []\n        st.session_state['user'] = []\n        st.session_state['model_selected'] = None\n        st.session_state['file'] = set()\n        # \u5982\u679c'chatbot'\u5b58\u5728\u4e8est.session_state\u4e2d\uff0c\u5219\u6e05\u7a7a\u5176\u4f1a\u8bdd\u5386\u53f2\u8bb0\u5f55\n        if 'chatbot' in st.session_state:\n            st.session_state['chatbot']._session_history = []\n\n\nclass StreamlitUI:\n    def __init__(self, session_state: SessionState):\n        # \u521d\u59cb\u5316StreamlitUI\u5bf9\u8c61\uff0c\u5e76\u8bbe\u7f6e\u5176session_state\u5c5e\u6027\u4e3a\u4f20\u5165\u7684SessionState\u5bf9\u8c61\n        self.init_streamlit()\n        self.session_state = session_state\n\n    def init_streamlit(self):\n        \"\"\"\u521d\u59cb\u5316Streamlit\u7684UI\u8bbe\u7f6e.\"\"\"\n        # \u8bbe\u7f6e\u9875\u9762\u914d\u7f6e\uff0c\u5305\u62ec\u5e03\u5c40\u3001\u9875\u9762\u6807\u9898\u548c\u9875\u9762\u56fe\u6807\n        st.set_page_config(\n            layout='wide',\n            page_title='lagent-web',\n            page_icon='./docs/imgs/lagent_icon.png')\n        # \u5728\u9875\u9762\u4e0a\u663e\u793a\u6807\u9898\u548c\u5206\u9694\u7ebf\n        st.header(':robot_face: :blue[Lagent] Web Demo ', divider='rainbow')\n        # \u5728\u4fa7\u8fb9\u680f\u4e0a\u663e\u793a\u6807\u9898\n        st.sidebar.title('\u6a21\u578b\u63a7\u5236')\n        # \u5728st.session_state\u4e2d\u521b\u5efa\u7a7a\u7684'file'\u96c6\u5408\uff0c\u7528\u4e8e\u5b58\u50a8\u4e0a\u4f20\u7684\u6587\u4ef6\n        st.session_state['file'] = set()\n        # \u5728st.session_state\u4e2d\u521b\u5efa'model_path'\u53d8\u91cf\uff0c\u7528\u4e8e\u5b58\u50a8\u6a21\u578b\u8def\u5f84\n        st.session_state['model_path'] = None\n\n    def setup_sidebar(self):\n        \"\"\"\u8bbe\u7f6e\u4fa7\u8fb9\u680f\uff0c\u7528\u4e8e\u6a21\u578b\u548c\u63d2\u4ef6\u9009\u62e9.\"\"\"\n        # \u4ece\u4fa7\u8fb9\u680f\u83b7\u53d6\u6a21\u578b\u540d\u79f0\u8f93\u5165\uff0c\u9ed8\u8ba4\u503c\u4e3a'internlm2-chat-7b'\n        model_name = st.sidebar.text_input('\u6a21\u578b\u540d\u79f0\uff1a', value='internlm2-chat-7b')\n        # \u4ece\u4fa7\u8fb9\u680f\u83b7\u53d6\u7cfb\u7edf\u63d0\u793a\u8bcd\u8f93\u5165\uff0c\u9ed8\u8ba4\u503c\u4e3aMETA_CN\n        meta_prompt = st.sidebar.text_area('\u7cfb\u7edf\u63d0\u793a\u8bcd', value=META_CN)\n        # \u4ece\u4fa7\u8fb9\u680f\u83b7\u53d6\u6570\u636e\u5206\u6790\u63d0\u793a\u8bcd\u8f93\u5165\uff0c\u9ed8\u8ba4\u503c\u4e3aINTERPRETER_CN\n        da_prompt = st.sidebar.text_area('\u6570\u636e\u5206\u6790\u63d0\u793a\u8bcd', value=INTERPRETER_CN)\n        # \u4ece\u4fa7\u8fb9\u680f\u83b7\u53d6\u63d2\u4ef6\u63d0\u793a\u8bcd\u8f93\u5165\uff0c\u9ed8\u8ba4\u503c\u4e3aPLUGIN_CN\n        plugin_prompt = st.sidebar.text_area('\u63d2\u4ef6\u63d0\u793a\u8bcd', value=PLUGIN_CN)\n        # \u4ece\u4fa7\u8fb9\u680f\u83b7\u53d6\u6a21\u578b\u8def\u5f84\u8f93\u5165\uff0c\u9ed8\u8ba4\u503c\u4e3a'/root/models/internlm2-chat-7b'\n        model_path = st.sidebar.text_input(\n            '\u6a21\u578b\u8def\u5f84\uff1a', value='/root/models/internlm2-chat-7b')\n\n        # \u68c0\u67e5\u6a21\u578b\u540d\u79f0\u6216\u6a21\u578b\u8def\u5f84\u662f\u5426\u5df2\u66f4\u6539\uff0c\u5982\u679c\u662f\uff0c\u5219\u521d\u59cb\u5316\u65b0\u6a21\u578b\u5e76\u6e05\u9664\u4f1a\u8bdd\u72b6\u6001\n        if model_name != st.session_state['model_selected'] or st.session_state['model_path'] != model_path:\n            st.session_state['model_path'] = model_path\n            model = self.init_model(model_name, model_path)\n            self.session_state.clear_state()\n            st.session_state['model_selected'] = model_name\n            if 'chatbot' in st.session_state:\n                del st.session_state['chatbot']\n        else:\n            # \u5982\u679c\u6a21\u578b\u672a\u66f4\u6539\uff0c\u5219\u4ecest.session_state\u4e2d\u7684'model_map'\u5b57\u5178\u83b7\u53d6\u73b0\u6709\u6a21\u578b\u5bf9\u8c61\n            model = st.session_state['model_map'][model_name]\n\n        # \u4ece\u4fa7\u8fb9\u680f\u83b7\u53d6\u63d2\u4ef6\u540d\u79f0\u7684\u591a\u9009\u8f93\u5165\uff0c\u9ed8\u8ba4\u503c\u4e3a\u7a7a\u5217\u8868\n        plugin_name = st.sidebar.multiselect(\n            '\u63d2\u4ef6\u9009\u62e9',\n            options=list(st.session_state['plugin_map'].keys()),\n            default=[],\n        )\n        # \u4ece\u4fa7\u8fb9\u680f\u83b7\u53d6\u6570\u636e\u5206\u6790\u7684\u590d\u9009\u6846\u8f93\u5165\uff0c\u9ed8\u8ba4\u503c\u4e3aFalse\n        da_flag = st.sidebar.checkbox(\n            '\u6570\u636e\u5206\u6790',\n            value=False,\n        )\n        # \u4ece\u63d2\u4ef6\u540d\u79f0\u5217\u8868\u4e2d\u83b7\u53d6\u63d2\u4ef6\u52a8\u4f5c\u5217\u8868\n        plugin_action = [\n            st.session_state['plugin_map'][name] for name in plugin_name\n        ]\n\n        # \u5982\u679c'chatbot'\u5b58\u5728\u4e8est.session_state\u4e2d\uff0c\u5219\u6839\u636e\u9009\u62e9\u7684\u63d2\u4ef6\u548c\u6570\u636e\u5206\u6790\u8bbe\u7f6e\u66f4\u65b0\u5176\u5c5e\u6027\n        if 'chatbot' in st.session_state:\n            if len(plugin_action) &gt; 0:\n                # \u5982\u679c\u9009\u62e9\u4e86\u63d2\u4ef6\uff0c\u5219\u521b\u5efaActionExecutor\u5bf9\u8c61\u5e76\u8bbe\u7f6echatbot\u7684_action_executor\u5c5e\u6027\u4e3a\u8be5\u5bf9\u8c61\n                st.session_state['chatbot']._action_executor = ActionExecutor(actions=plugin_action)\n            else:\n                # \u5982\u679c\u6ca1\u6709\u9009\u62e9\u63d2\u4ef6\uff0c\u5219\u5c06chatbot\u7684_action_executor\u5c5e\u6027\u8bbe\u7f6e\u4e3aNone\n                st.session_state['chatbot']._action_executor = None\n            if da_flag:\n                # \u5982\u679c\u9009\u62e9\u4e86\u6570\u636e\u5206\u6790\uff0c\u5219\u521b\u5efaActionExecutor\u5bf9\u8c61\u5e76\u8bbe\u7f6echatbot\u7684_interpreter_executor\u5c5e\u6027\u4e3a\u8be5\u5bf9\u8c61\n                st.session_state['chatbot']._interpreter_executor = ActionExecutor(actions=[IPythonInterpreter()])\n            else:\n                # \u5982\u679c\u6ca1\u6709\u9009\u62e9\u6570\u636e\u5206\u6790\uff0c\u5219\u5c06chatbot\u7684_interpreter_executor\u5c5e\u6027\u8bbe\u7f6e\u4e3aNone\n                st.session_state['chatbot']._interpreter_executor = None\n            # \u66f4\u65b0chatbot\u7684\u63d0\u793a\u8bcd\u5c5e\u6027\u4e3a\u4fa7\u8fb9\u680f\u8f93\u5165\u7684\u503c\n            st.session_state['chatbot']._protocol._meta_template = meta_prompt\n            st.session_state['chatbot']._protocol.plugin_prompt = plugin_prompt\n            st.session_state['chatbot']._protocol.interpreter_prompt = da_prompt\n        if st.sidebar.button('\u6e05\u7a7a\u5bf9\u8bdd', key='clear'):\n            # \u5982\u679c\u70b9\u51fb\u4e86\u4fa7\u8fb9\u680f\u4e0a\u7684\u201c\u6e05\u7a7a\u5bf9\u8bdd\u201d\u6309\u94ae\uff0c\u5219\u8c03\u7528SessionState\u5bf9\u8c61\u7684clear_state\u65b9\u6cd5\u6765\u6e05\u9664\u4f1a\u8bdd\u72b6\u6001\n            self.session_state.clear_state()\n        # \u4ece\u4fa7\u8fb9\u680f\u83b7\u53d6\u6587\u4ef6\u4e0a\u4f20\u5668\u8f93\u5165\uff0c\u7528\u4e8e\u4e0a\u4f20\u6587\u4ef6\u5230\u5e94\u7528\u7a0b\u5e8f\u4e2d\u4f7f\u7528\n        uploaded_file = st.sidebar.file_uploader('\u4e0a\u4f20\u6587\u4ef6')\n        return model_name, model, plugin_action, uploaded_file, model_path\n\n    def init_model(self, model_name, path):\n        \"\"\"\u6839\u636e\u8f93\u5165\u7684\u6a21\u578b\u540d\u79f0\u521d\u59cb\u5316\u6a21\u578b.\"\"\"\n        # \u4f7f\u7528HFTransformer\u7c7b\u521d\u59cb\u5316\u6a21\u578b\u5bf9\u8c61\uff0c\u5e76\u5c06\u6a21\u578b\u8def\u5f84\u548c\u5176\u4ed6\u53c2\u6570\u4f20\u9012\u7ed9\u6784\u9020\u51fd\u6570\u3002\u5c06\u6a21\u578b\u5bf9\u8c61\u5b58\u50a8\u5728st.session_state\u4e2d\u7684'model_map'\u5b57\u5178\u4e2d\u3002\n        st.session_state['model_map'][model_name] = HFTransformer(path=path, meta_template=META, max_new_tokens=1024, top_p=0.8, top_k=None, temperature=0.1, repetition_penalty=1.0, stop_words=['&lt;|im_end|&gt;'])\n        return st.session_state['model_map'][model_name]\n    def initialize_chatbot(self, model, plugin_action):\n    \"\"\"\u4f7f\u7528\u7ed9\u5b9a\u7684\u6a21\u578b\u548c\u63d2\u4ef6\u52a8\u4f5c\u521d\u59cb\u5316\u804a\u5929\u673a\u5668\u4eba.\"\"\"\n    # \u4f7f\u7528Internlm2Agent\u7c7b\u521d\u59cb\u5316\u804a\u5929\u673a\u5668\u4eba\u5bf9\u8c61\uff0c\u5e76\u5c06LLM\uff08\u8bed\u8a00\u6a21\u578b\uff09\u3001\u534f\u8bae\u548c\u6700\u5927\u56de\u5408\u6570\u4f20\u9012\u7ed9\u6784\u9020\u51fd\u6570\u3002\u8fd4\u56de\u804a\u5929\u673a\u5668\u4eba\u5bf9\u8c61\u3002\n    return Internlm2Agent(\n        llm=model,\n        protocol=Internlm2Protocol(\n            tool=dict(\n                begin='{start_token}{name}\\n',\n                start_token='&lt;|action_start|&gt;',\n                name_map=dict(\n                    plugin='&lt;|plugin|&gt;', interpreter='&lt;|interpreter|&gt;'),\n                belong='assistant',\n                end='&lt;|action_end|&gt;\\n',\n            ), ),\n        max_turn=7)\n\ndef render_user(self, prompt: str):\n    # \u4f7f\u7528st.chat_message('user')\u5728\u804a\u5929\u7a97\u53e3\u4e2d\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u7528\u6237\u6d88\u606f\uff0c\u5e76\u4f7f\u7528st.markdown(prompt)\u663e\u793a\u63d0\u793a\u6587\u672c\u3002\n    with st.chat_message('user'):\n        st.markdown(prompt)\n\ndef render_assistant(self, agent_return):\n    # \u4f7f\u7528st.chat_message('assistant')\u5728\u804a\u5929\u7a97\u53e3\u4e2d\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u52a9\u624b\u6d88\u606f\uff0c\u5e76\u8fed\u4ee3agent_return\u4e2d\u7684actions\u3002\u5bf9\u4e8e\u6bcf\u4e2a\u4e0d\u662fFinishAction\u7684\u975e\u7a7a\u52a8\u4f5c\uff0c\u8c03\u7528render_action\u65b9\u6cd5\u6765\u663e\u793a\u5b83\u3002\u6700\u540e\uff0c\u4f7f\u7528st.markdown(agent_return.response)\u663e\u793aagent_return\u7684\u54cd\u5e94\u3002\n    with st.chat_message('assistant'):\n        for action in agent_return.actions:\n            if (action) and (action.type != 'FinishAction'):\n                self.render_action(action)\n        st.markdown(agent_return.response)\n\ndef render_plugin_args(self, action):\n    # \u4ece\u52a8\u4f5c\u4e2d\u83b7\u53d6\u52a8\u4f5c\u540d\u79f0\u548c\u53c2\u6570\uff0c\u5e76\u5c06\u5b83\u4eec\u8f6c\u6362\u4e3aJSON\u683c\u5f0f\u7684\u5b57\u7b26\u4e32\u3002\u4f7f\u7528st.markdown\u663e\u793a\u8be5\u5b57\u7b26\u4e32\u3002\n    action_name = action.type\n    args = action.args\n    import json\n    parameter_dict = dict(name=action_name, parameters=args)\n    parameter_str = '```json\\n' + json.dumps(parameter_dict, indent=4, ensure_ascii=False) + '\\n```'\n    st.markdown(parameter_str)\n\ndef render_interpreter_args(self, action):\n    # \u4f7f\u7528st.info\u663e\u793a\u52a8\u4f5c\u7c7b\u578b\uff0c\u5e76\u4f7f\u7528st.markdown\u663e\u793a\u52a8\u4f5c\u53c2\u6570\u4e2d\u7684\u6587\u672c\u3002\n    st.info(action.type)\n    st.markdown(action.args['text'])\n\ndef render_action(self, action):\n    # \u4f7f\u7528st.markdown\u663e\u793a\u52a8\u4f5c\u7684thought\u5c5e\u6027\u3002\u5982\u679c\u52a8\u4f5c\u7c7b\u578b\u662fIPythonInterpreter\uff0c\u5219\u8c03\u7528render_interpreter_args\u65b9\u6cd5\u6765\u663e\u793a\u53c2\u6570\u3002\u5426\u5219\uff0c\u5982\u679c\u52a8\u4f5c\u7c7b\u578b\u4e0d\u662fFinishAction\uff0c\u5219\u8c03\u7528render_plugin_args\u65b9\u6cd5\u6765\u663e\u793a\u53c2\u6570\u3002\u6700\u540e\uff0c\u8c03\u7528render_action_results\u65b9\u6cd5\u6765\u663e\u793a\u52a8\u4f5c\u7684\u7ed3\u679c\u3002\n    st.markdown(action.thought)\n    if action.type == 'IPythonInterpreter':\n        self.render_interpreter_args(action)\n    elif action.type == 'FinishAction':\n        pass\n    else:\n        self.render_plugin_args(action)\n    self.render_action_results(action)\n\ndef render_action_results(self, action):\n    \"\"\"\u663e\u793a\u52a8\u4f5c\u7684\u7ed3\u679c\uff0c\u5305\u62ec\u6587\u672c\u3001\u56fe\u50cf\u3001\u89c6\u9891\u548c\u97f3\u9891.\"\"\"\n    # \u5982\u679c\u52a8\u4f5c\u7ed3\u679c\u662f\u5b57\u5178\uff0c\u5219\u68c0\u67e5\u5b83\u662f\u5426\u5305\u542b\u6587\u672c\u3001\u56fe\u50cf\u3001\u89c6\u9891\u6216\u97f3\u9891\uff0c\u5e76\u4f7f\u7528\u76f8\u5e94\u7684st\u65b9\u6cd5\u663e\u793a\u5b83\u4eec\u3002\u5982\u679c\u7ed3\u679c\u662f\u5217\u8868\uff0c\u5219\u8fed\u4ee3\u6bcf\u4e2a\u9879\u76ee\uff0c\u5e76\u6839\u636e\u5176\u7c7b\u578b\u663e\u793a\u76f8\u5e94\u7684\u5185\u5bb9\u3002\u5982\u679c\u52a8\u4f5c\u6709\u9519\u8bef\u6d88\u606f\uff0c\u5219\u4f7f\u7528st.error\u663e\u793a\u5b83\u3002\n    if (isinstance(action.result, dict)):\n        if 'text' in action.result:\n            st.markdown('```\\n' + action.result['text'] + '\\n```')\n        if 'image' in action.result:\n            # image_path = action.result['image']\n            for image_path in action.result['image']:\n                image_data = open(image_path, 'rb').read()\n                st.image(image_data, caption='Generated Image')\n        if 'video' in action.result:\n            video_data = action.result['video']\n            video_data = open(video_data, 'rb').read()\n            st.video(video_data)\n        if 'audio' in action.result:\n            audio_data = action.result['audio']\n            audio_data = open(audio_data, 'rb').read()\n            st.audio(audio_data)\n    elif isinstance(action.result, list):\n        for item in action.result:\n            if item['type'] == 'text':\n                st.markdown('```\\n' + item['content'] + '\\n```')\n            elif item['type'] == 'image':\n                image_data = open(item['content'], 'rb').read()\n                st.image(image_data, caption='Generated Image')\n            elif item['type'] == 'video':\n                video_data = open(item['content'], 'rb').read()\n                st.video(video_data)\n            elif item['type'] == 'audio':\n                audio_data = open(item['content'], 'rb').read()\n                st.audio(audio_data)\n    if action.errmsg:\n        st.error(action.errmsg)\ndef main():\n    # \u5982\u679c'ui'\u4e0d\u5728st.session_state\u4e2d\uff0c\u5219\u521d\u59cb\u5316SessionState\u5bf9\u8c61\u548cStreamlitUI\u5bf9\u8c61\uff0c\u5e76\u5c06\u5b83\u4eec\u5b58\u50a8\u5728st.session_state\u4e2d\u3002\u5426\u5219\uff0c\u8bbe\u7f6e\u9875\u9762\u914d\u7f6e\u5e76\u663e\u793a\u6807\u9898\u548c\u5206\u9694\u7ebf\u3002\u7136\u540e\uff0c\u8c03\u7528StreamlitUI\u5bf9\u8c61\u7684setup_sidebar\u65b9\u6cd5\u6765\u8bbe\u7f6e\u4fa7\u8fb9\u680f\u3002\u63a5\u4e0b\u6765\uff0c\u68c0\u67e5'chatbot'\u662f\u5426\u5b58\u5728\u4e8est.session_state\u4e2d\uff0c\u6216\u8005\u6a21\u578b\u662f\u5426\u5df2\u66f4\u6539\u3002\u5982\u679c\u662f\uff0c\u5219\u8c03\u7528initialize_chatbot\u65b9\u6cd5\u6765\u521d\u59cb\u5316\u804a\u5929\u673a\u5668\u4eba\uff0c\u5e76\u5c06\u4f1a\u8bdd\u5386\u53f2\u8bb0\u5f55\u8bbe\u7f6e\u4e3a\u7a7a\u5217\u8868\u3002\u6700\u540e\uff0c\u8fed\u4ee3\u4f1a\u8bdd\u72b6\u6001\u4e2d\u7684\u7528\u6237\u63d0\u793a\u548c\u4ee3\u7406\u8fd4\u56de\uff0c\u5e76\u8c03\u7528\u76f8\u5e94\u7684render\u65b9\u6cd5\u6765\u663e\u793a\u5b83\u4eec\u3002\u7531\u4e8e\u4ee3\u7801\u7247\u6bb5\u4e0d\u5b8c\u6574\uff0c\u65e0\u6cd5\u63d0\u4f9b\u5b8c\u6574\u7684main\u51fd\u6570\u6ce8\u91ca\u3002\u8bf7\u6ce8\u610f\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u63d0\u4f9b\u7f3a\u5c11\u7684\u4ee3\u7801\u548c\u53d8\u91cf\u4ee5\u4f7fmain\u51fd\u6570\u6b63\u5e38\u5de5\u4f5c\u3002\n    if 'ui' not in st.session_state:\n        session_state = SessionState()\n        session_state.init_state()\n        st.session_state['ui'] = StreamlitUI(session_state)\n    else:\n        st.set_page_config(layout='wide', page_title='lagent-web', page_icon='./docs/imgs/lagent_icon.png')\n        st.header(':robot_face: :blue[Lagent] Web Demo ', divider='rainbow')\n    _, model, plugin_action, uploaded_file, _ = st.session_state['ui'].setup_sidebar()\n    if 'chatbot' not in st.session_state or model != st.session_state['chatbot']._llm:\n        st.session_state['chatbot'] = st.session_state['ui'].initialize_chatbot(model, plugin_action)\n        st.session_state['session_history'] = []\n    for prompt, agent_return in zip(st.session_state['user'], st.session_state['assistant']): # \u5047\u8bbe\u8fd9\u4e9b\u53d8\u91cf\u5b58\u5728\u4e8e\u4f1a\u8bdd\u72b6\u6001\u4e2d\u5e76\u5305\u542b\u9002\u5f53\u7684\u503c\u3002\u60a8\u53ef\u80fd\u9700\u8981\u6839\u636e\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u903b\u8f91\u8fdb\u884c\u8c03\u6574\u3002\n        st.session_state['ui'].render_user(prompt) # \u663e\u793a\u7528\u6237\u63d0\u793a\u3002\u60a8\u53ef\u80fd\u9700\u8981\u6839\u636e\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u903b\u8f91\u8fdb\u884c\u8c03\u6574\u3002\n        st.session_state['ui'].render_assistant(agent_return) # \u663e\u793a\u4ee3\u7406\u8fd4\u56de\u3002\u60a8\u53ef\u80fd\u9700\u8981\u6839\u636e\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u903b\u8f91\u8fdb\u884c\u8c03\u6574\n</code></pre>"},{"location":"chapter2/#34-xomposer-2","title":"3.4 \u591a\u6a21\u6001Xomposer \uff08\u7075\u7b14\u00b72\uff09","text":""},{"location":"chapter2/#341","title":"3.4.1 \u524d\u7f6e\u77e5\u8bc6","text":"<p>Xomposer\u5730\u5740</p> <p>\u8bba\u6587\u5730\u5740</p> <p>\u8bba\u6587pdf</p> <p>\u6d66\u8bed\u00b7\u7075\u7b142\u662f\u57fa\u4e8e\u4e66\u751f\u00b7\u6d66\u8bed2\u5927\u8bed\u8a00\u6a21\u578b\u7814\u53d1\u7684\u7a81\u7834\u6027\u7684\u56fe\u6587\u591a\u6a21\u6001\u5927\u6a21\u578b\uff0c\u5177\u6709\u975e\u51e1\u7684\u56fe\u6587\u5199\u4f5c\u548c\u56fe\u50cf\u7406\u89e3\u80fd\u529b\uff0c\u5728\u591a\u79cd\u5e94\u7528\u573a\u666f\u8868\u73b0\u51fa\u8272\uff1a - \u81ea\u7531\u6307\u4ee4\u8f93\u5165\u7684\u56fe\u6587\u5199\u4f5c\uff1a \u6d66\u8bed\u00b7\u7075\u7b142\u53ef\u4ee5\u7406\u89e3\u81ea\u7531\u5f62\u5f0f\u7684\u56fe\u6587\u6307\u4ee4\u8f93\u5165\uff0c\u5305\u62ec\u5927\u7eb2\u3001\u6587\u7ae0\u7ec6\u8282\u8981\u6c42\u3001\u53c2\u8003\u56fe\u7247\u7b49\uff0c\u4e3a\u7528\u6237\u6253\u9020\u56fe\u6587\u5e76\u8c8c\u7684\u4e13\u5c5e\u6587\u7ae0\u3002\u751f\u6210\u7684\u6587\u7ae0\u6587\u91c7\u6590\u7136\uff0c\u56fe\u6587\u76f8\u5f97\u76ca\u5f70\uff0c\u63d0\u4f9b\u6c89\u6d78\u5f0f\u7684\u9605\u8bfb\u4f53\u9a8c\u3002 - \u51c6\u786e\u7684\u56fe\u6587\u95ee\u9898\u89e3\u7b54\uff1a \u6d66\u8bed\u00b7\u7075\u7b142\u5177\u6709\u6d77\u91cf\u56fe\u6587\u77e5\u8bc6\uff0c\u53ef\u4ee5\u51c6\u786e\u7684\u56de\u590d\u5404\u79cd\u56fe\u6587\u95ee\u7b54\u96be\u9898\uff0c\u5728\u8bc6\u522b\u3001\u611f\u77e5\u3001\u7ec6\u8282\u63cf\u8ff0\u3001\u89c6\u89c9\u63a8\u7406\u7b49\u80fd\u529b\u4e0a\u8868\u73b0\u60ca\u4eba\u3002 - \u6770\u51fa\u6027\u80fd\uff1a \u6d66\u8bed\u00b7\u7075\u7b142\u57fa\u4e8e\u4e66\u751f\u00b7\u6d66\u8bed2-7B\u6a21\u578b\uff0c\u6211\u4eec\u572813\u9879\u591a\u6a21\u6001\u8bc4\u6d4b\u4e2d\u5927\u5e45\u9886\u5148\u540c\u91cf\u7ea7\u591a\u6a21\u6001\u6a21\u578b\uff0c\u5728\u5176\u4e2d6\u9879\u8bc4\u6d4b\u4e2d\u8d85\u8fc7 GPT-4V \u548c Gemini Pro\u3002</p> <ul> <li>\u6a21\u578b\u5408\u96c6</li> </ul> \u6a21\u578b \u7528\u9014 Transformers(HF) ModelScope(HF) \u5f00\u6e90\u65e5\u671f InternLM-XComposer2 \u56fe\u6587\u521b\u4f5c \ud83e\udd17internlm-xcomposer2-7b  internlm-xcomposer2-7b 2024-01-26 InternLM-XComposer2-VL Benchmark, \u89c6\u89c9\u95ee\u7b54 \ud83e\udd17internlm-xcomposer2-vl-7b  internlm-xcomposer2-vl-7b 2024-01-26 InternLM-XComposer2-4bit \u56fe\u6587\u521b\u4f5c \ud83e\udd17internlm-xcomposer2-7b-4bit  internlm-xcomposer2-7b-4bit 2024-02-06 InternLM-XComposer2-VL-4bit Benchmark, \u89c6\u89c9\u95ee\u7b54 \ud83e\udd17internlm-xcomposer2-vl-7b-4bit  internlm-xcomposer2-vl-7b-4bit 2024-02-06 InternLM-XComposer \u56fe\u6587\u521b\u4f5c, \u89c6\u89c9\u95ee\u7b54 \ud83e\udd17internlm-xcomposer-7b  internlm-xcomposer-7b 2023-09-26 InternLM-XComposer-4bit \u56fe\u6587\u521b\u4f5c, \u89c6\u89c9\u95ee\u7b54 \ud83e\udd17internlm-xcomposer-7b-4bit  internlm-xcomposer-7b-4bit 2023-09-26 InternLM-XComposer-VL Benchmark \ud83e\udd17internlm-xcomposer-vl-7b  internlm-xcomposer-vl-7b 2023-09-26"},{"location":"chapter2/#342","title":"3.4.2 \u5b9e\u73b0\u8fc7\u7a0b","text":""},{"location":"chapter2/#3421","title":"3.4.2.1\u521b\u5efa\u5f00\u53d1\u673a\u8d44\u6e90","text":"<p>\u5f00\u542f 50% A100  </p>"},{"location":"chapter2/#3422conda","title":"3.4.2.2\u8fdb\u5165conda\u73af\u5883\u8865\u5145\u4f9d\u8d56\u5305","text":"<p><pre><code>conda activate demo\n# \u8865\u5145\u73af\u5883\u5305\npip install timm==0.4.12 sentencepiece==0.1.99 markdown2==2.4.10 xlsxwriter==3.1.2 gradio==4.13.0 modelscope==1.9.5\n</code></pre> </p>"},{"location":"chapter2/#3423","title":"3.4.2.3\u4e0b\u8f7d\u6e90\u7801","text":"<p><pre><code>cd /root/demo\ngit clone https://gitee.com/internlm/InternLM-XComposer.git\n# git clone https://github.com/internlm/InternLM-XComposer.git\ncd /root/demo/InternLM-XComposer\ngit checkout f31220eddca2cf6246ee2ddf8e375a40457ff626\n</code></pre> </p>"},{"location":"chapter2/#3424","title":"3.4.2.4\u521b\u5efa\u8f6f\u94fe\u63a5\uff08\u6a21\u578b\uff09","text":"<p>\u901a\u8fc7\u521b\u5efa\u8fd9\u4e9b\u7b26\u53f7\u94fe\u63a5\uff0c\u53ef\u4ee5\u5728/root/models\u76ee\u5f55\u4e0b\u8bbf\u95ee\u5230\u539f\u59cb\u6587\u4ef6\u6216\u76ee\u5f55\u7684\u5185\u5bb9\uff0c\u800c\u65e0\u9700\u76f4\u63a5\u5728/root/models\u76ee\u5f55\u4e0b\u590d\u5236\u8fd9\u4e9b\u6587\u4ef6\u6216\u76ee\u5f55\u7684\u526f\u672c\u3002\u8fd9\u6837\u53ef\u4ee5\u8282\u7701\u78c1\u76d8\u7a7a\u95f4\uff0c\u5e76\u4e14\u5bf9\u4e8e\u9700\u8981\u5728\u591a\u4e2a\u4f4d\u7f6e\u8bbf\u95ee\u76f8\u540c\u6587\u4ef6\u6216\u76ee\u5f55\u7684\u60c5\u51b5\u975e\u5e38\u6709\u7528\u3002</p> <pre><code>ln -s /root/share/new_models/Shanghai_AI_Laboratory/internlm-xcomposer2-7b /root/models/internlm-xcomposer2-7b\nln -s /root/share/new_models/Shanghai_AI_Laboratory/internlm-xcomposer2-vl-7b /root/models/internlm-xcomposer2-vl-7b\n</code></pre>"},{"location":"chapter2/#3425xcomposer","title":"3.4.2.5\u542f\u52a8Xcomposer\u56fe\u6587\u5199\u4f5c","text":"<p><pre><code>cd /root/demo/InternLM-XComposer\npython /root/demo/InternLM-XComposer/examples/gradio_demo_composition.py  --code_path /root/models/internlm-xcomposer2-7b --private --num_gpus 1 --port 6006\n</code></pre> </p> <p></p>"},{"location":"chapter2/#3426","title":"3.4.2.6\u672c\u5730\u8fde\u63a5","text":"<pre><code># \u4ece\u672c\u5730\u4f7f\u7528 ssh \u8fde\u63a5 studio \u7aef\u53e3\n# \u5c06\u4e0b\u65b9\u7aef\u53e3\u53f7 38374 \u66ff\u6362\u6210\u81ea\u5df1\u7684\u7aef\u53e3\u53f7\nssh -CNg -L 6006:127.0.0.1:6006 root@ssh.intern-ai.org.cn -p 38374\n</code></pre> <ul> <li>\u672c\u5730\u6253\u5f00\u94fe\u63a5</li> </ul> <p>http://127.0.0.1:6006/</p> <p></p> <ul> <li>\u8fd0\u884c\u63d0\u4ea4</li> </ul> <p></p> <p></p> <ul> <li>\u9ed8\u8ba4\u8bbe\u7f6e</li> <li>\u63d0\u793a\u8bcd     &gt;\u6839\u636e\u4ee5\u4e0b\u6807\u9898\uff1a\u201c\u4e2d\u56fd\u6c34\u58a8\u753b\uff1a\u6d41\u52a8\u7684\u8bd7\u610f\u4e0e\u4e1c\u65b9\u7f8e\u5b66\u201d\uff0c\u521b\u4f5c\u957f\u6587\u7ae0\uff0c\u5b57\u6570\u4e0d\u5c11\u4e8e800\u5b57\u3002\u8bf7\u7ed3\u5408\u4ee5\u4e0b\u6587\u672c\u7d20\u6750\uff1a\u201c\u6c34\u58a8\u753b\u662f\u7531\u6c34\u548c\u58a8\u8c03\u914d\u6210\u4e0d\u540c\u6df1\u6d45\u7684\u58a8\u8272\u6240\u753b\u51fa\u7684\u753b\uff0c\u662f\u7ed8\u753b\u7684\u4e00\u79cd\u5f62\u5f0f\uff0c\u66f4\u591a\u65f6\u5019\uff0c\u6c34\u58a8\u753b\u88ab\u89c6\u4e3a\u4e2d\u56fd\u4f20\u7edf\u7ed8\u753b\uff0c\u4e5f\u5c31\u662f\u56fd\u753b\u7684\u4ee3\u8868\u3002\u4e5f\u79f0\u56fd\u753b\uff0c\u4e2d\u56fd\u753b\u3002\u58a8\u6c34\u753b\u662f\u4e2d\u56fd\u4f20\u7edf\u753b\u4e4b\u4e00\u3002\u58a8\u6c34\u662f\u56fd\u753b\u7684\u8d77\u6e90\uff0c\u4ee5\u7b14\u58a8\u8fd0\u7528\u7684\u6280\u6cd5\u57fa\u7840\u753b\u6210\u58a8\u6c34\u753b\u3002\u7ebf\u6761\u4e2d\u950b\u7b14\uff0c\u4fa7\u950b\u7b14\uff0c\u987a\u950b\u548c\u9006\u950b\uff0c\u70b9\u67d3\uff0c\u64e6\uff0c\u7834\u58a8\uff0c\u62e8\u58a8\u7684\u6280\u6cd5\u3002\u58a8\u4e8e\u6c34\u7684\u53d8\u5316\u5206\u4e3a\u4e94\u8272\u3002\u753b\u6210\u4f5c\u54c1\uff0c\u9898\u6b3e\uff0c\u76d6\u7ae0\u3002\u5c31\u662f\u5b8c\u6574\u7684\u58a8\u6c34\u753b\u4f5c\u54c1\u3002\u57fa\u672c\u7684\u6c34\u58a8\u753b\uff0c\u4ec5\u6709\u6c34\u4e0e\u58a8\uff0c\u9ed1\u4e0e\u767d\u8272\uff0c\u4f46\u8fdb\u9636\u7684\u6c34\u58a8\u753b\uff0c\u4e5f\u6709\u5de5\u7b14\u82b1\u9e1f\u753b\uff0c\u8272\u5f69\u7f24\u7eb7\u3002\u540e\u8005\u6709\u65f6\u4e5f\u79f0\u4e3a\u5f69\u58a8\u753b\u3002\u5728\u4e2d\u56fd\u753b\u4e2d\uff0c\u4ee5\u4e2d\u56fd\u753b\u7279\u6709\u7684\u6750\u6599\u4e4b\u4e00\uff0c\u58a8\u4e3a\u4e3b\u8981\u539f\u6599\u52a0\u4ee5\u6e05\u6c34\u7684\u591a\u5c11\u5f15\u4e3a\u6d53\u58a8\u3001\u6de1\u58a8\u3001\u5e72\u58a8\u3001\u6e7f\u58a8\u3001\u7126\u58a8\u7b49\uff0c\u753b\u51fa\u4e0d\u540c\u6d53\u6de1\uff08\u9ed1\u3001\u767d\u3001\u7070\uff09\u5c42\u6b21\u3002\u522b\u6709\u4e00\u756a\u97f5\u5473\u79f0\u4e3a\u201c\u58a8\u97f5\u201d\u3002\u800c\u5f62\u6210\u6c34\u58a8\u4e3a\u4e3b\u7684\u4e00\u79cd\u7ed8\u753b\u5f62\u5f0f\u3002\u201d</li> <li>\u63d2\u56fe\u6570\u91cf 6</li> <li>\u968f\u673a\u79cd\u5b50</li> <li>\u8f93\u51fa\u7ed3\u679c <p>\u6839\u636e\u4ee5\u4e0b\u6807\u9898\uff1a\u201c\u4e2d\u56fd\u6c34\u58a8\u753b\uff1a\u6d41\u52a8\u7684\u8bd7\u610f\u4e0e\u4e1c\u65b9\u7f8e\u5b66\u201d\uff0c\u521b\u4f5c\u957f\u6587\u7ae0\uff0c\u5b57\u6570\u4e0d\u5c11\u4e8e800\u5b57\u3002\u8bf7\u7ed3\u5408\u4ee5\u4e0b\u6587\u672c\u7d20\u6750\uff1a\u201c\u6c34\u58a8\u753b\u662f\u7531\u6c34\u548c\u58a8\u8c03\u914d\u6210\u4e0d\u540c\u6df1\u6d45\u7684\u58a8\u8272\u6240\u753b\u51fa\u7684\u753b\uff0c\u662f\u7ed8\u753b\u7684\u4e00\u79cd\u5f62\u5f0f\uff0c\u66f4\u591a\u65f6\u5019\uff0c\u6c34\u58a8\u753b\u88ab\u89c6\u4e3a\u4e2d\u56fd\u4f20\u7edf\u7ed8\u753b\uff0c\u4e5f\u5c31\u662f\u56fd\u753b\u7684\u4ee3\u8868\u3002\u4e5f\u79f0\u56fd\u753b\uff0c\u4e2d\u56fd\u753b\u3002\u58a8\u6c34\u753b\u662f\u4e2d\u56fd\u4f20\u7edf\u753b\u4e4b\u4e00\u3002\u58a8\u6c34\u662f\u56fd\u753b\u7684\u8d77\u6e90\uff0c\u4ee5\u7b14\u58a8\u8fd0\u7528\u7684\u6280\u6cd5\u57fa\u7840\u753b\u6210\u58a8\u6c34\u753b\u3002\u7ebf\u6761\u4e2d\u950b\u7b14\uff0c\u4fa7\u950b\u7b14\uff0c\u987a\u950b\u548c\u9006\u950b\uff0c\u70b9\u67d3\uff0c\u64e6\uff0c\u7834\u58a8\uff0c\u62e8\u58a8\u7684\u6280\u6cd5\u3002\u58a8\u4e8e\u6c34\u7684\u53d8\u5316\u5206\u4e3a\u4e94\u8272\u3002\u753b\u6210\u4f5c\u54c1\uff0c\u9898\u6b3e\uff0c\u76d6\u7ae0\u3002\u5c31\u662f\u5b8c\u6574\u7684\u58a8\u6c34\u753b\u4f5c\u54c1\u3002\u57fa\u672c\u7684\u6c34\u58a8\u753b\uff0c\u4ec5\u6709\u6c34\u4e0e\u58a8\uff0c\u9ed1\u4e0e\u767d\u8272\uff0c\u4f46\u8fdb\u9636\u7684\u6c34\u58a8\u753b\uff0c\u4e5f\u6709\u5de5\u7b14\u82b1\u9e1f\u753b\uff0c\u8272\u5f69\u7f24\u7eb7\u3002\u540e\u8005\u6709\u65f6\u4e5f\u79f0\u4e3a\u5f69\u58a8\u753b\u3002\u5728\u4e2d\u56fd\u753b\u4e2d\uff0c\u4ee5\u4e2d\u56fd\u753b\u7279\u6709\u7684\u6750\u6599\u4e4b\u4e00\uff0c\u58a8\u4e3a\u4e3b\u8981\u539f\u6599\u52a0\u4ee5\u6e05\u6c34\u7684\u591a\u5c11\u5f15\u4e3a\u6d53\u58a8\u3001\u6de1\u58a8\u3001\u5e72\u58a8\u3001\u6e7f\u58a8\u3001\u7126\u58a8\u7b49\uff0c\u753b\u51fa\u4e0d\u540c\u6d53\u6de1\uff08\u9ed1\u3001\u767d\u3001\u7070\uff09\u5c42\u6b21\u3002\u522b\u6709\u4e00\u756a\u97f5\u5473\u79f0\u4e3a\u201c\u58a8\u97f5\u201d\u3002\u800c\u5f62\u6210\u6c34\u58a8\u4e3a\u4e3b\u7684\u4e00\u79cd\u7ed8\u753b\u5f62\u5f0f\u3002\u201d   1   1.005   4096   True   8909</p> </li> </ul> <p>\u4e2d\u56fd\u6c34\u58a8\u753b\uff1a\u6d41\u52a8\u7684\u8bd7\u610f\u4e0e\u4e1c\u65b9\u7f8e\u5b66\u4e2d\u56fd\u7684\u4f20\u7edf\u7ed8\u753b\uff0c\u7279\u522b\u662f\u6c34\u58a8\u753b\uff0c\u88ab\u8a89\u4e3a\u201c\u58a8\u97f5\u4e4b\u821e\u201d\uff0c\u4ee5\u7b14\u58a8\u6325\u6d12\u3001\u7ebf\u6761\u4ea4\u7ec7\u7684\u5f62\u5f0f\uff0c\u5c55\u73b0\u4e86\u4e2d\u56fd\u7279\u6709\u7684\u5ba1\u7f8e\u60c5\u8da3\u548c\u6587\u5316\u5185\u6db5\u3002\u6c34\u58a8\u753b\u662f\u4e00\u79cd\u72ec\u7279\u7684\u827a\u672f\u5f62\u5f0f\uff0c\u5b83\u4e0d\u4ec5\u4f53\u73b0\u4e86\u4e2d\u56fd\u4f20\u7edf\u6587\u5316\u7684\u7cbe\u9ad3\uff0c\u4e5f\u5f70\u663e\u4e86\u4e1c\u65b9\u7684\u7f8e\u5b66\u89c2\u5ff5\u548c\u54f2\u5b66\u601d\u60f3\u3002\u5728\u8fd9\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u5c06\u6df1\u5165\u63a2\u8ba8\u6c34\u58a8\u753b\u7684\u827a\u672f\u7279\u70b9\uff0c\u53ca\u5176\u5728\u4e2d\u56fd\u6587\u5316\u4e2d\u7684\u91cd\u8981\u5730\u4f4d\u3002      \u8d77\u6e90\u4e0e\u53d1\u5c55\u6c34\u58a8\u753b\u7684\u5386\u53f2\u53ef\u4ee5\u8ffd\u6eaf\u5230\u4e2d\u56fd\u53e4\u4ee3\u7684\u6218\u56fd\u65f6\u671f\uff08\u516c\u5143\u524d475\u5e74\u2014\u516c\u5143\u524d221\u5e74\uff09\u3002\u5f53\u65f6\u7684\u7ed8\u753b\u4e3b\u8981\u662f\u7528\u6bdb\u7b14\u5728\u7ee2\u6216\u7eb8\u4e0a\u7ed8\u5236\uff0c\u800c\u989c\u6599\u5219\u662f\u4ece\u77ff\u7269\u3001\u690d\u7269\u548c\u52a8\u7269\u4e2d\u63d0\u53d6\u3002\u968f\u7740\u65f6\u4ee3\u7684\u53d1\u5c55\uff0c\u7ed8\u753b\u6280\u6cd5\u4e0d\u65ad\u4e30\u5bcc\uff0c\u5176\u4e2d\u6700\u91cd\u8981\u7684\u8d21\u732e\u4e4b\u4e00\u5c31\u662f\u58a8\u7684\u53d1\u73b0\u548c\u4f7f\u7528\u3002\u636e\u4f20\uff0c\u79e6\u59cb\u7687\u7edf\u4e00\u516d\u56fd\u540e\uff0c\u4e0b\u4ee4\u70e7\u6bc1\u4e66\u7c4d\uff0c\u4f46\u4e00\u4f4d\u4e66\u751f\u85cf\u8d77\u4e86\u4e00\u672c\u73cd\u8d35\u7684\u53e4\u4e66\u3002\u8fd9\u672c\u53e4\u4e66\u540e\u6765\u88ab\u65e0\u610f\u4e2d\u4e22\u5f03\uff0c\u843d\u5165\u6c34\u4e2d\u88ab\u6ce1\u6e7f\u3002\u5f53\u4e66\u751f\u635e\u8d77\u4e66\u9875\u65f6\uff0c\u610f\u5916\u5730\u53d1\u73b0\u4e0a\u9762\u7684\u6587\u5b57\u5e76\u672a\u88ab\u6c34\u7834\u574f\uff0c\u53cd\u800c\u66f4\u52a0\u6e05\u6670\u4e86\u3002\u8fd9\u4e2a\u6545\u4e8b\u544a\u8bc9\u6211\u4eec\uff0c\u6c34\u4e0e\u58a8\u7684\u642d\u914d\u662f\u521b\u9020\u5947\u8ff9\u7684\u5173\u952e\u3002\u4ece\u6b64\u4ee5\u540e\uff0c\u4e2d\u56fd\u4eba\u5f00\u59cb\u5c06\u6c34\u548c\u58a8\u7ed3\u5408\u8d77\u6765\u521b\u4f5c\u51fa\u5177\u6709\u72ec\u7279\u97f5\u5473\u7684\u753b\u4f5c\u3002      \u6838\u5fc3\u5143\u7d20\u6c34\u58a8\u753b\u7684\u6838\u5fc3\u5143\u7d20\u5305\u62ec\u7b14\u6cd5\u3001\u58a8\u8272\u548c\u6784\u56fe\u3002\u9996\u5148\uff0c\u7b14\u6cd5\u5728\u6c34\u58a8\u753b\u4e2d\u81f3\u5173\u91cd\u8981\u3002\u4e0d\u540c\u7684\u7b14\u89e6\u548c\u7b14\u529b\u80fd\u591f\u4ea7\u751f\u4e30\u5bcc\u7684\u89c6\u89c9\u6548\u679c\uff0c\u5982\u7c97\u72b7\u8c6a\u653e\u7684\u76b4\u64e6\uff0c\u7ec6\u817b\u67d4\u7f8e\u7684\u70b9\u67d3\u7b49\u3002\u5176\u6b21\uff0c\u58a8\u8272\u7684\u8fd0\u7528\u4e5f\u662f\u6c34\u58a8\u753b\u7684\u7cbe\u9ad3\u6240\u5728\u3002\u901a\u8fc7\u8c03\u8282\u6c34\u7684\u591a\u5c11\uff0c\u53ef\u4ee5\u4ea7\u751f\u6d53\u6de1\u5e72\u6e7f\u7684\u53d8\u5316\uff0c\u521b\u9020\u51fa\u6df1\u9083\u795e\u79d8\u7684\u6c1b\u56f4\u3002\u6700\u540e\uff0c\u6784\u56fe\u5219\u51b3\u5b9a\u4e86\u753b\u9762\u7684\u6574\u4f53\u5e03\u5c40\u548c\u610f\u5883\u8868\u8fbe\u3002\u5408\u7406\u7684\u6784\u56fe\u80fd\u591f\u5f15\u5bfc\u89c2\u8005\u7684\u89c6\u7ebf\u6d41\u52a8\uff0c\u589e\u5f3a\u753b\u9762\u7684\u827a\u672f\u611f\u67d3\u529b\u3002      \u6280\u6cd5\u4e0e\u8868\u73b0\u529b\u6c34\u58a8\u753b\u7684\u6280\u6cd5\u975e\u5e38\u591a\u6837\u5316\uff0c\u5e38\u89c1\u7684\u6709\u6cfc\u58a8\u3001\u7834\u58a8\u3001\u79ef\u58a8\u3001\u5bbf\u58a8\u3001\u67af\u58a8\u7b49\u3002\u8fd9\u4e9b\u6280\u6cd5\u5404\u6709\u7279\u8272\uff0c\u80fd\u591f\u4ea7\u751f\u4e0d\u540c\u7684\u6548\u679c\u3002\u4f8b\u5982\uff0c\u6cfc\u58a8\u9002\u7528\u4e8e\u8868\u73b0\u5c71\u5ce6\u8d77\u4f0f\u7684\u5927\u6c14\u78c5\u7934\uff1b\u7834\u58a8\u5219\u9002\u5408\u63cf\u7ed8\u6811\u6728\u679d\u53f6\u7684\u7e41\u8302\u7eb7\u6742\uff1b\u79ef\u58a8\u5219\u591a\u7528\u4e8e\u8425\u9020\u539a\u91cd\u6df1\u9083\u7684\u5c71\u6c34\u6c14\u6c1b\u3002\u6b64\u5916\uff0c\u6c34\u58a8\u753b\u8fd8\u5e38\u5e38\u7ed3\u5408\u8bd7\u8bcd\u6b4c\u8d4b\uff0c\u5f62\u6210\u4e00\u79cd\u8bd7\u60c5\u753b\u610f\u7684\u5883\u754c\u3002\u8fd9\u79cd\u878d\u5408\u4e0d\u4ec5\u63d0\u5347\u4e86\u753b\u4f5c\u7684\u610f\u5883\uff0c\u4e5f\u8ba9\u6b23\u8d4f\u8005\u80fd\u591f\u66f4\u597d\u5730\u9886\u7565\u5230\u5176\u4e2d\u7684\u6587\u5316\u5185\u6db5\u3002      \u4ef7\u503c\u4e0e\u610f\u4e49\u6c34\u58a8\u753b\u4f5c\u4e3a\u4e2d\u56fd\u4f20\u7edf\u6587\u5316\u7684\u7470\u5b9d\uff0c\u4e0d\u4ec5\u662f\u4e2d\u56fd\u827a\u672f\u7684\u4ee3\u8868\uff0c\u66f4\u662f\u4e16\u754c\u6587\u5316\u827a\u672f\u5b9d\u5e93\u4e2d\u7684\u4e00\u9897\u7480\u74a8\u660e\u73e0\u3002\u5b83\u7684\u4ef7\u503c\u4e0d\u4ec5\u4ec5\u5728\u4e8e\u5176\u72ec\u7279\u7684\u827a\u672f\u98ce\u683c\u548c\u6280\u672f\u624b\u6bb5\uff0c\u66f4\u5728\u4e8e\u5176\u6240\u627f\u8f7d\u7684\u6df1\u539a\u6587\u5316\u5e95\u8574\u548c\u7cbe\u795e\u5185\u6db5\u3002\u901a\u8fc7\u6b23\u8d4f\u6c34\u58a8\u753b\uff0c\u4eba\u4eec\u4e0d\u4ec5\u53ef\u4ee5\u611f\u53d7\u5230\u827a\u672f\u5bb6\u5bf9\u81ea\u7136\u7684\u611f\u609f\u548c\u5bf9\u751f\u547d\u7684\u601d\u8003\uff0c\u4e5f\u80fd\u591f\u9886\u609f\u5230\u4e2d\u56fd\u54f2\u5b66\u7684\u667a\u6167\u548c\u9053\u5fb7\u51c6\u5219\u3002\u56e0\u6b64\uff0c\u4fdd\u62a4\u548c\u4f20\u627f\u6c34\u58a8\u753b\u8fd9\u4e00\u5b9d\u8d35\u7684\u6587\u5316\u9057\u4ea7\u663e\u5f97\u5c24\u4e3a\u91cd\u8981\u3002      \u7ed3\u8bed\u7efc\u4e0a\u6240\u8ff0\uff0c\u6c34\u58a8\u753b\u4f5c\u4e3a\u4e00\u95e8\u53e4\u8001\u7684\u827a\u672f\u5f62\u5f0f\uff0c\u4e0d\u4ec5\u5177\u6709\u72ec\u7279\u7684\u5ba1\u7f8e\u4ef7\u503c\uff0c\u66f4\u662f\u4e2d\u56fd\u4f20\u7edf\u6587\u5316\u7684\u91cd\u8981\u7ec4\u6210\u90e8\u5206\u3002\u5b83\u7684\u9b45\u529b\u4e0d\u4ec5\u4f53\u73b0\u5728\u6280\u827a\u7684\u9ad8\u8d85\u4e0a\uff0c\u66f4\u5728\u4e8e\u5176\u80cc\u540e\u6240\u8574\u542b\u7684\u6df1\u523b\u601d\u60f3\u548c\u6587\u5316\u5185\u6db5\u3002\u8ba9\u6211\u4eec\u5171\u540c\u52aa\u529b\uff0c\u8ba9\u8fd9\u95e8\u53e4\u8001\u800c\u53c8\u9c9c\u6d3b\u7684\u827a\u672f\u5f62\u5f0f\u5f97\u4ee5\u4f20\u627f\u5e76\u53d1\u626c\u5149\u5927\u3002   </p>"},{"location":"chapter2/#3427-xcomposer","title":"3.4.2.7 \u542f\u52a8Xcomposer\u56fe\u7247\u7406\u89e3","text":"<ul> <li> <p>\u5173\u95ed\u5e76\u91cd\u542f\u4e00\u4e2a\u547d\u4ee4\u6846   </p> </li> <li> <p>\u8f93\u5165\u542f\u52a8\u547d\u4ee4</p> </li> </ul> <pre><code>conda activate demo\n\ncd /root/demo/InternLM-XComposer\npython /root/demo/InternLM-XComposer/examples/gradio_demo_chat.py  --code_path /root/models/internlm-xcomposer2-vl-7b --private --num_gpus 1 --port 6006\n</code></pre> <p></p> <ul> <li>\u672c\u5730\u8fde\u63a5   \u6ce8\u610f\u5f00\u5173\u5f00\u53d1\u673a\u540e\uff0c\u7aef\u53e3\u4f1a\u53d1\u751f\u53d8\u5316</li> </ul> <pre><code># \u4ece\u672c\u5730\u4f7f\u7528 ssh \u8fde\u63a5 studio \u7aef\u53e3\n# \u5c06\u4e0b\u65b9\u7aef\u53e3\u53f7 38374 \u66ff\u6362\u6210\u81ea\u5df1\u7684\u7aef\u53e3\u53f7\nssh -CNg -L 6006:127.0.0.1:6006 root@ssh.intern-ai.org.cn -p 38374\n</code></pre>"},{"location":"chapter2/#3428","title":"3.4.2.8 \u4e0a\u4f20\u56fe\u7247\u5206\u6790\u56fe\u7247\u5185\u5bb9","text":"<ul> <li>\u4e0a\u4f20\u56fe\u7247\uff0c\u8f93\u5165\u63d0\u793a\u8bcd\u201c\u5206\u6790\u56fe\u7247\u5185\u5bb9\u201d</li> </ul>"},{"location":"chapter3/","title":"\u8bfe\u65f6\u4e09 \"\u8334\u9999\u8c46\":\u96f6\u4ee3\u7801\u642d\u5efa\u4f60\u7684 RAG \u667a\u80fd\u52a9\u7406","text":"<p>\u98de\u4e66\u5730\u5740</p> <p>\u7b97\u529b\u5e73\u53f0</p>"},{"location":"chapter3/#1","title":"1. \u63d0\u4ea4\u7684\u4f5c\u4e1a\u7ed3\u679c","text":"<p>\u4f5c\u4e1a\u8981\u6c42</p>"},{"location":"chapter3/#11-web","title":"1.1 \u8334\u9999\u8c46web\u7248\u90e8\u7f72\u77e5\u8bc6\u95ee\u7b54\u52a9\u624b","text":""},{"location":"chapter3/#12","title":"1.2 \u8334\u9999\u8c46\u6280\u672f\u52a9\u624b","text":""},{"location":"chapter3/#121","title":"1.2.1 \u4ee3\u7801\u7248","text":"<ul> <li> <p>Q1:huixiangdou \u662f\u4ec0\u4e48\uff1f</p> <ul> <li>A\uff1a</li> </ul> </li> <li> <p>Q2:\u8334\u9999\u8c46\u600e\u4e48\u90e8\u7f72\u5230\u5fae\u4fe1\u7fa4?</p> <ul> <li>A:</li> </ul> </li> <li> <p>Q3:\u4eca\u5929\u5929\u6c14\u600e\u4e48\u6837\uff1f</p> <ul> <li>A:ErrorCode.UNRELATED </li> </ul> </li> </ul>"},{"location":"chapter3/#122-giradio","title":"1.2.2 giradio\u7f51\u9875\u7248","text":"<ul> <li>\u6ce8\u610f\uff1a\u63d0\u95ee\u9700\u8981\u5e26\u95ee\u53f7\uff0c\u4e0d\u5e26\u95ee\u53f7\u8bc6\u522b\u4e0d\u51fa\u662f\u7591\u95ee\u53e5\u3002\u3002\u3002   </li> <li>code\u4e3a3\uff0c\u4e0d\u8fd4\u56de\u7ed3\u679c   </li> </ul>"},{"location":"chapter3/#13","title":"1.3 \u8fdb\u9636\u4f5c\u4e1a","text":""},{"location":"chapter3/#a","title":"A.\u3010\u5e94\u7528\u65b9\u5411\u3011 \u7ed3\u5408\u81ea\u5df1\u64c5\u957f\u7684\u9886\u57df\u77e5\u8bc6\uff08\u6e38\u620f\u3001\u6cd5\u5f8b\u3001\u7535\u5b50\u7b49\uff09\u3001\u4e13\u4e1a\u80cc\u666f\uff0c\u642d\u5efa\u4e2a\u4eba\u5de5\u4f5c\u52a9\u624b\u6216\u8005\u5782\u76f4\u9886\u57df\u95ee\u7b54\u52a9\u624b\uff0c\u53c2\u8003\u8334\u9999\u8c46\u5b98\u65b9\u6587\u6863\uff0c\u90e8\u7f72\u5230\u4e0b\u5217\u4efb\u4e00\u5e73\u53f0\u3002","text":"<ul> <li>\u98de\u4e66\u3001\u5fae\u4fe1</li> <li>\u53ef\u4ee5\u4f7f\u7528 \u8334\u9999\u8c46 Web \u7248 \u6216 InternLM Studio \u4e91\u7aef\u670d\u52a1\u5668\u90e8\u7f72</li> <li>\u6db5\u76d6\u90e8\u7f72\u5168\u8fc7\u7a0b\u7684\u4f5c\u4e1a\u62a5\u544a\u548c\u4e2a\u4eba\u52a9\u624b\u95ee\u7b54\u622a\u56fe</li> </ul>"},{"location":"chapter3/#131","title":"1.3.1 \u591a\u6a21\u6001\u5927\u6a21\u578b\u7efc\u8ff0\u8bba\u6587","text":""},{"location":"chapter3/#b-good_questionsjson-prompt-nlp-chunk","title":"B.\u3010\u7b97\u6cd5\u65b9\u5411\u3011\u5c1d\u8bd5\u4fee\u6539 <code>good_questions.json</code>\u3001\u8c03\u8bd5 prompt \u6216\u5e94\u7528\u5176\u4ed6 NLP \u6280\u672f\uff0c\u5982\u5176\u4ed6 chunk \u65b9\u6cd5\uff0c\u63d0\u9ad8\u4e2a\u4eba\u5de5\u4f5c\u52a9\u624b\u7684\u8868\u73b0\u3002","text":"<ul> <li>\u5b8c\u6210\u4e0d\u5c11\u4e8e 400 \u5b57\u7684\u7b14\u8bb0 \uff0c\u8bb0\u5f55\u81ea\u5df1\u7684\u5c1d\u8bd5\u548c\u8c03\u8bd5\u601d\u8def\uff0c\u6db5\u76d6\u5168\u8fc7\u7a0b\u548c\u6539\u8fdb\u6548\u679c\u622a\u56fe</li> </ul>"},{"location":"chapter3/#14","title":"1.4 \u5927\u4f5c\u4e1a\u9879\u76ee","text":""},{"location":"chapter3/#a_1","title":"A.\u3010\u5de5\u7a0b\u65b9\u5411\u3011 \u53c2\u4e0e\u8d21\u732e\u8334\u9999\u8c46\u524d\u7aef\uff0c\u5c06\u8334\u9999\u8c46\u52a9\u624b\u90e8\u7f72\u5230\u4e0b\u5217\u5e73\u53f0","text":"<ul> <li>Github issue\u3001Discord\u3001\u9489\u9489\u3001X</li> </ul>"},{"location":"chapter3/#b-rag-agent","title":"B.\u3010\u5e94\u7528\u65b9\u5411\u3011 \u8334\u9999\u8c46RAG-Agent","text":"<ul> <li>\u5e94\u7528\u8334\u9999\u8c46\u5efa\u7acb\u4e00\u4e2a ROS2 \u7684\u673a\u5668\u4ebaAgent</li> </ul>"},{"location":"chapter3/#c","title":"C.\u3010\u7b97\u6cd5\u65b9\u5411\u3011 \u8334\u9999\u8c46\u591a\u6a21\u6001","text":"<ul> <li>\u53c2\u4e0e\u8334\u9999\u8c46\u591a\u6a21\u6001\u7684\u5de5\u4f5c</li> </ul>"},{"location":"chapter3/#2","title":"2. \u89c6\u9891\u7b14\u8bb0","text":"<p>\u89c6\u9891\u5730\u5740</p>"},{"location":"chapter3/#3","title":"3. \u6587\u6863\u7b14\u8bb0","text":"<p>\u6587\u6863\u5730\u5740</p>"},{"location":"chapter3/#31","title":"3.1 \u524d\u7f6e\u77e5\u8bc6","text":"<p>RAG\uff08Retrieval Augmented Generation\uff09\u6280\u672f\uff0c\u901a\u8fc7\u68c0\u7d22\u4e0e\u7528\u6237\u8f93\u5165\u76f8\u5173\u7684\u4fe1\u606f\u7247\u6bb5\uff0c\u5e76\u7ed3\u5408\u5916\u90e8\u77e5\u8bc6\u5e93\u6765\u751f\u6210\u66f4\u51c6\u786e\u3001\u66f4\u4e30\u5bcc\u7684\u56de\u7b54\u3002\u89e3\u51b3 LLMs \u5728\u5904\u7406\u77e5\u8bc6\u5bc6\u96c6\u578b\u4efb\u52a1\u65f6\u53ef\u80fd\u9047\u5230\u7684\u6311\u6218, \u5982\u5e7b\u89c9\u3001\u77e5\u8bc6\u8fc7\u65f6\u548c\u7f3a\u4e4f\u900f\u660e\u3001\u53ef\u8ffd\u6eaf\u7684\u63a8\u7406\u8fc7\u7a0b\u7b49\u3002\u63d0\u4f9b\u66f4\u51c6\u786e\u7684\u56de\u7b54\u3001\u964d\u4f4e\u63a8\u7406\u6210\u672c\u3001\u5b9e\u73b0\u5916\u90e8\u8bb0\u5fc6\u3002</p> <p></p>"},{"location":"chapter3/#32-huixiangdouconda","title":"3.2 \u521b\u5efahuixiangdou\u73af\u5883\uff08conda\uff09","text":"<p><pre><code>studio-conda -o internlm-base -t InternLM2_Huixiangdou\n</code></pre> </p> <ul> <li>\u8fdb\u5165huixiangdou\u73af\u5883</li> </ul> <pre><code>conda activate InternLM2_Huixiangdou\n</code></pre> <p></p>"},{"location":"chapter3/#33","title":"3.3 \u6a21\u578b\u6587\u4ef6","text":""},{"location":"chapter3/#331-rag","title":"3.3.1 RAG\u6a21\u578b","text":"<ul> <li> <p>Github\u5730\u5740</p> </li> <li> <p>BCEmbedding</p> </li> </ul> \u6a21\u578b\u540d\u79f0 \u6a21\u578b\u7c7b\u578b \u652f\u6301\u8bed\u79cd \u53c2\u6570\u91cf \u5f00\u6e90\u6743\u91cd bce-embedding-base_v1 <code>EmbeddingModel</code> \u4e2d\u82f1 279M Huggingface(\u63a8\u8350), \u56fd\u5185\u901a\u9053, ModelScope, WiseModel bce-reranker-base_v1 <code>RerankerModel</code> \u4e2d\u82f1\u65e5\u97e9 279M Huggingface(\u63a8\u8350), \u56fd\u5185\u901a\u9053, ModelScope, WiseModel"},{"location":"chapter3/#332-share","title":"3.3.2 share\u6a21\u578b\u8f6f\u94fe\u63a5","text":"<p><pre><code># \u521b\u5efa\u6a21\u578b\u6587\u4ef6\u5939\ncd /root &amp;&amp; mkdir models\n\n# \u590d\u5236BCE\u6a21\u578b\nln -s /root/share/new_models/maidalun1020/bce-embedding-base_v1 /root/models/bce-embedding-base_v1\nln -s /root/share/new_models/maidalun1020/bce-reranker-base_v1 /root/models/bce-reranker-base_v1\n\n# \u590d\u5236\u5927\u6a21\u578b\u53c2\u6570\uff08\u4e0b\u9762\u7684\u6a21\u578b\uff0c\u6839\u636e\u4f5c\u4e1a\u8fdb\u5ea6\u548c\u4efb\u52a1\u8fdb\u884c**\u9009\u62e9\u4e00\u4e2a**\u5c31\u884c\uff09\nln -s /root/share/new_models/Shanghai_AI_Laboratory/internlm2-chat-7b /root/models/internlm2-chat-7b\n</code></pre> </p>"},{"location":"chapter3/#34","title":"3.4 \u4e0b\u8f7d\u5b89\u88c5\u8334\u9999\u8c46","text":""},{"location":"chapter3/#341","title":"3.4.1 \u5b89\u88c5\u8334\u9999\u8c46\u4f9d\u8d56\u5305","text":"<pre><code># \u5b89\u88c5 python \u4f9d\u8d56\n# pip install -r requirements.txt\n\npip install protobuf==4.25.3 accelerate==0.28.0 aiohttp==3.9.3 auto-gptq==0.7.1 bcembedding==0.1.3 beautifulsoup4==4.8.2 einops==0.7.0 faiss-gpu==1.7.2 langchain==0.1.14 loguru==0.7.2 lxml_html_clean==0.1.0 openai==1.16.1 openpyxl==3.1.2 pandas==2.2.1 pydantic==2.6.4 pymupdf==1.24.1 python-docx==1.1.0 pytoml==0.1.21 readability-lxml==0.8.1 redis==5.0.3 requests==2.31.0 scikit-learn==1.4.1.post1 sentence_transformers==2.2.2 textract==1.6.5 tiktoken==0.6.0 transformers==4.39.3 transformers_stream_generator==0.0.5 unstructured==0.11.2\n\n## \u56e0\u4e3a Intern Studio \u4e0d\u652f\u6301\u5bf9\u7cfb\u7edf\u6587\u4ef6\u7684\u6c38\u4e45\u4fee\u6539\uff0c\u5728 Intern Studio \u5b89\u88c5\u90e8\u7f72\u7684\u540c\u5b66\u4e0d\u5efa\u8bae\u5b89\u88c5 Word \u4f9d\u8d56\uff0c\u540e\u7eed\u7684\u64cd\u4f5c\u548c\u4f5c\u4e1a\u4e0d\u4f1a\u6d89\u53ca Word \u89e3\u6790\u3002\n## \u60f3\u8981\u81ea\u5df1\u5c1d\u8bd5\u89e3\u6790 Word \u6587\u4ef6\u7684\u540c\u5b66\uff0cuncomment \u6389\u4e0b\u9762\u8fd9\u884c\uff0c\u5b89\u88c5\u89e3\u6790 .doc .docx \u5fc5\u9700\u7684\u4f9d\u8d56\n# apt update &amp;&amp; apt -y install python-dev python libxml2-dev libxslt1-dev antiword unrtf poppler-utils pstotext tesseract-ocr flac ffmpeg lame libmad0 libsox-fmt-mp3 sox libjpeg-dev swig libpulse-dev\n</code></pre>"},{"location":"chapter3/#342","title":"3.4.2 \u83b7\u53d6\u8334\u9999\u8c46\u6e90\u7801","text":"<p><pre><code>cd /root\n# \u4e0b\u8f7d repo\ngit clone https://github.com/internlm/huixiangdou &amp;&amp; cd huixiangdou\ngit checkout 447c6f7e68a1657fce1c4f7c740ea1700bde0440\n</code></pre> </p>"},{"location":"chapter3/#35-rag","title":"3.5 \u642d\u5efaRAG\u52a9\u624b","text":""},{"location":"chapter3/#351-configini","title":"3.5.1 \u4fee\u6539config.ini\u914d\u7f6e\u6587\u4ef6","text":"<p>\u901a\u8fc7\u547d\u4ee4\u884c\u4fee\u6539\u4e09\u4e2a\u6a21\u578b\u8def\u5f84\uff1a\u5d4c\u5165\u6a21\u578b\u3001\u91cd\u6392\u6a21\u578b\u3001\u5927\u8bed\u8a00\u6a21\u578b\uff1a - embedding_model_path\uff08\u5411\u91cf\u6570\u636e\u5e93\u548c\u8bcd\u5d4c\u5165\u7684\u6a21\u578b\uff09   <pre><code>sed -i '6s#.*#embedding_model_path = \"/root/models/bce-embedding-base_v1\"#' /root/huixiangdou/config.ini\n</code></pre></p> <p>\u8fd9\u4e2a\u547d\u4ee4\u662f\u7528\u6765\u5728\u6307\u5b9a\u6587\u4ef6\u4e2d\u7684\u7279\u5b9a\u884c\u8fdb\u884c\u66ff\u6362\u64cd\u4f5c\u7684\u3002\u8fd9\u4e2a\u547d\u4ee4\u7684\u4e0d\u540c\u90e8\u5206\uff1a     - sed\uff1a\u8fd9\u662f\u4e00\u4e2a\u6d41\u7f16\u8f91\u5668\uff0c\u7528\u4e8e\u5bf9\u6587\u672c\u8fdb\u884c\u5904\u7406\u548c\u8f6c\u6362\u3002     - -i\uff1a\u8fd9\u662fsed\u547d\u4ee4\u7684\u4e00\u4e2a\u9009\u9879\uff0c\u8868\u793a\u76f4\u63a5\u5728\u539f\u59cb\u6587\u4ef6\u4e2d\u8fdb\u884c\u4fee\u6539\uff0c\u800c\u4e0d\u662f\u5c06\u7ed3\u679c\u8f93\u51fa\u5230\u6807\u51c6\u8f93\u51fa\u3002     - '6s#.#embedding_model_path = \"/root/models/bce-embedding-base_v1\"#'\uff1a\u8fd9\u662fsed\u547d\u4ee4\u7684\u4e00\u4e2a\u6a21\u5f0f\uff0c\u7528\u4e8e\u6307\u5b9a\u8981\u66ff\u6362\u7684\u884c\u548c\u66ff\u6362\u7684\u5185\u5bb9\u3002\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c6\u8868\u793a\u8981\u66ff\u6362\u7684\u884c\u53f7\uff0cs\u8868\u793a\u66ff\u6362\u64cd\u4f5c\uff0c#\u662f\u5206\u9694\u7b26\uff0c.\u8868\u793a\u5339\u914d\u4efb\u610f\u5b57\u7b26\uff0cembedding_model_path = \"/root/models/bce-embedding-base_v1\"\u662f\u8981\u66ff\u6362\u7684\u5185\u5bb9\u3002     - /root/huixiangdou/config.ini\uff1a\u8fd9\u662f\u8981\u8fdb\u884c\u66ff\u6362\u64cd\u4f5c\u7684\u6587\u4ef6\u7684\u8def\u5f84\u3002   \u8fd9\u4e2a\u547d\u4ee4\u7684\u4f5c\u7528\u662f\u5c06/root/huixiangdou/config.ini\u6587\u4ef6\u4e2d\u7684\u7b2c6\u884c\u66ff\u6362\u4e3aembedding_model_path = \"/root/models/bce-embedding-base_v1\"\u3002 - reranker_model_path\uff08\u68c0\u7d22\u7684\u91cd\u6392\u5e8f\u6a21\u578b\uff09   <pre><code>sed -i '7s#.*#reranker_model_path = \"/root/models/bce-reranker-base_v1\"#' /root/huixiangdou/config.ini\n</code></pre> - local_llm_path\uff08\u5927\u8bed\u8a00\u6a21\u578b\uff09   <pre><code>sed -i '29s#.*#local_llm_path = \"/root/models/internlm2-chat-7b\"#' /root/huixiangdou/config.ini\n</code></pre> </p> <p>\u6ce8\u610f\uff1a \u4e5f\u53ef\u4ee5\u76f4\u63a5\u6253\u5f00config.ini\u6587\u4ef6\u8fdb\u884c\u6587\u6863\u7f16\u8f91\u4fee\u6539\u3002</p>"},{"location":"chapter3/#352","title":"3.5.2 \u521b\u5efa\u77e5\u8bc6\u5e93","text":"<p>\u4f7f\u7528 InternLM \u7684 Huixiangdou \u6587\u6863\u4f5c\u4e3a\u65b0\u589e\u77e5\u8bc6\u6570\u636e\u68c0\u7d22\u6765\u6e90\uff0c\u5728\u4e0d\u91cd\u65b0\u8bad\u7ec3\u7684\u60c5\u51b5\u4e0b\uff0c\u6253\u9020\u4e00\u4e2a Huixiangdou \u6280\u672f\u95ee\u7b54\u52a9\u624b\u3002</p>"},{"location":"chapter3/#3521","title":"3.5.2.1 \u4e0b\u8f7d\u8bed\u6599","text":"<p>\u76f4\u63a5\u4e0b\u8f7d\u8334\u9999\u8c46\u6e90\u7801\u5230/root/huixiangdou/repodir\u4e0b\u7528\u4f5c\u8bed\u6599\u3002</p> <pre><code>cd /root/huixiangdou &amp;&amp; mkdir repodir\n\ngit clone https://github.com/internlm/huixiangdou --depth=1 repodir/huixiangdou\n</code></pre>"},{"location":"chapter3/#3522","title":"3.5.2.2 \u63a5\u53d7&amp;\u62d2\u7edd\u5411\u91cf\u6570\u636e\u5e93","text":"<p>\u9664\u4e86\u8bed\u6599\u77e5\u8bc6\u7684\u5411\u91cf\u6570\u636e\u5e93\uff0c\u8334\u9999\u8c46\u5efa\u7acb\u63a5\u53d7\u548c\u62d2\u7b54\u4e24\u4e2a\u5411\u91cf\u6570\u636e\u5e93\uff0c\u7528\u6765\u5728\u68c0\u7d22\u7684\u8fc7\u7a0b\u4e2d\u66f4\u52a0\u7cbe\u786e\u7684\u5224\u65ad\u63d0\u95ee\u7684\u76f8\u5173\u6027\uff0c\u8fd9\u4e24\u4e2a\u6570\u636e\u5e93\u7684\u6765\u6e90\u5206\u522b\u662f\uff1a   - \u63a5\u53d7\u95ee\u9898\u5217\u8868\uff0c\u5e0c\u671b\u8334\u9999\u8c46\u52a9\u624b\u56de\u7b54\u7684\u793a\u4f8b\u95ee\u9898     - \u5b58\u50a8\u5728 huixiangdou/resource/good_questions.json \u4e2d   - \u62d2\u7edd\u95ee\u9898\u5217\u8868\uff0c\u5e0c\u671b\u8334\u9999\u8c46\u52a9\u624b\u62d2\u7b54\u7684\u793a\u4f8b\u95ee\u9898     - \u5b58\u50a8\u5728 huixiangdou/resource/bad_questions.json \u4e2d     - \u5176\u4e2d\u591a\u4e3a\u6280\u672f\u65e0\u5173\u7684\u4e3b\u9898\u6216\u95f2\u804a\u3002     - \u5982\uff1a\"nihui \u662f\u8c01\", \"\u5177\u4f53\u5728\u54ea\u4e9b\u4f4d\u7f6e\u8fdb\u884c\u4fee\u6539\uff1f\", \"\u4f60\u662f\u8c01\uff1f\", \"1+1\"</p>"},{"location":"chapter3/#3523","title":"3.5.2.3 \u589e\u52a0\u8334\u9999\u8c46\u76f8\u5173\u7684\u95ee\u9898\u5230\u63a5\u53d7\u95ee\u9898\u793a\u4f8b","text":"<p>\u4ece/root/huixiangdou/resource/good_questions.json\u6587\u4ef6\u5907\u4efd\u4e3a/root/huixiangdou/resource/good_questions_bk.json\u6587\u4ef6\uff1b\u4f7f\u7528echo\u65b9\u6cd5\u65b0\u589e\u5185\u5bb9\u5e76\u521b\u5efa/root/huixiangdou/resource/good_questions.json\u6587\u4ef6\u3002</p> <pre><code>cd /root/huixiangdou\nmv resource/good_questions.json resource/good_questions_bk.json\n\necho '[\n    \"mmpose\u4e2d\u600e\u4e48\u8c03\u7528mmyolo\u63a5\u53e3\",\n    \"mmpose\u5b9e\u73b0\u59ff\u6001\u4f30\u8ba1\u540e\u600e\u4e48\u5b9e\u73b0\u884c\u4e3a\u8bc6\u522b\",\n    \"mmpose\u6267\u884c\u63d0\u53d6\u5173\u952e\u70b9\u547d\u4ee4\u4e0d\u662f\u5206\u4e3a\u4e24\u6b65\u5417\uff0c\u4e00\u6b65\u662f\u76ee\u6807\u68c0\u6d4b\uff0c\u53e6\u4e00\u6b65\u662f\u5173\u952e\u70b9\u63d0\u53d6\uff0c\u6211\u73b0\u5728\u76ee\u6807\u68c0\u6d4b\u8fd9\u90e8\u5206\u7684\u4ee3\u7801\u662fdemo/topdown_demo_with_mmdet.py demo/mmdetection_cfg/faster_rcnn_r50_fpn_coco.py checkpoints/faster_rcnn_r50_fpn_1x_coco_20200130-047c8118.pth   \u73b0\u5728\u6211\u60f3\u628a\u8fd9\u4e2ammdet\u7684checkpoints\u6362\u4f4dyolo\u7684\uff0c\u90a3\u4e48\u5e94\u8be5\u600e\u4e48\u64cd\u4f5c\",\n    \"\u5728mmdetection\u4e2d\uff0c\u5982\u4f55\u540c\u65f6\u52a0\u8f7d\u4e24\u4e2a\u6570\u636e\u96c6\uff0c\u4e24\u4e2adataloader\",\n    \"\u5982\u4f55\u5c06mmdetection2.28.2\u7684retinanet\u914d\u7f6e\u6587\u4ef6\u6539\u4e3a\u5355\u5c3a\u5ea6\u7684\u5462\uff1f\",\n    \"1.MMPose_Tutorial.ipynb\u3001inferencer_demo.py\u3001image_demo.py\u3001bottomup_demo.py\u3001body3d_pose_lifter_demo.py\u8fd9\u51e0\u4e2a\u6587\u4ef6\u548ctopdown_demo_with_mmdet.py\u7684\u533a\u522b\u662f\u4ec0\u4e48\uff0c\\n2.\u6211\u5982\u679c\u8981\u4f7f\u7528mmdet\u662f\u4e0d\u662f\u5c31\u53ea\u80fd\u4f7f\u7528topdown_demo_with_mmdet.py\u6587\u4ef6\uff0c\",\n    \"mmpose \u6d4b\u8bd5 map \u4e00\u76f4\u662f 0 \u600e\u4e48\u529e\uff1f\",\n    \"\u5982\u4f55\u4f7f\u7528mmpose\u68c0\u6d4b\u4eba\u4f53\u5173\u952e\u70b9\uff1f\",\n    \"\u6211\u4f7f\u7528\u7684\u6570\u636e\u96c6\u662flabelme\u6807\u6ce8\u7684\uff0c\u6211\u60f3\u77e5\u9053mmpose\u7684\u6570\u636e\u96c6\u90fd\u662f\u4ec0\u4e48\u6837\u5f0f\u7684\uff0c\u5168\u90fd\u662f\u5355\u76ee\u6807\u7684\u6570\u636e\u96c6\u6807\u6ce8\uff0c\u8fd8\u662f\u91cc\u8fb9\u4e5f\u6709\u591a\u76ee\u6807\u7136\u540e\u8fdb\u884c\u6807\u6ce8\",\n    \"\u5982\u4f55\u751f\u6210openmmpose\u7684c++\u63a8\u7406\u811a\u672c\",\n    \"mmpose\",\n    \"mmpose\u7684\u76ee\u6807\u68c0\u6d4b\u9636\u6bb5\u8c03\u7528\u7684\u6a21\u578b\uff0c\u4e00\u5b9a\u8981\u662fdemo\u6587\u4ef6\u5939\u4e0b\u7684\u6587\u4ef6\u5417\uff0c\u6709\u6ca1\u6709\u5176\u4ed6\u8def\u5f84\u4e0b\u7684\u6587\u4ef6\",\n    \"mmpose\u53ef\u4ee5\u5b9e\u73b0\u884c\u4e3a\u8bc6\u522b\u5417\uff0c\u5982\u679c\u8981\u5b9e\u73b0\u7684\u8bdd\u5e94\u8be5\u600e\u4e48\u505a\",\n    \"\u6211\u5728mmyolo\u7684v0.6.0 (15/8/2023)\u66f4\u65b0\u65e5\u5fd7\u91cc\u770b\u5230\u4e86\u4ed6\u65b0\u589e\u4e86\u652f\u6301\u57fa\u4e8e MMPose \u7684 YOLOX-Pose\uff0c\u6211\u73b0\u5728\u662f\u4e0d\u662f\u53ea\u9700\u8981\u5728mmpose/project/yolox-Pose\u5185\u505a\u51fa\u4e00\u4e9b\u8bbe\u7f6e\u5c31\u53ef\u4ee5\uff0c\u6362\u6389demo/mmdetection_cfg/faster_rcnn_r50_fpn_coco.py \u6539\u7528mmyolo\u6765\u8fdb\u884c\u76ee\u6807\u68c0\u6d4b\u4e86\",\n    \"mac m1\u4ece\u6e90\u7801\u5b89\u88c5\u7684mmpose\u662fx86_64\u7684\",\n    \"\u60f3\u8bf7\u6559\u4e00\u4e0bmmpose\u6709\u6ca1\u6709\u63d0\u4f9b\u53ef\u4ee5\u8bfb\u53d6\u5916\u63a5\u6444\u50cf\u5934\uff0c\u505a3d\u59ff\u6001\u5e76\u8fbe\u5230\u5b9e\u65f6\u7684\u9879\u76ee\u5440\uff1f\",\n    \"huixiangdou \u662f\u4ec0\u4e48\uff1f\",\n    \"\u4f7f\u7528\u79d1\u7814\u4eea\u5668\u9700\u8981\u6ce8\u610f\u4ec0\u4e48\uff1f\",\n    \"huixiangdou \u662f\u4ec0\u4e48\uff1f\",\n    \"\u8334\u9999\u8c46 \u662f\u4ec0\u4e48\uff1f\",\n    \"\u8334\u9999\u8c46 \u80fd\u90e8\u7f72\u5230\u5fae\u4fe1\u5417\uff1f\",\n    \"\u8334\u9999\u8c46 \u600e\u4e48\u5e94\u7528\u5230\u98de\u4e66\",\n    \"\u8334\u9999\u8c46 \u80fd\u90e8\u7f72\u5230\u5fae\u4fe1\u7fa4\u5417\uff1f\",\n    \"\u8334\u9999\u8c46 \u600e\u4e48\u5e94\u7528\u5230\u98de\u4e66\u7fa4\",\n    \"huixiangdou \u80fd\u90e8\u7f72\u5230\u5fae\u4fe1\u5417\uff1f\",\n    \"huixiangdou \u600e\u4e48\u5e94\u7528\u5230\u98de\u4e66\",\n    \"huixiangdou \u80fd\u90e8\u7f72\u5230\u5fae\u4fe1\u7fa4\u5417\uff1f\",\n    \"huixiangdou \u600e\u4e48\u5e94\u7528\u5230\u98de\u4e66\u7fa4\",\n    \"huixiangdou\",\n    \"\u8334\u9999\u8c46\",\n    \"\u8334\u9999\u8c46 \u6709\u54ea\u4e9b\u5e94\u7528\u573a\u666f\",\n    \"huixiangdou \u6709\u4ec0\u4e48\u7528\",\n    \"huixiangdou \u7684\u4f18\u52bf\u6709\u54ea\u4e9b\uff1f\",\n    \"\u8334\u9999\u8c46 \u5df2\u7ecf\u5e94\u7528\u7684\u573a\u666f\",\n    \"huixiangdou \u5df2\u7ecf\u5e94\u7528\u7684\u573a\u666f\",\n    \"huixiangdou \u600e\u4e48\u5b89\u88c5\",\n    \"\u8334\u9999\u8c46 \u600e\u4e48\u5b89\u88c5\",\n    \"\u8334\u9999\u8c46 \u6700\u65b0\u7248\u672c\u662f\u4ec0\u4e48\",\n    \"\u8334\u9999\u8c46 \u652f\u6301\u54ea\u4e9b\u5927\u6a21\u578b\",\n    \"\u8334\u9999\u8c46 \u652f\u6301\u54ea\u4e9b\u901a\u8baf\u8f6f\u4ef6\",\n    \"config.ini \u6587\u4ef6\u600e\u4e48\u914d\u7f6e\",\n    \"remote_llm_model \u53ef\u4ee5\u586b\u54ea\u4e9b\u6a21\u578b?\"\n]' &gt; /root/huixiangdou/resource/good_questions.json\n</code></pre> <p></p>"},{"location":"chapter3/#3524","title":"3.5.2.4 \u521b\u5efa\u6d4b\u8bd5\u95ee\u9898","text":"<p>\u4f7f\u7528echo\u65b9\u6cd5\u65b0\u589e\u5185\u5bb9\u5e76\u521b\u5efatest_queries.json\u6587\u4ef6</p> <pre><code>cd /root/huixiangdou\n\necho '[\n\"huixiangdou \u662f\u4ec0\u4e48\uff1f\",\n\"\u4f60\u597d\uff0c\u4ecb\u7ecd\u4e0b\u81ea\u5df1\"\n]' &gt; ./test_queries.json\n</code></pre> <p></p>"},{"location":"chapter3/#3525","title":"3.5.2.5 \u521b\u5efa\u77e5\u8bc6\u5e93\u7684\u5411\u91cf\u5e93","text":"<ul> <li>\u65b0\u5efaworkdir\u6587\u4ef6\u5939\u7528\u4e8e\u5b58\u50a8\u5411\u91cf\u6570\u636e\u5e93</li> </ul> <pre><code># \u521b\u5efa\u5411\u91cf\u6570\u636e\u5e93\u5b58\u50a8\u76ee\u5f55\ncd /root/huixiangdou &amp;&amp; mkdir workdir \n</code></pre> <ul> <li>\u521b\u5efa\u5411\u91cf\u6570\u636e\u5e93 <pre><code># \u5206\u522b\u5411\u91cf\u5316\u77e5\u8bc6\u8bed\u6599\u3001\u63a5\u53d7\u95ee\u9898\u548c\u62d2\u7edd\u95ee\u9898\u4e2d\u540e\u4fdd\u5b58\u5230 workdir\npython3 -m huixiangdou.service.feature_store --sample ./test_queries.json\n</code></pre></li> </ul> <p>\u68c0\u7d22\u8fc7\u7a0b\u4e2d\uff0c\u8334\u9999\u8c46\u4f1a\u5c06\u8f93\u5165\u95ee\u9898\u4e0e\u4e24\u4e2a\u5217\u8868\u4e2d\u7684\u95ee\u9898\u5728\u5411\u91cf\u7a7a\u95f4\u8fdb\u884c\u76f8\u4f3c\u6027\u6bd4\u8f83\uff0c\u5224\u65ad\u8be5\u95ee\u9898\u662f\u5426\u5e94\u8be5\u56de\u7b54\uff0c\u907f\u514d\u7fa4\u804a\u8fc7\u7a0b\u4e2d\u7684\u95ee\u7b54\u6cdb\u6ee5\u3002\u786e\u5b9a\u7684\u56de\u7b54\u7684\u95ee\u9898\u4f1a\u5229\u7528\u57fa\u7840\u6a21\u578b\u63d0\u53d6\u5173\u952e\u8bcd\uff0c\u5728\u77e5\u8bc6\u5e93\u4e2d\u68c0\u7d22 top K \u76f8\u4f3c\u7684 chunk\uff0c\u7efc\u5408\u95ee\u9898\u548c\u68c0\u7d22\u5230\u7684 chunk \u751f\u6210\u7b54\u6848\u3002</p>"},{"location":"chapter3/#353-rag","title":"3.5.3 \u8fd0\u884c\u8334\u9999\u8c46RAG\u52a9\u624b","text":"<p>\u6d4b\u8bd5\u5411\u91cf\u6570\u636e\u5e93\u65b9\u5f0f\u5b58\u50a8\u7684\u77e5\u8bc6\u5e93\u3002\u5b9e\u73b0RAG\u68c0\u7d22\u540e\u53d1\u9001\u7ed9\u5927\u6a21\u578b\u3002</p>"},{"location":"chapter3/#3531-mainpy","title":"3.5.3.1 \u4fee\u6539main.py\u6587\u4ef6\u4e2d\u7684\u95ee\u9898","text":"<ul> <li>\u4f7f\u7528\u547d\u4ee4\u884csed\u65b9\u5f0f\u5bf9main\u6587\u4ef6\u8fdb\u884c\u4fee\u6539</li> </ul> <pre><code># \u586b\u5165\u95ee\u9898\nsed -i '74s/.*/    queries = [\"huixiangdou \u662f\u4ec0\u4e48\uff1f\", \"\u8334\u9999\u8c46\u600e\u4e48\u90e8\u7f72\u5230\u5fae\u4fe1\u7fa4\", \"\u4eca\u5929\u5929\u6c14\u600e\u4e48\u6837\uff1f\"]/' /root/huixiangdou/huixiangdou/main.py\n</code></pre> <ul> <li>\u8fd0\u884c\u95ee\u9898</li> </ul> <pre><code># \u8fd0\u884c\u8334\u9999\u8c46\ncd /root/huixiangdou/\npython3 -m huixiangdou.main --standalone\n</code></pre> <p>RAG \u6280\u672f\u7684\u4f18\u52bf\u5c31\u662f\u975e\u53c2\u6570\u5316\u7684\u6a21\u578b\u8c03\u4f18\uff0c\u8fd9\u91cc\u4f7f\u7528\u7684\u4ecd\u7136\u662f\u57fa\u7840\u6a21\u578b InternLM2-Chat-7B\uff0c \u6ca1\u6709\u4efb\u4f55\u989d\u5916\u6570\u636e\u7684\u8bad\u7ec3\u3002\uff08\u7b80\u800c\u8a00\u4e4b\uff1a\u5916\u6302\u5411\u91cf\u5316\u7684\u77e5\u8bc6\u5e93\u2014\u2014&gt;\u5411\u91cf\u68c0\u7d22\u6392\u5e8f\u2014\u2014&gt;\u7ed3\u679c\u7ed9\u5927\u6a21\u578b\u4f5c\u4e3a\u4e0a\u4e0b\u6587\u8fdb\u884c\u5bf9\u8bdd\u2014\u2014&gt;\u6807\u8bc6\u51fa\u5904\uff09   \u9762\u5bf9\u540c\u6837\u7684\u95ee\u9898\uff0c\u6211\u4eec\u7684\u8334\u9999\u8c46\u6280\u672f\u52a9\u7406\u80fd\u591f\u6839\u636e\u6211\u4eec\u63d0\u4f9b\u7684\u6570\u636e\u5e93\u751f\u6210\u51c6\u786e\u7684\u7b54\u6848\uff1a</p> <ul> <li> <p>Q1:huixiangdou \u662f\u4ec0\u4e48\uff1f</p> <ul> <li>A\uff1a</li> </ul> </li> <li> <p>Q2:\u8334\u9999\u8c46\u600e\u4e48\u90e8\u7f72\u5230\u5fae\u4fe1\u7fa4?</p> <ul> <li>A:</li> </ul> </li> <li> <p>Q3:\u4eca\u5929\u5929\u6c14\u600e\u4e48\u6837\uff1f</p> <ul> <li>A:ErrorCode.UNRELATED </li> </ul> </li> </ul>"},{"location":"chapter3/#36","title":"3.6 \u8054\u7f51\u641c\u7d22","text":""},{"location":"chapter3/#361-serper-api","title":"3.6.1 Serper API\u8c03\u7528","text":"<ul> <li>\u83b7\u53d6API key</li> </ul> <ul> <li>\u4fee\u6539config\u914d\u7f6e\u6587\u4ef6\u586b\u5199key</li> </ul>"},{"location":"chapter3/#37","title":"3.7 \u5176\u4ed6\u5927\u6a21\u578b\u63a5\u53e3\u8c03\u7528","text":""},{"location":"chapter3/#371","title":"3.7.1 \u4fee\u6539\u914d\u7f6e\u6587\u4ef6","text":"<p><pre><code>enable_local = 0 # \u5173\u95ed\u672c\u5730\u6a21\u578b\nenable_remote = 1 # \u542f\u7528\u4e91\u7aef\u6a21\u578b\n</code></pre> </p>"},{"location":"chapter3/#372-kimiapi-key","title":"3.7.2 \u521b\u5efakimi\u5927\u6a21\u578bAPI key","text":"<ul> <li>\u6708\u7403\u80cc\u9762API key\u5730\u5740</li> </ul> <ul> <li>\u6dfb\u52a0key\u5230config\u914d\u7f6e\u6587\u4ef6</li> </ul>"},{"location":"chapter3/#38-demo","title":"3.8 \u7f51\u9875demo","text":""},{"location":"chapter3/#381-gradio","title":"3.8.1 \u5b89\u88c5gradio\u4f9d\u8d56\u5305","text":"<pre><code>conda activate InternLM2_Huixiangdou\npip install gradio==4.25.0 redis==5.0.3 flask==3.0.2 lark_oapi==1.2.4\n</code></pre>"},{"location":"chapter3/#382-demo","title":"3.8.2 \u8fd0\u884cdemo\u670d\u52a1","text":"<p><pre><code>cd /root/huixiangdou\npython3 -m tests.test_query_gradio \n</code></pre> </p>"},{"location":"chapter3/#383","title":"3.8.3 \u672c\u5730\u6620\u5c04\u8bbf\u95ee","text":"<p><pre><code>ssh -CNg -L 7860:127.0.0.1:7860 root@ssh.intern-ai.org.cn -p 41886\n</code></pre> \u672c\u5730\u8bbf\u95ee\u5730\u5740\uff1ahttp://127.0.0.1:7860/</p> <p></p> <p>\u6ce8\u610f\uff1a\u63d0\u95ee\u9700\u8981\u5e26\u95ee\u53f7\uff0c\u4e0d\u5e26\u95ee\u53f7\u8bc6\u522b\u4e0d\u51fa\u662f\u7591\u95ee\u53e5\u3002\u3002\u3002 </p>"},{"location":"chapter3/#4-web","title":"4. web\u7248\u8334\u9999\u8c46\u7b14\u8bb0","text":"<p>web\u7248OpenXLab\u5730\u5740</p> <ul> <li> <p>\u9996\u9875\u8f93\u5165\u77e5\u8bc6\u5e93\u540d&amp;\u5bc6\u7801 </p> </li> <li> <p>\u4e0a\u4f20\u6587\u6863\uff08\u5947\u7ee9\u8bba\u575b\uff08\u9646\u5947\u6df1\u5733\u6f14\u8bb2\uff09\uff09</p> </li> </ul> <p></p> <p></p> <p></p> <ul> <li>\u804a\u5929\u6d4b\u8bd5</li> </ul> <p></p> <p></p> <p></p> <p></p> <p></p>"},{"location":"chapter3/#5","title":"5. \u81ea\u5b9a\u4e49\u673a\u5668\u4eba","text":""},{"location":"chapter3/#51","title":"5.1 \u98de\u4e66\u81ea\u5b9a\u4e49\u673a\u5668\u4eba","text":"<ul> <li>\u70b9\u51fb\u521b\u5efa\u98de\u4e66\u81ea\u5b9a\u4e49\u673a\u5668\u4eba\uff0c\u83b7\u53d6\u56de\u8c03 WEBHOOK_URL\uff0c\u586b\u5199\u5230 config.ini</li> </ul> <ul> <li>\u9a8c\u8bc1\u56de\u8c03webhook_url</li> </ul> <p><pre><code>curl.exe -X POST -H \"Content-Type: application/json\" -d '{\\\"msg_type\\\":\\\"text\\\",\\\"content\\\":{\\\"text\\\":\\\"requestexample\\\"}}' https://open.feishu.cn/open-apis/bot/v2/hook/f79d7ccf-fa1a-48b4-b861-********\n</code></pre> </p> <ul> <li>\u8fd0\u884c\u5bf9\u8bdd</li> </ul> <pre><code>conda activate InternLM2_Huixiangdou\ncd /root/huixiangdou/\npython3 -m huixiangdou.main --standalone\n</code></pre> <p></p>"},{"location":"chapter3/#6","title":"6. \u591a\u6a21\u6001\u5927\u6a21\u578b\u7efc\u8ff0\u8bba\u6587\u77e5\u8bc6\u5e93&amp;\u98de\u4e66\u81ea\u5b9a\u4e49\u673a\u5668\u4eba","text":""},{"location":"chapter3/#61-repodirworkdir","title":"6.1  repodir\u2014\u2014&gt;workdir","text":"<p>\u6559\u7a0b\u4e2d\u5c06repodir\u4e2d\u7684\u6240\u6709\u5185\u5bb9\uff0c\u5747\u5411\u91cf\u5316\u540e\u5b58\u5230\u5411\u91cf\u6570\u636e\u5e93\u4e2d\uff0c\u5e76\u5b58\u653e\u5728workdir\u6587\u4ef6\u5939\u4e2d\u3002</p>"},{"location":"chapter3/#611","title":"6.1.1 \u6587\u4ef6\u5939\u5907\u4efd","text":"<pre><code>cp -r repodir repodir_bk\ncp -r workdir workdir_bk\n</code></pre>"},{"location":"chapter3/#612","title":"6.1.2 \u77e5\u8bc6\u5e93\u8d44\u6599\u51c6\u5907","text":"<ul> <li>\u590d\u5236\u8bba\u6587pdf\u5230repodir\u6587\u4ef6\u5939\u4e0b</li> </ul>"},{"location":"chapter3/#613","title":"6.1.3 \u77e5\u8bc6\u5e93\u5411\u91cf\u5316","text":"<p><pre><code>python3 -m huixiangdou.service.feature_store\n</code></pre> </p>"},{"location":"chapter3/#614","title":"6.1.4 \u57fa\u4e8e\u5411\u91cf\u5316\u6570\u636e\u5e93\u8fdb\u884c\u95ee\u7b54","text":"<ul> <li>\u4fee\u6539main.py\u6587\u4ef6</li> </ul> <pre><code>    queries = [\"\u591a\u6a21\u6001\u5927\u6a21\u578b\u662f\u4ec0\u4e48\uff1f\"]\n</code></pre> <ul> <li>\u8fd0\u884c</li> </ul> <pre><code>cd /root/huixiangdou/\npython3 -m huixiangdou.main --standalone\n</code></pre>"},{"location":"chapter4/","title":"\u8bfe\u65f6\u56db XTuner\u5fae\u8c03\u591a\u6a21\u6001Agent","text":"<p>\u98de\u4e66\u5730\u5740</p> <p>\u7b97\u529b\u5e73\u53f0</p>"},{"location":"chapter4/#1","title":"1. \u63d0\u4ea4\u7684\u4f5c\u4e1a\u7ed3\u679c","text":"<p>\u4f5c\u4e1a\u8981\u6c42</p>"},{"location":"chapter4/#11","title":"1.1 \u8bad\u7ec3\u81ea\u5df1\u7684\u5c0f\u52a9\u624b\u8ba4\u77e5\uff08\u8bb0\u5f55\u590d\u73b0\u8fc7\u7a0b\u5e76\u622a\u56fe\uff09","text":"<ul> <li>\u8bad\u7ec3\u5b8c\u5c0f\u52a9\u624b\u5bf9\u8bdd\u622a\u56fe\uff1a</li> </ul> <p> - \u590d\u73b0\u7b14\u8bb0\uff1a \u590d\u73b0\u6b65\u9aa4</p>"},{"location":"chapter4/#12-openxlab-openxlab","title":"1.2 \u5c06\u81ea\u6211\u8ba4\u77e5\u7684\u6a21\u578b\u4e0a\u4f20\u5230 OpenXLab\uff0c\u5e76\u5c06\u5e94\u7528\u90e8\u7f72\u5230 OpenXLab","text":""},{"location":"chapter4/#13","title":"1.3  \u590d\u73b0\u591a\u6a21\u6001\u5fae\u8c03","text":"<ul> <li>\u590d\u73b0\u7ed3\u679c\u622a\u56fe</li> </ul> <ul> <li>\u590d\u73b0\u8fc7\u7a0b\u6587\u6863</li> </ul> <p>\u591a\u6a21\u6001\u5fae\u8c03\u590d\u73b0</p>"},{"location":"chapter4/#2","title":"2. \u6587\u6863\u590d\u73b0\u7b14\u8bb0","text":"<p>\u6587\u6863\u5730\u5740</p>"},{"location":"chapter4/#21","title":"2.1 \u524d\u7f6e\u77e5\u8bc6","text":""},{"location":"chapter4/#22","title":"2.2 \u590d\u73b0\u6b65\u9aa4","text":""},{"location":"chapter4/#221","title":"2.2.1 \u73af\u5883\u914d\u7f6e","text":"<ul> <li>\u521b\u5efa\u5f00\u53d1\u673a</li> </ul> <ul> <li>\u8fdb\u5165\u5f00\u53d1\u673a\u521b\u5efaconda\u73af\u5883</li> </ul> <pre><code>cd /root\n/share/install_conda_env_internlm_base.sh xtuner0.1.9\n</code></pre> <ul> <li>\u6fc0\u6d3bxtuner0.1.9\u73af\u5883&amp;\u521b\u5efa\u6587\u4ef6\u5939</li> </ul> <pre><code>conda activate xtuner0.1.9\ncd /root\nmkdir xtuner019 &amp;&amp; cd xtuner019\n</code></pre> <ul> <li>\u83b7\u53d60.1.9\u7248\u672c\u6e90\u7801</li> </ul> <p><pre><code>git clone -b v0.1.9  https://github.com/InternLM/xtuner\n</code></pre> </p> <ul> <li>\u4ece\u6e90\u7801\u5b89\u88c5Xtuner</li> </ul> <pre><code>cd xtuner\npip install -e '.[all]'\n</code></pre> <p></p> <ul> <li>\u521b\u5efa\u6570\u636e\u96c6\u6587\u4ef6\u5939\u5730\u5740</li> </ul> <pre><code># \u521b\u5efa\u4e00\u4e2a\u5fae\u8c03 oasst1 \u6570\u636e\u96c6\u7684\u5de5\u4f5c\u8def\u5f84\uff0c\u8fdb\u5165\nmkdir ~/ft-oasst1 &amp;&amp; cd ~/ft-oasst1\n</code></pre> <p></p>"},{"location":"chapter4/#222","title":"2.2.2 \u5fae\u8c03","text":""},{"location":"chapter4/#2221","title":"2.2.2.1 \u51c6\u5907\u914d\u7f6e\u6587\u4ef6","text":"<pre><code># \u5217\u51fa\u6240\u6709\u5185\u7f6e\u914d\u7f6e\nxtuner list-cfg\n</code></pre> <p>\u5047\u5982\u663e\u793abash: xtuner: command not found\u7684\u8bdd\u53ef\u4ee5\u8003\u8651\u5728\u7ec8\u7aef\u8f93\u5165 export PATH=$PATH:'/root/.local/bin'</p> <p>\u6211\u662f\u53c8\u6267\u884c\u4e86\u4e00\u904d\u6e90\u7801\u5b89\u88c5\u547d\u4ee4</p> <pre><code>cd xtuner\npip install -e '.[all]'\n</code></pre> <ul> <li>\u914d\u7f6e\u6587\u4ef6 <pre><code>xtuner list-cfg\n</code></pre></li> </ul> <p></p> \u5c55\u5f00\u5185\u5bb9 <pre><code>==========================CONFIGS===========================\nbaichuan2_13b_base_qlora_alpaca_e3\nbaichuan2_13b_base_qlora_alpaca_enzh_e3\nbaichuan2_13b_base_qlora_alpaca_enzh_oasst1_e3\nbaichuan2_13b_base_qlora_alpaca_zh_e3\nbaichuan2_13b_base_qlora_arxiv_gentitle_e3\nbaichuan2_13b_base_qlora_code_alpaca_e3\nbaichuan2_13b_base_qlora_colorist_e5\nbaichuan2_13b_base_qlora_lawyer_e3\nbaichuan2_13b_base_qlora_oasst1_512_e3\nbaichuan2_13b_base_qlora_oasst1_e3\nbaichuan2_13b_base_qlora_open_platypus_e3\nbaichuan2_13b_base_qlora_sql_e3\nbaichuan2_13b_chat_qlora_alpaca_e3\nbaichuan2_13b_chat_qlora_alpaca_enzh_e3\nbaichuan2_13b_chat_qlora_alpaca_enzh_oasst1_e3\nbaichuan2_13b_chat_qlora_alpaca_zh_e3\nbaichuan2_13b_chat_qlora_code_alpaca_e3\nbaichuan2_13b_chat_qlora_lawyer_e3\nbaichuan2_13b_chat_qlora_oasst1_512_e3\nbaichuan2_13b_chat_qlora_oasst1_e3\nbaichuan2_13b_chat_qlora_open_platypus_e3\nbaichuan2_7b_base_qlora_alpaca_e3\nbaichuan2_7b_base_qlora_alpaca_enzh_e3\nbaichuan2_7b_base_qlora_alpaca_enzh_oasst1_e3\nbaichuan2_7b_base_qlora_alpaca_zh_e3\nbaichuan2_7b_base_qlora_arxiv_gentitle_e3\nbaichuan2_7b_base_qlora_code_alpaca_e3\nbaichuan2_7b_base_qlora_colorist_e5\nbaichuan2_7b_base_qlora_lawyer_e3\nbaichuan2_7b_base_qlora_oasst1_512_e3\nbaichuan2_7b_base_qlora_oasst1_e3\nbaichuan2_7b_base_qlora_open_platypus_e3\nbaichuan2_7b_base_qlora_sql_e3\nbaichuan2_7b_chat_qlora_alpaca_e3\nbaichuan2_7b_chat_qlora_alpaca_enzh_e3\nbaichuan2_7b_chat_qlora_alpaca_enzh_oasst1_e3\nbaichuan2_7b_chat_qlora_alpaca_zh_e3\nbaichuan2_7b_chat_qlora_code_alpaca_e3\nbaichuan2_7b_chat_qlora_lawyer_e3\nbaichuan2_7b_chat_qlora_oasst1_512_e3\nbaichuan2_7b_chat_qlora_oasst1_e3\nbaichuan2_7b_chat_qlora_open_platypus_e3\nbaichuan_13b_base_qlora_alpaca_e3\nbaichuan_13b_base_qlora_alpaca_enzh_e3\nbaichuan_13b_base_qlora_alpaca_enzh_oasst1_e3\nbaichuan_13b_base_qlora_alpaca_zh_e3\nbaichuan_13b_base_qlora_arxiv_gentitle_e3\nbaichuan_13b_base_qlora_code_alpaca_e3\nbaichuan_13b_base_qlora_colorist_e5\nbaichuan_13b_base_qlora_lawyer_e3\nbaichuan_13b_base_qlora_medical_e1\nbaichuan_13b_base_qlora_moss_sft_all_e1\nbaichuan_13b_base_qlora_moss_sft_all_e2_gpu8\nbaichuan_13b_base_qlora_moss_sft_plugins_e1\nbaichuan_13b_base_qlora_oasst1_512_e3\nbaichuan_13b_base_qlora_oasst1_e3\nbaichuan_13b_base_qlora_open_platypus_e3\nbaichuan_13b_base_qlora_openorca_e1\nbaichuan_13b_base_qlora_sql_e3\nbaichuan_13b_base_qlora_tiny_codes_e1\nbaichuan_13b_chat_qlora_alpaca_e3\nbaichuan_13b_chat_qlora_alpaca_enzh_e3\nbaichuan_13b_chat_qlora_alpaca_enzh_oasst1_e3\nbaichuan_13b_chat_qlora_alpaca_zh_e3\nbaichuan_13b_chat_qlora_arxiv_gentitle_e3\nbaichuan_13b_chat_qlora_code_alpaca_e3\nbaichuan_13b_chat_qlora_colorist_e5\nbaichuan_13b_chat_qlora_lawyer_e3\nbaichuan_13b_chat_qlora_medical_e1\nbaichuan_13b_chat_qlora_oasst1_512_e3\nbaichuan_13b_chat_qlora_oasst1_e3\nbaichuan_13b_chat_qlora_open_platypus_e3\nbaichuan_13b_chat_qlora_openorca_e1\nbaichuan_13b_chat_qlora_sql_e3\nbaichuan_13b_chat_qlora_tiny_codes_e1\nbaichuan_7b_qlora_alpaca_e3\nbaichuan_7b_qlora_alpaca_enzh_e3\nbaichuan_7b_qlora_alpaca_enzh_oasst1_e3\nbaichuan_7b_qlora_alpaca_zh_e3\nbaichuan_7b_qlora_arxiv_gentitle_e3\nbaichuan_7b_qlora_code_alpaca_e3\nbaichuan_7b_qlora_colorist_e5\nbaichuan_7b_qlora_lawyer_e3\nbaichuan_7b_qlora_medical_e1\nbaichuan_7b_qlora_moss_sft_all_e1\nbaichuan_7b_qlora_moss_sft_all_e2_gpu8\nbaichuan_7b_qlora_moss_sft_plugins_e1\nbaichuan_7b_qlora_oasst1_512_e3\nbaichuan_7b_qlora_oasst1_e3\nbaichuan_7b_qlora_open_platypus_e3\nbaichuan_7b_qlora_openorca_e1\nbaichuan_7b_qlora_sql_e3\nbaichuan_7b_qlora_tiny_codes_e1\nchatglm2_6b_qlora_alpaca_e3\nchatglm2_6b_qlora_alpaca_enzh_e3\nchatglm2_6b_qlora_alpaca_enzh_oasst1_e3\nchatglm2_6b_qlora_alpaca_zh_e3\nchatglm2_6b_qlora_arxiv_gentitle_e3\nchatglm2_6b_qlora_code_alpaca_e3\nchatglm2_6b_qlora_colorist_e5\nchatglm2_6b_qlora_lawyer_e3\nchatglm2_6b_qlora_medical_e1\nchatglm2_6b_qlora_oasst1_512_e3\nchatglm2_6b_qlora_oasst1_e3\nchatglm2_6b_qlora_open_platypus_e3\nchatglm2_6b_qlora_openorca_e1\nchatglm2_6b_qlora_sql_e3\nchatglm2_6b_qlora_tiny_codes_e1\nchatglm3_6b_base_qlora_alpaca_e3\nchatglm3_6b_base_qlora_alpaca_enzh_e3\nchatglm3_6b_base_qlora_alpaca_enzh_oasst1_e3\nchatglm3_6b_base_qlora_alpaca_zh_e3\nchatglm3_6b_base_qlora_arxiv_gentitle_e3\nchatglm3_6b_base_qlora_code_alpaca_e3\nchatglm3_6b_base_qlora_colorist_e5\nchatglm3_6b_base_qlora_lawyer_e3\nchatglm3_6b_base_qlora_medical_e1\nchatglm3_6b_base_qlora_oasst1_512_e3\nchatglm3_6b_base_qlora_oasst1_e3\nchatglm3_6b_base_qlora_open_platypus_e3\nchatglm3_6b_base_qlora_openorca_e1\nchatglm3_6b_base_qlora_sql_e3\nchatglm3_6b_base_qlora_tiny_codes_e1\nchatglm3_6b_qlora_alpaca_e3\nchatglm3_6b_qlora_alpaca_enzh_e3\nchatglm3_6b_qlora_alpaca_enzh_oasst1_e3\nchatglm3_6b_qlora_alpaca_zh_e3\nchatglm3_6b_qlora_arxiv_gentitle_e3\nchatglm3_6b_qlora_code_alpaca_e3\nchatglm3_6b_qlora_colorist_e5\nchatglm3_6b_qlora_lawyer_e3\nchatglm3_6b_qlora_medical_e1\nchatglm3_6b_qlora_oasst1_512_e3\nchatglm3_6b_qlora_oasst1_e3\nchatglm3_6b_qlora_open_platypus_e3\nchatglm3_6b_qlora_openorca_e1\nchatglm3_6b_qlora_sql_e3\nchatglm3_6b_qlora_tiny_codes_e1\ndeepspeed_zero1\ndeepspeed_zero2\ndeepspeed_zero2_offload\ndeepspeed_zero3\ndeepspeed_zero3_offload\ninternlm_20b_qlora_alpaca_e3\ninternlm_20b_qlora_alpaca_enzh_e3\ninternlm_20b_qlora_alpaca_enzh_oasst1_e3\ninternlm_20b_qlora_alpaca_zh_e3\ninternlm_20b_qlora_arxiv_gentitle_e3\ninternlm_20b_qlora_code_alpaca_e3\ninternlm_20b_qlora_colorist_e5\ninternlm_20b_qlora_lawyer_e3\ninternlm_20b_qlora_msagent_react_e3_gpu8\ninternlm_20b_qlora_oasst1_512_e3\ninternlm_20b_qlora_oasst1_e3\ninternlm_20b_qlora_open_platypus_e3\ninternlm_20b_qlora_sql_e3\ninternlm_7b_full_alpaca_e3\ninternlm_7b_full_alpaca_enzh_e3\ninternlm_7b_full_alpaca_enzh_oasst1_e3\ninternlm_7b_full_alpaca_zh_e3\ninternlm_7b_full_oasst1_e3\ninternlm_7b_qlora_alpaca_e3\ninternlm_7b_qlora_alpaca_enzh_e3\ninternlm_7b_qlora_alpaca_enzh_oasst1_e3\ninternlm_7b_qlora_alpaca_zh_e3\ninternlm_7b_qlora_arxiv_gentitle_e3\ninternlm_7b_qlora_code_alpaca_e3\ninternlm_7b_qlora_colorist_e5\ninternlm_7b_qlora_lawyer_e3\ninternlm_7b_qlora_medical_e1\ninternlm_7b_qlora_moss_sft_all_e1\ninternlm_7b_qlora_moss_sft_all_e2_gpu8\ninternlm_7b_qlora_moss_sft_plugins_e1\ninternlm_7b_qlora_msagent_react_e3_gpu8\ninternlm_7b_qlora_oasst1_512_e3\ninternlm_7b_qlora_oasst1_e3\ninternlm_7b_qlora_oasst1_e3_hf\ninternlm_7b_qlora_oasst1_mmlu_e3\ninternlm_7b_qlora_open_platypus_e3\ninternlm_7b_qlora_openorca_e1\ninternlm_7b_qlora_sql_e3\ninternlm_7b_qlora_tiny_codes_e1\ninternlm_chat_20b_qlora_alpaca_e3\ninternlm_chat_20b_qlora_alpaca_enzh_e3\ninternlm_chat_20b_qlora_alpaca_enzh_oasst1_e3\ninternlm_chat_20b_qlora_alpaca_zh_e3\ninternlm_chat_20b_qlora_code_alpaca_e3\ninternlm_chat_20b_qlora_lawyer_e3\ninternlm_chat_20b_qlora_oasst1_512_e3\ninternlm_chat_20b_qlora_oasst1_e3\ninternlm_chat_20b_qlora_open_platypus_e3\ninternlm_chat_7b_qlora_alpaca_e3\ninternlm_chat_7b_qlora_alpaca_enzh_e3\ninternlm_chat_7b_qlora_alpaca_enzh_oasst1_e3\ninternlm_chat_7b_qlora_alpaca_zh_e3\ninternlm_chat_7b_qlora_arxiv_gentitle_e3\ninternlm_chat_7b_qlora_code_alpaca_e3\ninternlm_chat_7b_qlora_colorist_e5\ninternlm_chat_7b_qlora_lawyer_e3\ninternlm_chat_7b_qlora_medical_e1\ninternlm_chat_7b_qlora_oasst1_512_e3\ninternlm_chat_7b_qlora_oasst1_e3\ninternlm_chat_7b_qlora_open_platypus_e3\ninternlm_chat_7b_qlora_openorca_e1\ninternlm_chat_7b_qlora_sql_e3\ninternlm_chat_7b_qlora_tiny_codes_e1\nllama2_70b_int8_lora_open_platypus_e1\nllama2_70b_int8_lora_open_platypus_e1_hf\nllama2_70b_qlora_open_platypus_e1\nllama2_70b_qlora_open_platypus_e1_hf\nllama2_7b_chat_qlora_alpaca_e3\nllama2_7b_chat_qlora_alpaca_enzh_e3\nllama2_7b_chat_qlora_alpaca_enzh_oasst1_e3\nllama2_7b_chat_qlora_alpaca_zh_e3\nllama2_7b_chat_qlora_arxiv_gentitle_e3\nllama2_7b_chat_qlora_code_alpaca_e3\nllama2_7b_chat_qlora_colorist_e5\nllama2_7b_chat_qlora_lawyer_e3\nllama2_7b_chat_qlora_medical_e1\nllama2_7b_chat_qlora_oasst1_512_e3\nllama2_7b_chat_qlora_oasst1_e3\nllama2_7b_chat_qlora_open_platypus_e3\nllama2_7b_chat_qlora_openorca_e1\nllama2_7b_chat_qlora_sql_e3\nllama2_7b_chat_qlora_tiny_codes_e1\nllama2_7b_full_wizardlm_e1\nllama2_7b_qlora_alpaca_e3\nllama2_7b_qlora_alpaca_enzh_e3\nllama2_7b_qlora_alpaca_enzh_oasst1_e3\nllama2_7b_qlora_alpaca_zh_e3\nllama2_7b_qlora_arxiv_gentitle_e3\nllama2_7b_qlora_code_alpaca_e3\nllama2_7b_qlora_colorist_e5\nllama2_7b_qlora_lawyer_e3\nllama2_7b_qlora_medical_e1\nllama2_7b_qlora_moss_sft_all_e1\nllama2_7b_qlora_moss_sft_all_e2_gpu8\nllama2_7b_qlora_moss_sft_plugins_e1\nllama2_7b_qlora_msagent_react_e3_gpu8\nllama2_7b_qlora_oasst1_512_e3\nllama2_7b_qlora_oasst1_e3\nllama2_7b_qlora_open_platypus_e3\nllama2_7b_qlora_openorca_e1\nllama2_7b_qlora_sql_e3\nllama2_7b_qlora_tiny_codes_e1\nllama_7b_qlora_alpaca_e3\nllama_7b_qlora_alpaca_enzh_e3\nllama_7b_qlora_alpaca_enzh_oasst1_e3\nllama_7b_qlora_alpaca_zh_e3\nllama_7b_qlora_arxiv_gentitle_e3\nllama_7b_qlora_code_alpaca_e3\nllama_7b_qlora_colorist_e5\nllama_7b_qlora_lawyer_e3\nllama_7b_qlora_medical_e1\nllama_7b_qlora_moss_sft_all_e1\nllama_7b_qlora_moss_sft_all_e2_gpu8\nllama_7b_qlora_moss_sft_plugins_e1\nllama_7b_qlora_oasst1_512_e3\nllama_7b_qlora_oasst1_e3\nllama_7b_qlora_open_platypus_e3\nllama_7b_qlora_openorca_e1\nllama_7b_qlora_sql_e3\nllama_7b_qlora_tiny_codes_e1\nmistral_7b_qlora_skypile_pretrain_e1\nqwen_7b_chat_qlora_alpaca_e3\nqwen_7b_chat_qlora_alpaca_enzh_e3\nqwen_7b_chat_qlora_alpaca_enzh_oasst1_e3\nqwen_7b_chat_qlora_alpaca_zh_e3\nqwen_7b_chat_qlora_arxiv_gentitle_e3\nqwen_7b_chat_qlora_code_alpaca_e3\nqwen_7b_chat_qlora_colorist_e5\nqwen_7b_chat_qlora_lawyer_e3\nqwen_7b_chat_qlora_medical_e1\nqwen_7b_chat_qlora_oasst1_512_e3\nqwen_7b_chat_qlora_oasst1_e3\nqwen_7b_chat_qlora_open_platypus_e3\nqwen_7b_chat_qlora_openorca_e1\nqwen_7b_chat_qlora_sql_e3\nqwen_7b_chat_qlora_tiny_codes_e1\nqwen_7b_qlora_alpaca_e3\nqwen_7b_qlora_alpaca_enzh_e3\nqwen_7b_qlora_alpaca_enzh_oasst1_e3\nqwen_7b_qlora_alpaca_zh_e3\nqwen_7b_qlora_arxiv_gentitle_e3\nqwen_7b_qlora_code_alpaca_e3\nqwen_7b_qlora_colorist_e5\nqwen_7b_qlora_lawyer_e3\nqwen_7b_qlora_medical_e1\nqwen_7b_qlora_moss_sft_all_e1\nqwen_7b_qlora_moss_sft_all_e2_gpu8\nqwen_7b_qlora_moss_sft_plugins_e1\nqwen_7b_qlora_oasst1_512_e3\nqwen_7b_qlora_oasst1_e3\nqwen_7b_qlora_open_platypus_e3\nqwen_7b_qlora_openorca_e1\nqwen_7b_qlora_sql_e3\nqwen_7b_qlora_tiny_codes_e1\nstarcoder_qlora_stack_exchange_example\nyi_34b_qlora_alpaca_enzh_e3\nyi_6b_qlora_alpaca_enzh_e3\nzephyr_7b_beta_qlora_alpaca_e3\n=============================================================\n</code></pre> <ul> <li>\u62f7\u8d1d\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\u5230\u5f53\u524d\u76ee\u5f55\uff1a <pre><code>cd ~/ft-oasst1\nxtuner copy-cfg internlm_chat_7b_qlora_oasst1_e3 .\n</code></pre> </li> </ul>"},{"location":"chapter4/#2222","title":"2.2.2.2 \u6a21\u578b\u8bbe\u7f6e","text":"<ul> <li>\u8bbe\u7f6e\u8f6f\u94fe\u63a5</li> </ul> <p><pre><code>ln -s /share/temp/model_repos/internlm-chat-7b ~/ft-oasst1/\n</code></pre> </p>"},{"location":"chapter4/#2223","title":"2.2.2.3 \u6570\u636e\u96c6\u4e0b\u8f7d","text":"<p>\u6570\u636e\u96c6Huggingface\u5730\u5740</p> <ul> <li>\u4ece\u5f00\u53d1\u673ashare\u5730\u5740\u62f7\u8d1d\u5230ft-oasst1\u6587\u4ef6\u5939\u4e0b <pre><code>cd ~/ft-oasst1\n# ...-guanaco \u540e\u9762\u6709\u4e2a\u7a7a\u683c\u548c\u82f1\u6587\u53e5\u53f7\u554a\ncp -r /root/share/temp/datasets/openassistant-guanaco .\n</code></pre></li> </ul> <p></p>"},{"location":"chapter4/#2224","title":"2.2.2.4 \u4fee\u6539\u914d\u7f6e\u6587\u4ef6","text":"<ul> <li>\u4fee\u6539internlm_chat_7b_qlora_oasst1_e3_copy.py\u914d\u7f6e\u6587\u4ef6\u6a21\u578b\u53ca\u6570\u636e\u4e3a\u672c\u5730\u6a21\u578b\u53ca\u6570\u636e</li> </ul> <pre><code># pretrained_model_name_or_path = 'internlm/internlm-chat-7b'\npretrained_model_name_or_path = 'internlm/internlm-chat-7b'\n\n# Data\n# data_path = 'timdettmers/openassistant-guanaco'\ndata_path = './openassistant-guanaco'\n</code></pre> <p>\u4fee\u6539\u540e\u7684\u914d\u7f6e\u6587\u4ef6internlm_chat_7b_qlora_oasst1_e3_copy.py</p> internlm_chat_7b_qlora_oasst1_e3_copy.py <pre><code># Copyright (c) OpenMMLab. All rights reserved.\nimport torch\nfrom bitsandbytes.optim import PagedAdamW32bit\nfrom datasets import load_dataset\nfrom mmengine.dataset import DefaultSampler\nfrom mmengine.hooks import (CheckpointHook, DistSamplerSeedHook, IterTimerHook,\n                            LoggerHook, ParamSchedulerHook)\nfrom mmengine.optim import AmpOptimWrapper, CosineAnnealingLR\nfrom peft import LoraConfig\nfrom transformers import (AutoModelForCausalLM, AutoTokenizer,\n                          BitsAndBytesConfig)\n\nfrom xtuner.dataset import process_hf_dataset\nfrom xtuner.dataset.collate_fns import default_collate_fn\nfrom xtuner.dataset.map_fns import oasst1_map_fn, template_map_fn_factory\nfrom xtuner.engine import DatasetInfoHook, EvaluateChatHook\nfrom xtuner.model import SupervisedFinetune\nfrom xtuner.utils import PROMPT_TEMPLATE\n\n#######################################################################\n#                          PART 1  Settings                           #\n#######################################################################\n# Model\n# pretrained_model_name_or_path = 'internlm/internlm-chat-7b'\npretrained_model_name_or_path = './internlm-chat-7b'\n\n# Data\n# data_path = 'timdettmers/openassistant-guanaco'\ndata_path = './openassistant-guanaco'\nprompt_template = PROMPT_TEMPLATE.internlm_chat\nmax_length = 2048\npack_to_max_length = True\n\n# Scheduler &amp; Optimizer\nbatch_size = 1  # per_device\naccumulative_counts = 16\ndataloader_num_workers = 0\nmax_epochs = 3\noptim_type = PagedAdamW32bit\nlr = 2e-4\nbetas = (0.9, 0.999)\nweight_decay = 0\nmax_norm = 1  # grad clip\n\n# Evaluate the generation performance during the training\nevaluation_freq = 500\nSYSTEM = ''\nevaluation_inputs = [\n    '\u8bf7\u7ed9\u6211\u4ecb\u7ecd\u4e94\u4e2a\u4e0a\u6d77\u7684\u666f\u70b9', 'Please tell me five scenic spots in Shanghai'\n]\n\n#######################################################################\n#                      PART 2  Model &amp; Tokenizer                      #\n#######################################################################\ntokenizer = dict(\n    type=AutoTokenizer.from_pretrained,\n    pretrained_model_name_or_path=pretrained_model_name_or_path,\n    trust_remote_code=True,\n    padding_side='right')\n\nmodel = dict(\n    type=SupervisedFinetune,\n    llm=dict(\n        type=AutoModelForCausalLM.from_pretrained,\n        pretrained_model_name_or_path=pretrained_model_name_or_path,\n        trust_remote_code=True,\n        torch_dtype=torch.float16,\n        quantization_config=dict(\n            type=BitsAndBytesConfig,\n            load_in_4bit=True,\n            load_in_8bit=False,\n            llm_int8_threshold=6.0,\n            llm_int8_has_fp16_weight=False,\n            bnb_4bit_compute_dtype=torch.float16,\n            bnb_4bit_use_double_quant=True,\n            bnb_4bit_quant_type='nf4')),\n    lora=dict(\n        type=LoraConfig,\n        r=64,\n        lora_alpha=16,\n        lora_dropout=0.1,\n        bias='none',\n        task_type='CAUSAL_LM'))\n\n#######################################################################\n#                      PART 3  Dataset &amp; Dataloader                   #\n#######################################################################\ntrain_dataset = dict(\n    type=process_hf_dataset,\n    dataset=dict(type=load_dataset, path=data_path),\n    tokenizer=tokenizer,\n    max_length=max_length,\n    dataset_map_fn=oasst1_map_fn,\n    template_map_fn=dict(\n        type=template_map_fn_factory, template=prompt_template),\n    remove_unused_columns=True,\n    shuffle_before_pack=True,\n    pack_to_max_length=pack_to_max_length)\n\ntrain_dataloader = dict(\n    batch_size=batch_size,\n    num_workers=dataloader_num_workers,\n    dataset=train_dataset,\n    sampler=dict(type=DefaultSampler, shuffle=True),\n    collate_fn=dict(type=default_collate_fn))\n\n#######################################################################\n#                    PART 4  Scheduler &amp; Optimizer                    #\n#######################################################################\n# optimizer\noptim_wrapper = dict(\n    type=AmpOptimWrapper,\n    optimizer=dict(\n        type=optim_type, lr=lr, betas=betas, weight_decay=weight_decay),\n    clip_grad=dict(max_norm=max_norm, error_if_nonfinite=False),\n    accumulative_counts=accumulative_counts,\n    loss_scale='dynamic',\n    dtype='float16')\n\n# learning policy\n# More information: https://github.com/open-mmlab/mmengine/blob/main/docs/en/tutorials/param_scheduler.md  # noqa: E501\nparam_scheduler = dict(\n    type=CosineAnnealingLR,\n    eta_min=0.0,\n    by_epoch=True,\n    T_max=max_epochs,\n    convert_to_iter_based=True)\n\n# train, val, test setting\ntrain_cfg = dict(by_epoch=True, max_epochs=max_epochs, val_interval=1)\n\n#######################################################################\n#                           PART 5  Runtime                           #\n#######################################################################\n# Log the dialogue periodically during the training process, optional\ncustom_hooks = [\n    dict(type=DatasetInfoHook, tokenizer=tokenizer),\n    dict(\n        type=EvaluateChatHook,\n        tokenizer=tokenizer,\n        every_n_iters=evaluation_freq,\n        evaluation_inputs=evaluation_inputs,\n        system=SYSTEM,\n        prompt_template=prompt_template)\n]\n\n# configure default hooks\ndefault_hooks = dict(\n    # record the time of every iteration.\n    timer=dict(type=IterTimerHook),\n    # print log every 100 iterations.\n    logger=dict(type=LoggerHook, interval=10),\n    # enable the parameter scheduler.\n    param_scheduler=dict(type=ParamSchedulerHook),\n    # save checkpoint per epoch.\n    checkpoint=dict(type=CheckpointHook, interval=1),\n    # set sampler seed in distributed evrionment.\n    sampler_seed=dict(type=DistSamplerSeedHook),\n)\n\n# configure environment\nenv_cfg = dict(\n    # whether to enable cudnn benchmark\n    cudnn_benchmark=False,\n    # set multi process parameters\n    mp_cfg=dict(mp_start_method='fork', opencv_num_threads=0),\n    # set distributed parameters\n    dist_cfg=dict(backend='nccl'),\n)\n\n# set visualizer\nvisualizer = None\n\n# set log level\nlog_level = 'INFO'\n\n# load from which checkpoint\nload_from = None\n\n# whether to resume training from the loaded checkpoint\nresume = False\n\n# Defaults to use random seed and disable `deterministic`\nrandomness = dict(seed=None, deterministic=False)\n</code></pre>"},{"location":"chapter4/#2225","title":"2.2.2.5 \u5f00\u59cb\u5fae\u8c03","text":"<ul> <li>\u8bad\u7ec3</li> </ul> <pre><code># \u5355\u5361\n## \u7528\u521a\u624d\u6539\u597d\u7684config\u6587\u4ef6\u8bad\u7ec3\nxtuner train ./internlm_chat_7b_qlora_oasst1_e3_copy.py --deepspeed deepspeed_zero2\n</code></pre>"},{"location":"chapter4/#2226-pthlora","title":"2.2.2.6 \u8f6c\u6362PTH\u6a21\u578b\u4e3aLoRA\u6a21\u578b","text":"<pre><code>mkdir hf\nexport MKL_SERVICE_FORCE_INTEL=1\nexport MKL_THREADING_LAYER=GNU\nxtuner convert pth_to_hf ./internlm_chat_7b_qlora_oasst1_e3_copy.py ./work_dirs/internlm_chat_7b_qlora_oasst1_e3_copy/epoch_1.pth ./hf\n</code></pre>"},{"location":"chapter4/#223","title":"2.2.3 \u90e8\u7f72&amp;\u6d4b\u8bd5","text":""},{"location":"chapter4/#2231-hfadapter","title":"2.2.3.1 \u5408\u5e76hf\u7684adapter\u5230\u5927\u6a21\u578b","text":"<pre><code>xtuner convert merge ./internlm-chat-7b ./hf ./merged --max-shard-size 2GB\n</code></pre>"},{"location":"chapter4/#2232","title":"2.2.3.2 \u4e0e\u5408\u5e76\u540e\u7684\u6a21\u578b\u5bf9\u8bdd","text":"<pre><code>xtuner chat ./merged --prompt-template internlm_chat\n</code></pre>"},{"location":"chapter4/#2233-cli_demopy","title":"2.2.3.3 \u8fd0\u884c\u6d4b\u8bd5cli_demo.py","text":"<p>\u4fee\u6539\u6a21\u578b\u4e3a\u5408\u5e76\u540e\u7684\u6a21\u578b</p> <pre><code>import torch\nfrom transformers import AutoTokenizer, AutoModelForCausalLM\n\n\n# model_name_or_path = \"/root/model/Shanghai_AI_Laboratory/internlm-chat-7b\"\nmodel_name_or_path = \"/root/ft-oasst1/merged\"\n\ntokenizer = AutoTokenizer.from_pretrained(model_name_or_path, trust_remote_code=True)\nmodel = AutoModelForCausalLM.from_pretrained(model_name_or_path, trust_remote_code=True, torch_dtype=torch.bfloat16, device_map='auto')\nmodel = model.eval()\n\nsystem_prompt = \"\"\"You are an AI assistant whose name is InternLM (\u4e66\u751f\u00b7\u6d66\u8bed).\n- InternLM (\u4e66\u751f\u00b7\u6d66\u8bed) is a conversational language model that is developed by Shanghai AI Laboratory (\u4e0a\u6d77\u4eba\u5de5\u667a\u80fd\u5b9e\u9a8c\u5ba4). It is designed to be helpful, honest, and harmless.\n- InternLM (\u4e66\u751f\u00b7\u6d66\u8bed) can understand and communicate fluently in the language chosen by the user such as English and \u4e2d\u6587.\n\"\"\"\n\nmessages = [(system_prompt, '')]\n\nprint(\"=============Welcome to InternLM chatbot, type 'exit' to exit.=============\")\n\nwhile True:\n    input_text = input(\"User  &gt;&gt;&gt; \")\n    input_text.replace(' ', '')\n    if input_text == \"exit\":\n        break\n    response, history = model.chat(tokenizer, input_text, history=messages)\n    messages.append((input_text, response))\n    print(f\"robot &gt;&gt;&gt; {response}\")\n</code></pre> <p>\u8fd0\u884c\u793a\u4f8b\u811a\u672c <pre><code>python Tutorial/xtuner/cli_demo.py\n</code></pre></p> <p></p>"},{"location":"chapter4/#224-openxlab","title":"2.2.4 \u6a21\u578b&amp;\u5e94\u7528\u90e8\u7f72\u5230OpenXLab","text":"<p>Streamlit\u90e8\u7f72\u53c2\u8003\u6587\u6863</p> <p>gradio\u90e8\u7f72\u53c2\u8003\u6587\u6863</p>"},{"location":"chapter4/#225","title":"2.2.5 \u591a\u6a21\u6001\u5fae\u8c03","text":"<p>\u6587\u6863\u5730\u5740</p>"},{"location":"chapter4/#2251","title":"2.2.5.1 \u73af\u5883\u8bbe\u7f6e","text":"<ul> <li>\u521b\u5efa\u5f00\u53d1\u673a</li> </ul> <p>\u586b\u5199 \u5f00\u53d1\u673a\u540d\u79f0 \u540e\uff0c\u70b9\u51fb \u9009\u62e9\u955c\u50cf \u4f7f\u7528 Cuda11.7-conda \u955c\u50cf\uff0c\u7136\u540e\u5728\u8d44\u6e90\u914d\u7f6e\u4e2d\uff0c\u4f7f\u7528 50% A100 * 1 \u7684\u9009\u9879\uff0c\u7136\u540e\u7acb\u5373\u521b\u5efa\u5f00\u53d1\u673a\u5668\u3002 </p> <ul> <li>Xtuner\u5b89\u88c5</li> <li>conda\u73af\u5883\u5b89\u88c5</li> </ul> <pre><code>  cd ~ &amp;&amp; studio-conda xtuner0.1.17\n  # \u5982\u679c\u4f60\u662f\u5728\u5176\u4ed6\u5e73\u53f0\uff1a\n  # conda create --name xtuner0.1.17 python=3.10 -y\n</code></pre> <p></p> <ul> <li>\u6fc0\u6d3b\u73af\u5883</li> </ul> <pre><code># \u6fc0\u6d3b\u73af\u5883\nconda activate xtuner0.1.17\n</code></pre> <ul> <li>\u83b7\u53d6\u6e90\u7801&amp;\u5b89\u88c5 <pre><code># \u8fdb\u5165\u5bb6\u76ee\u5f55 \uff08~\u7684\u610f\u601d\u662f \u201c\u5f53\u524d\u7528\u6237\u7684home\u8def\u5f84\u201d\uff09\ncd ~\n# \u521b\u5efa\u7248\u672c\u6587\u4ef6\u5939\u5e76\u8fdb\u5165\nmkdir -p /root/xtuner0117 &amp;&amp; cd /root/xtuner0117\n\n# \u62c9\u53d6 0.1.17 \u7684\u7248\u672c\u6e90\u7801\ngit clone -b v0.1.17  https://github.com/InternLM/xtuner\n# \u65e0\u6cd5\u8bbf\u95eegithub\u7684\u7528\u6237\u8bf7\u4ece gitee \u62c9\u53d6:\n# git clone -b v0.1.15 https://gitee.com/Internlm/xtuner\n\n# \u8fdb\u5165\u6e90\u7801\u76ee\u5f55\ncd /root/xtuner0117/xtuner\n\n# \u4ece\u6e90\u7801\u5b89\u88c5 XTuner\npip install -e '.[all]' &amp;&amp; cd ~\n</code></pre></li> </ul> <p></p> <p></p>"},{"location":"chapter4/#2252","title":"2.2.5.2 \u9884\u8bad\u7ec3","text":"<p>\u63d0\u4f9b\u4e86Pretrain\u9636\u6bb5\u7684\u4ea7\u7269\u2014\u2014iter_2181.pth\u6587\u4ef6\u3002\u5b83\u5c31\u662f\u5e7c\u7a1a\u56ed\u9636\u6bb5\u7684Image Projector\uff01\u5927\u5bb6\u5e26\u7740iter_2181.pth\u6587\u4ef6\u7ee7\u7eed\u8fdb\u5165\u4e0b\u4e00\u9636\u6bb5\u8fdb\u884cFinetune\u5373\u53ef\u3002</p> <pre><code>share/new_models/xtuner/iter_2181.pth\n</code></pre> <p></p>"},{"location":"chapter4/#2253","title":"2.2.5.3 \u5fae\u8c03","text":"<ul> <li>\u683c\u5f0f\u793a\u610f</li> </ul> <pre><code>[\n  {\n    \"id\": \"000000033471\",\n    \"image\": \"coco/train2017/000000033471.jpg\",\n    \"conversations\": [\n      {\n        \"from\": \"human\",\n        \"value\": \"&lt;image&gt;\\nWhat are the colors of the bus in the image?\"\n      },\n      {\n        \"from\": \"gpt\",\n        \"value\": \"The bus in the image is white and red.\"\n      },\n      {\n        \"from\": \"human\",\n        \"value\": \"What feature can be seen on the back of the bus?\"\n      },\n      {\n        \"from\": \"gpt\",\n        \"value\": \"The back of the bus features an advertisement.\"\n      },\n      {\n        \"from\": \"human\",\n        \"value\": \"Is the bus driving down the street or pulled off to the side?\"\n      },\n      {\n        \"from\": \"gpt\",\n        \"value\": \"The bus is driving down the street, which is crowded with people and other vehicles.\"\n      }\n    ]\n  },\n  {\n    \"id\": \"000000052846\",\n    \"image\": \"coco/train2017/000000052846.jpg\",\n    \"conversations\": [\n      {\n        \"from\": \"human\",\n        \"value\": \"&lt;image&gt;\\nWhere is the cat positioned in the image?\"\n      },\n      {\n        \"from\": \"gpt\",\n        \"value\": \"The cat is positioned on top of the back of the couch in the living room.\"\n      }\n    ]\n  }\n ]\n ```\n\n - \u751f\u6210\u95ee\u7b54\u5bf9\u6570\u636e(repeat_data.json)\n\n ```bash\n cd ~ &amp;&amp; git clone https://github.com/InternLM/tutorial -b camp2 &amp;&amp; conda activate xtuner0.1.17 &amp;&amp; cd tutorial\n\npython /root/tutorial/xtuner/llava/llava_data/repeat.py \\\n  -i /root/tutorial/xtuner/llava/llava_data/unique_data.json \\\n  -o /root/tutorial/xtuner/llava/llava_data/repeated_data.json \\\n  -n 200\n  ```\n\n![alt text](image-213.png)\n\n- \u83b7\u53d6\u914d\u7f6e\u6587\u4ef6\n\n```bash\ncp /root/tutorial/xtuner/llava/llava_data/internlm2_chat_1_8b_llava_tutorial_fool_config.py /root/tutorial/xtuner/llava/llava_internlm2_chat_1_8b_qlora_clip_vit_large_p14_336_lora_e1_gpu8_finetune_copy.py\n</code></pre> <ul> <li>\u5f00\u59cb\u5fae\u8c03</li> </ul> <pre><code>cd /root/tutorial/xtuner/llava/\nxtuner train /root/tutorial/xtuner/llava/llava_internlm2_chat_1_8b_qlora_clip_vit_large_p14_336_lora_e1_gpu8_finetune_copy.py --deepspeed deepspeed_zero2\n</code></pre>"},{"location":"chapter4/#2254","title":"2.2.5.4 \u5fae\u8c03\u6a21\u578b\u5bf9\u8bdd","text":"<ul> <li>\u591a\u5361\u73af\u5883\u8bbe\u7f6e</li> </ul> <pre><code>export MKL_SERVICE_FORCE_INTEL=1\nexport MKL_THREADING_LAYER=GNU\n</code></pre> <ul> <li>pth\u8f6chuggingface</li> </ul> <pre><code>xtuner convert pth_to_hf \\\n  /root/tutorial/xtuner/llava/llava_internlm2_chat_1_8b_qlora_clip_vit_large_p14_336_lora_e1_gpu8_finetune_copy.py \\\n  /root/tutorial/xtuner/llava/work_dirs/llava_internlm2_chat_1_8b_qlora_clip_vit_large_p14_336_lora_e1_gpu8_finetune_copy/iter_1200.pth \\\n  /root/tutorial/xtuner/llava/llava_data/iter_1200_hf\n</code></pre> <ul> <li>chat</li> </ul> <pre><code>xtuner chat /root/share/new_models/Shanghai_AI_Laboratory/internlm2-chat-1_8b \\\n  --visual-encoder /root/share/new_models/openai/clip-vit-large-patch14-336 \\\n  --llava /root/tutorial/xtuner/llava/llava_data/iter_1200_hf \\\n  --prompt-template internlm2_chat \\\n  --image /root/tutorial/xtuner/llava/llava_data/test_img/oph.jpg\n</code></pre>"},{"location":"chapter4/#3","title":"3. \u89c6\u9891\u603b\u7ed3","text":""},{"location":"chapter5/","title":"\u8bfe\u65f6\u4e94 LMDeploy\u91cf\u5316\u90e8\u7f72LLM\u5b9e\u8df5","text":"<p>\u98de\u4e66\u5730\u5740</p> <p>\u7b97\u529b\u5e73\u53f0</p>"},{"location":"chapter5/#1","title":"1. \u63d0\u4ea4\u7684\u4f5c\u4e1a\u7ed3\u679c","text":"<p>\u4f5c\u4e1a\u8981\u6c42\u5730\u5740</p>"},{"location":"chapter5/#11","title":"1.1 \u57fa\u7840\u4f5c\u4e1a","text":""},{"location":"chapter5/#111-lmdeploy","title":"1.1.1 \u914d\u7f6e LMDeploy \u8fd0\u884c\u73af\u5883","text":"<ul> <li>\u7ed3\u679c\u622a\u56fe</li> </ul> <ul> <li>\u590d\u73b0\u6b65\u9aa4</li> </ul> <p>lmdeploy\u73af\u5883\u90e8\u7f72</p>"},{"location":"chapter5/#112-internlm2-chat-18b","title":"1.1.2 \u4ee5\u547d\u4ee4\u884c\u65b9\u5f0f\u4e0e InternLM2-Chat-1.8B \u6a21\u578b\u5bf9\u8bdd","text":"<ul> <li>\u7ed3\u679c\u622a\u56fe</li> </ul> <ul> <li>\u590d\u73b0\u6b65\u9aa4</li> </ul> <p>\u590d\u73b0\u6587\u6863</p>"},{"location":"chapter5/#12","title":"1.2 \u8fdb\u9636\u4f5c\u4e1a","text":""},{"location":"chapter5/#121-kv-cache04w4a16","title":"1.2.1 \u8bbe\u7f6eKV Cache\u6700\u5927\u5360\u7528\u6bd4\u4f8b\u4e3a0.4\uff0c\u5f00\u542fW4A16\u91cf\u5316\uff0c\u4ee5\u547d\u4ee4\u884c\u65b9\u5f0f\u4e0e\u6a21\u578b\u5bf9\u8bdd\u3002","text":"<ul> <li>\u7ed3\u679c\u622a\u56fe</li> </ul> <ul> <li>\u590d\u73b0\u6b65\u9aa4</li> </ul> <p>\u590d\u73b0\u6587\u6863</p>"},{"location":"chapter5/#122-api-server-lmdeploy-w4a16kv-cache04gradio","title":"1.2.2 \u4ee5API Server\u65b9\u5f0f\u542f\u52a8 lmdeploy\uff0c\u5f00\u542f W4A16\u91cf\u5316\uff0c\u8c03\u6574KV Cache\u7684\u5360\u7528\u6bd4\u4f8b\u4e3a0.4\uff0c\u5206\u522b\u4f7f\u7528\u547d\u4ee4\u884c\u5ba2\u6237\u7aef\u4e0eGradio\u7f51\u9875\u5ba2\u6237\u7aef\u4e0e\u6a21\u578b\u5bf9\u8bdd\u3002","text":"<ul> <li>\u7ed3\u679c\u622a\u56fe</li> <li> <p>\u547d\u4ee4\u884c  </p> </li> <li> <p>web\u7f51\u9875 </p> </li> <li> <p>\u590d\u73b0\u6b65\u9aa4 \u590d\u73b0\u6587\u6863</p> </li> </ul>"},{"location":"chapter5/#123-w4a16kv-cache04pythoninternlm2-chat-18b","title":"1.2.3 \u4f7f\u7528W4A16\u91cf\u5316\uff0c\u8c03\u6574KV Cache\u7684\u5360\u7528\u6bd4\u4f8b\u4e3a0.4\uff0c\u4f7f\u7528Python\u4ee3\u7801\u96c6\u6210\u7684\u65b9\u5f0f\u8fd0\u884cinternlm2-chat-1.8b\u6a21\u578b\u3002","text":"<ul> <li>\u7ed3\u679c\u622a\u56fe</li> </ul> <ul> <li>\u590d\u73b0\u6b65\u9aa4</li> </ul> <p>\u590d\u73b0\u6587\u6863</p>"},{"location":"chapter5/#124-lmdeploy-llava-gradio-demo","title":"1.2.4 \u4f7f\u7528 LMDeploy \u8fd0\u884c\u89c6\u89c9\u591a\u6a21\u6001\u5927\u6a21\u578b llava gradio demo\u3002","text":"<ul> <li>\u7ed3\u679c\u622a\u56fe</li> </ul> <ul> <li>\u590d\u73b0\u6b65\u9aa4</li> </ul> <p>\u590d\u73b0\u6587\u6863</p>"},{"location":"chapter5/#125-lmdeploy-web-demo-openxlab","title":"1.2.5 \u5c06 LMDeploy Web Demo \u90e8\u7f72\u5230 OpenXLab \u3002","text":"<ul> <li>\u7ed3\u679c\u622a\u56fe</li> <li>\u590d\u73b0\u6b65\u9aa4</li> </ul>"},{"location":"chapter5/#2","title":"2. \u6587\u6863\u590d\u73b0","text":"<p>\u6587\u6863\u5730\u5740</p>"},{"location":"chapter5/#21-lmdeploy","title":"2.1 LMDeploy\u73af\u5883\u90e8\u7f72","text":"<ul> <li>\u521b\u5efa\u5f00\u53d1\u673a</li> </ul> <p>\u9009\u62e9\u955c\u50cfCuda12.2-conda\uff1b\u9009\u62e910% A100*1GPU\uff1b\u70b9\u51fb\u201c\u7acb\u5373\u521b\u5efa\u201d\u3002</p> <p>\u6ce8\u610f   \u8bf7\u4e0d\u8981\u9009\u62e9Cuda11.7-conda\u7684\u955c\u50cf\uff0c\u65b0\u7248\u672c\u7684lmdeploy\u4f1a\u51fa\u73b0\u517c\u5bb9\u6027\u95ee\u9898\u3002</p> <p></p> <ul> <li>\u7ec8\u7aef\u6a21\u5f0f</li> </ul> <p>\u5207\u6362\u5230\u547d\u4ee4\u884c\u6a21\u5f0f\u3002</p> <p></p> <ul> <li>conda\u73af\u5883</li> </ul> <pre><code>studio-conda -t lmdeploy -o pytorch-2.1.2\n</code></pre> <p></p> <p></p> <ul> <li> <p>\u5b89\u88c5\u4f9d\u8d56</p> </li> <li> <p>\u6fc0\u6d3blmdeploy\u73af\u5883</p> </li> </ul> <pre><code>conda activate lmdeploy\n</code></pre> <ul> <li>\u5b89\u88c5\u4f9d\u8d56</li> </ul> <pre><code>pip install lmdeploy[all]==0.3.0\n</code></pre> <p></p> <p></p>"},{"location":"chapter5/#22-lmdeploychat","title":"2.2 LMDeploy\u6a21\u578b\u5bf9\u8bdd\uff08chat\uff09","text":"<ul> <li>internlm2-chat-1_8b\u6a21\u578b\u4e0b\u8f7d</li> </ul> <p>\u5f00\u53d1\u673a\u5df2\u6709\u6a21\u578b\u8f6f\u94fe\u63a5\u65b9\u5f0f\uff1a</p> <p><pre><code>ls\nls /root/share/new_models/Shanghai_AI_Laboratory/\nln -s /root/share/new_models/Shanghai_AI_Laboratory/internlm2-chat-1_8b /root/\nls\n</code></pre> </p> <ul> <li>\u76f4\u63a5\u5bf9\u8bdd\uff08\u7701\u7565Transform\u5bf9\u6bd4\u2014\u2014\u6211\u8981\u901f\u901a-_-` \uff09</li> </ul> <p><pre><code>lmdeploy chat /root/internlm2-chat-1_8b\n</code></pre> </p> <p></p> <p>\u786e\u5b9e\u5f88\u5feb \u6709\u79cdgrok\u7684\u611f\u89c9</p> <ul> <li>chat\u529f\u80fd\u53c2\u6570</li> </ul> <pre><code>lmdeploy chat -h\n</code></pre> <p></p>"},{"location":"chapter5/#23-lmdeploylite","title":"2.3 LMDeploy\u6a21\u578b\u91cf\u5316\uff08lite\uff09","text":""},{"location":"chapter5/#231","title":"2.3.1 \u91cf\u5316\u6982\u5ff5","text":"<ul> <li> <p>\u8ba1\u7b97\u5bc6\u96c6\uff08compute-bound\uff09: \u6307\u63a8\u7406\u8fc7\u7a0b\u4e2d\uff0c\u7edd\u5927\u90e8\u5206\u65f6\u95f4\u6d88\u8017\u5728\u6570\u503c\u8ba1\u7b97\u4e0a\uff1b\u9488\u5bf9\u8ba1\u7b97\u5bc6\u96c6\u578b\u573a\u666f\uff0c\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528\u66f4\u5feb\u7684\u786c\u4ef6\u8ba1\u7b97\u5355\u5143\u6765\u63d0\u5347\u8ba1\u7b97\u901f\u5ea6\u3002</p> </li> <li> <p>\u8bbf\u5b58\u5bc6\u96c6\uff08memory-bound\uff09: \u6307\u63a8\u7406\u8fc7\u7a0b\u4e2d\uff0c\u7edd\u5927\u90e8\u5206\u65f6\u95f4\u6d88\u8017\u5728\u6570\u636e\u8bfb\u53d6\u4e0a\uff1b\u9488\u5bf9\u8bbf\u5b58\u5bc6\u96c6\u578b\u573a\u666f\uff0c\u4e00\u822c\u901a\u8fc7\u51cf\u5c11\u8bbf\u5b58\u6b21\u6570\u3001\u63d0\u9ad8\u8ba1\u7b97\u8bbf\u5b58\u6bd4\u6216\u964d\u4f4e\u8bbf\u5b58\u91cf\u6765\u4f18\u5316\u3002</p> </li> <li> <p>\u5927\u6a21\u578b\u63a8\u7406\u662f\u8bbf\u5b58\u5bc6\u96c6\u578b\u573a\u666f\uff1a\u5e38\u89c1\u7684 LLM \u6a21\u578b\u7531\u4e8e Decoder Only \u67b6\u6784\u7684\u7279\u6027\uff0c\u5b9e\u9645\u63a8\u7406\u65f6\u5927\u591a\u6570\u7684\u65f6\u95f4\u90fd\u6d88\u8017\u5728\u4e86\u9010 Token \u751f\u6210\u9636\u6bb5\uff08Decoding \u9636\u6bb5\uff09\uff0c\u662f\u5178\u578b\u7684\u8bbf\u5b58\u5bc6\u96c6\u578b\u573a\u666f\u3002</p> </li> <li> <p>\u4f7f\u7528KV8\u91cf\u5316\u548cW4A16\u91cf\u5316\u5bf9\u5927\u6a21\u578b\u63a8\u7406\u8fdb\u884c\u4f18\u5316\uff1aKV8\u91cf\u5316\u662f\u6307\u5c06\u9010 Token\uff08Decoding\uff09\u751f\u6210\u8fc7\u7a0b\u4e2d\u7684\u4e0a\u4e0b\u6587 K \u548c V \u4e2d\u95f4\u7ed3\u679c\u8fdb\u884c INT8 \u91cf\u5316\uff08\u8ba1\u7b97\u65f6\u518d\u53cd\u91cf\u5316\uff09\uff0c\u4ee5\u964d\u4f4e\u751f\u6210\u8fc7\u7a0b\u4e2d\u7684\u663e\u5b58\u5360\u7528\u3002W4A16 \u91cf\u5316\uff0c\u5c06 FP16 \u7684\u6a21\u578b\u6743\u91cd\u91cf\u5316\u4e3a INT4\uff0cKernel \u8ba1\u7b97\u65f6\uff0c\u8bbf\u5b58\u91cf\u76f4\u63a5\u964d\u4e3a FP16 \u6a21\u578b\u7684 1/4\uff0c\u5927\u5e45\u964d\u4f4e\u4e86\u8bbf\u5b58\u6210\u672c\u3002Weight Only \u662f\u6307\u4ec5\u91cf\u5316\u6743\u91cd\uff0c\u6570\u503c\u8ba1\u7b97\u4f9d\u7136\u91c7\u7528 FP16\uff08\u9700\u8981\u5c06 INT4 \u6743\u91cd\u53cd\u91cf\u5316\uff09\u3002</p> </li> </ul>"},{"location":"chapter5/#232-kv-cache","title":"2.3.2 \u8bbe\u7f6e\u6700\u5927KV Cache\u7f13\u5b58\u5927\u5c0f","text":"<p>KV Cache\u662f\u4e00\u79cd\u7f13\u5b58\u6280\u672f\uff0c\u901a\u8fc7\u5b58\u50a8\u952e\u503c\u5bf9\u7684\u5f62\u5f0f\u6765\u590d\u7528\u8ba1\u7b97\u7ed3\u679c\uff0c\u4ee5\u8fbe\u5230\u63d0\u9ad8\u6027\u80fd\u548c\u964d\u4f4e\u5185\u5b58\u6d88\u8017\u7684\u76ee\u7684\u3002\u5728\u5927\u89c4\u6a21\u8bad\u7ec3\u548c\u63a8\u7406\u4e2d\uff0cKV Cache\u53ef\u4ee5\u663e\u8457\u51cf\u5c11\u91cd\u590d\u8ba1\u7b97\u91cf\uff0c\u4ece\u800c\u63d0\u5347\u6a21\u578b\u7684\u63a8\u7406\u901f\u5ea6\u3002\u7406\u60f3\u60c5\u51b5\u4e0b\uff0cKV Cache\u5168\u90e8\u5b58\u50a8\u4e8e\u663e\u5b58\uff0c\u4ee5\u52a0\u5feb\u8bbf\u5b58\u901f\u5ea6\u3002\u5f53\u663e\u5b58\u7a7a\u95f4\u4e0d\u8db3\u65f6\uff0c\u4e5f\u53ef\u4ee5\u5c06KV Cache\u653e\u5728\u5185\u5b58\uff0c\u901a\u8fc7\u7f13\u5b58\u7ba1\u7406\u5668\u63a7\u5236\u5c06\u5f53\u524d\u9700\u8981\u4f7f\u7528\u7684\u6570\u636e\u653e\u5165\u663e\u5b58\u3002</p> <p>\u6a21\u578b\u5728\u8fd0\u884c\u65f6\uff0c\u5360\u7528\u7684\u663e\u5b58\u53ef\u5927\u81f4\u5206\u4e3a\u4e09\u90e8\u5206\uff1a\u6a21\u578b\u53c2\u6570\u672c\u8eab\u5360\u7528\u7684\u663e\u5b58\u3001KV Cache\u5360\u7528\u7684\u663e\u5b58\uff0c\u4ee5\u53ca\u4e2d\u95f4\u8fd0\u7b97\u7ed3\u679c\u5360\u7528\u7684\u663e\u5b58\u3002LMDeploy\u7684KV Cache\u7ba1\u7406\u5668\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e--cache-max-entry-count\u53c2\u6570\uff0c\u63a7\u5236KV\u7f13\u5b58\u5360\u7528\u5269\u4f59\u663e\u5b58\u7684\u6700\u5927\u6bd4\u4f8b\u3002\u9ed8\u8ba4\u7684\u6bd4\u4f8b\u4e3a0.8\u3002</p> <ul> <li>\u8bbe\u7f6eKV Cache\u7f13\u5b58\u5927\u5c0f\u4e3a0.4</li> </ul> <pre><code>lmdeploy chat /root/internlm2-chat-1_8b --cache-max-entry-count 0.4\n</code></pre> <p>\u4f7f\u75280.4 kv cache\u7f13\u5b58\uff0c8G\u663e\u5b58\u5360\u7528\u91cf\u767e\u5206\u4e4b75 </p>"},{"location":"chapter5/#233-w4a16","title":"2.3.3 \u4f7f\u7528W4A16\u91cf\u5316","text":"<p>LMDeploy\u4f7f\u7528AWQ\u7b97\u6cd5\uff0c\u5b9e\u73b0\u6a21\u578b4bit\u6743\u91cd\u91cf\u5316\u3002</p> <ul> <li>\u4f9d\u8d56\u5e93\u5b89\u88c5</li> </ul> <pre><code>pip install einops==0.7.0\n</code></pre> <ul> <li>\u6267\u884c\u91cf\u5316</li> </ul> <pre><code>lmdeploy lite auto_awq \\\n   /root/internlm2-chat-1_8b \\\n  --calib-dataset 'ptb' \\\n  --calib-samples 128 \\\n  --calib-seqlen 1024 \\\n  --w-bits 4 \\\n  --w-group-size 128 \\\n  --work-dir /root/internlm2-chat-1_8b-4bit\n  ```\n\n```bash\nlmdeploy lite auto_awq \\  # lmdeploy\u5de5\u5177\u7684\u547d\u4ee4\uff0clite\u8868\u793a\u8f7b\u91cf\u7ea7\u6a21\u5f0f\uff0cauto_awq\u8868\u793a\u81ea\u52a8\u91cf\u5316\n/root/internlm2-chat-1_8b \\  # \u6307\u5b9a\u8981\u91cf\u5316\u7684\u8bed\u8a00\u6a21\u578b\u6587\u4ef6\u7684\u8def\u5f84\n  --calib-dataset 'ptb' \\  # \u6307\u5b9a\u7528\u4e8e\u91cf\u5316\u6821\u51c6\u7684\u6570\u636e\u96c6\u540d\u79f0\u4e3a'ptb'\n  --calib-samples 128 \\  # \u5728\u91cf\u5316\u6821\u51c6\u4e2d\u4f7f\u7528\u7684\u6837\u672c\u6570\u91cf\u4e3a128\u4e2a\n  --calib-seqlen 1024 \\  # \u5728\u91cf\u5316\u6821\u51c6\u4e2d\u4f7f\u7528\u7684\u5e8f\u5217\u957f\u5ea6\u4e3a1024\n  --w-bits 4 \\  # \u91cf\u5316\u65f6\u4f7f\u7528\u7684\u6743\u91cd\u4f4d\u6570\u4e3a4\u4f4d\n  --w-group-size 128 \\  # \u91cf\u5316\u65f6\u6bcf\u4e2a\u6743\u91cd\u7ec4\u7684\u5927\u5c0f\u4e3a128\n  --work-dir /root/internlm2-chat-1_8b-4bit  # \u6307\u5b9a\u91cf\u5316\u540e\u7684\u5de5\u4f5c\u76ee\u5f55\uff0c\u7528\u4e8e\u5b58\u653e\u91cf\u5316\u6a21\u578b\u548c\u5176\u4ed6\u76f8\u5173\u6587\u4ef6\n  ```\n\n  ![alt text](image-160.png)\n\n  ![alt text](image-161.png)\n\n  - \u4f7f\u7528\u91cf\u5316\u540e\u7684\u6a21\u578b\u5bf9\u8bdd\n\n```bash\nlmdeploy chat /root/internlm2-chat-1_8b-4bit --model-format awq\n</code></pre> <p>\u91cf\u5316\u540e\u663e\u5b58\u5360\u7528\u91cf\u4e3a\u767e\u5206\u4e4b90 </p> <ul> <li>\u8bbe\u7f6eKV Cache\u6700\u5927\u5360\u7528\u6bd4\u4f8b\u4e3a0.4\uff0c\u5f00\u542fW4A16\u91cf\u5316\uff0c\u4ee5\u547d\u4ee4\u884c\u65b9\u5f0f\u4e0e\u6a21\u578b\u5bf9\u8bdd\u3002</li> </ul> <p><pre><code>lmdeploy chat /root/internlm2-chat-1_8b-4bit --model-format awq --cache-max-entry-count 0.4\n</code></pre> \u91cf\u5316\u540e\u663e\u5b58\u5360\u7528\u91cf\u4e3a\u767e\u5206\u4e4b60\uff0c\u63a8\u7406\u56de\u590d\u901f\u5ea6\u8d3c\u5feb </p>"},{"location":"chapter5/#24-lmdeployserve","title":"2.4 LMDeploy\u670d\u52a1(serve)","text":""},{"location":"chapter5/#241-api","title":"2.4.1 \u542f\u52a8API\u670d\u52a1\u5668","text":"<ul> <li>\u5f00\u542f\u670d\u52a1</li> </ul> <pre><code>lmdeploy serve api_server \\\n    /root/internlm2-chat-1_8b \\\n    --model-format hf \\\n    --quant-policy 0 \\\n    --server-name 0.0.0.0 \\\n    --server-port 23333 \\\n    --tp 1\n</code></pre> <ul> <li>\u8bbf\u95ee\u670d\u52a1\u63a5\u53e3\u9875\u9762</li> </ul> <p>\u672c\u5730ssh\u8fde\u63a5</p> <p><pre><code>ssh -CNg -L 23333:127.0.0.1:23333 root@ssh.intern-ai.org.cn -p 48048 \n</code></pre> </p> <p></p> <ul> <li>\u5f00\u542f\u91cf\u5316\u6a21\u578b\u4f5c\u4e3a\u670d\u52a1</li> </ul> <p><pre><code>lmdeploy serve api_server \\\n/root/internlm2-chat-1_8b-4bit \\\n--model-format awq \\\n--cache-max-entry-count 0.4 \\\n--quant-policy 0 \\\n--server-name 0.0.0.0 \\\n--server-port 23333 \\\n--tp 1\n</code></pre> </p>"},{"location":"chapter5/#242-api-serve","title":"2.4.2 \u547d\u4ee4\u884c\u4e0eAPI Serve\u5bf9\u8bdd","text":"<p><pre><code>conda activate lmdeploy\nlmdeploy serve api_client http://localhost:23333\n</code></pre> </p>"},{"location":"chapter5/#243-webapi-serve","title":"2.4.3 web\u7f51\u9875\u4e0eAPI Serve\u5bf9\u8bdd","text":"<pre><code>lmdeploy serve gradio http://localhost:23333 \\\n    --server-name 0.0.0.0 \\\n    --server-port 6006\n</code></pre> <p>\u672c\u5730\u8fde\u63a5</p> <pre><code>ssh -CNg -L 6006:127.0.0.1:6006 root@ssh.intern-ai.org.cn -p 48048\n</code></pre> <p></p>"},{"location":"chapter5/#245-python","title":"2.4.5 Python\u4ee3\u7801\u65b9\u5f0f\u96c6\u6210\u91cf\u5316\u6a21\u578b","text":"<ul> <li>\u521b\u5efapython\u4ee3\u7801</li> </ul> <pre><code>conda activate lmdeploy\ntouch /root/pipeline_kv.py\n</code></pre> <ul> <li>\u7f16\u5199python\u4ee3\u7801</li> </ul> <p><pre><code>from lmdeploy import pipeline, TurbomindEngineConfig\n\n# \u8c03\u4f4e k/v cache\u5185\u5b58\u5360\u6bd4\u8c03\u6574\u4e3a\u603b\u663e\u5b58\u7684 40%\nbackend_config = TurbomindEngineConfig(cache_max_entry_count=0.4)\n\npipe = pipeline('/root/internlm2-chat-1_8b-4bit',\n                backend_config=backend_config)\nresponse = pipe(['Hi, pls intro yourself', '\u4e0a\u6d77\u662f'])\nprint(response)\n</code></pre> </p> <ul> <li>\u8fd0\u884cpython\u4ee3\u7801</li> </ul> <pre><code>python /root/pipeline_kv.py\n</code></pre> <p></p>"},{"location":"chapter5/#25-lmdeploy","title":"2.5 LMDeploy\u8fd0\u884c\u591a\u6a21\u6001\u5927\u6a21\u578b","text":""},{"location":"chapter5/#251","title":"2.5.1 \u8c03\u6574\u5f00\u53d1\u673a\u914d\u7f6e","text":"<ul> <li>\u5347\u7ea7GPU\u914d\u989d</li> </ul>"},{"location":"chapter5/#252","title":"2.5.2 \u73af\u5883\u642d\u5efa","text":"<ul> <li>\u6fc0\u6d3bconda\u73af\u5883</li> </ul> <pre><code>conda activate lmdeploy\n</code></pre> <ul> <li>\u5b89\u88c5\u6e90\u7801\u53ca\u4f9d\u8d56</li> </ul> <p><pre><code>pip install git+https://github.com/haotian-liu/LLaVA.git@4e2277a060da264c4f21b364c867cc622c945874\n</code></pre> </p>"},{"location":"chapter5/#253-llava","title":"2.5.3 \u521b\u5efa\u754c\u9762\u5316\u8fd0\u884cllava\u591a\u6a21\u6001","text":"<ul> <li>\u521b\u5efapython\u811a\u672c</li> </ul> <pre><code>touch /root/gradio_llava.py\n</code></pre> <ul> <li>\u586b\u5199python\u811a\u672c</li> </ul> <pre><code>import gradio as gr\nfrom lmdeploy import pipeline, TurbomindEngineConfig\n\n\nbackend_config = TurbomindEngineConfig(session_len=8192) # \u56fe\u7247\u5206\u8fa8\u7387\u8f83\u9ad8\u65f6\u8bf7\u8c03\u9ad8session_len\n# pipe = pipeline('liuhaotian/llava-v1.6-vicuna-7b', backend_config=backend_config) \u975e\u5f00\u53d1\u673a\u8fd0\u884c\u6b64\u547d\u4ee4\npipe = pipeline('/share/new_models/liuhaotian/llava-v1.6-vicuna-7b', backend_config=backend_config)\n\ndef model(image, text):\n    if image is None:\n        return [(text, \"\u8bf7\u4e0a\u4f20\u4e00\u5f20\u56fe\u7247\u3002\")]\n    else:\n        response = pipe((text, image)).text\n        return [(text, response)]\n\ndemo = gr.Interface(fn=model, inputs=[gr.Image(type=\"pil\"), gr.Textbox()], outputs=gr.Chatbot())\ndemo.launch()   \n</code></pre> <ul> <li>\u8fd0\u884cpython\u811a\u672c</li> </ul> <pre><code>python /root/gradio_llava.py\n</code></pre> <ul> <li>\u672c\u5730\u8fde\u63a5</li> </ul> <pre><code>ssh -CNg -L 7860:127.0.0.1:7860 root@ssh.intern-ai.org.cn -p 48048\n</code></pre> <ul> <li>\u672c\u5730\u8bbf\u95ee</li> </ul> <p>http://127.0.0.1:7860</p> <p></p> <p>\u591a\u6a21\u6001\u8fd8\u662f\u6218\u529b\u4e0d\u8db3\u554a</p>"},{"location":"chapter5/#26-openxlablmdeploy-web-demo","title":"2.6 \u5728OpenXLab\u90e8\u7f72LMDeploy web demo","text":"<p>\u6587\u6863\u5730\u5740</p> <p>OpenXLab</p> <p></p>"},{"location":"chapter5/#261","title":"2.6.1 \u521b\u5efa\u6a21\u578b\u4ed3\u5e93","text":""},{"location":"chapter5/#262","title":"2.6.2 \u521b\u5efa\u672c\u5730\u7a7a\u95f4","text":""},{"location":"chapter5/#263","title":"2.6.3 \u521b\u5efa\u4ee4\u724c","text":""},{"location":"chapter5/#264","title":"2.6.4 \u83b7\u53d6\u5927\u6a21\u578b","text":"<p>\u5927\u6a21\u578b\u5730\u5740</p> <pre><code>git lfs install\ngit clone https://code.openxlab.org.cn/OpenLMLab/internlm2-chat-7b.git\n</code></pre>"},{"location":"chapter5/#265","title":"2.6.5 \u4e0a\u4f20\u5927\u6a21\u578b","text":""},{"location":"chapter6/","title":"\u8bfe\u65f6\u516d Lagent &amp; AgentLego \u667a\u80fd\u4f53\u5e94\u7528\u642d\u5efa","text":"<p>\u98de\u4e66\u5730\u5740</p> <p>\u7b97\u529b\u5e73\u53f0</p>"},{"location":"chapter6/#1","title":"1. \u63d0\u4ea4\u7684\u4f5c\u4e1a\u7ed3\u679c","text":"<p>\u4f5c\u4e1a\u8981\u6c42\u5730\u5740</p>"},{"location":"chapter6/#11","title":"1.1 \u57fa\u7840\u4f5c\u4e1a","text":""},{"location":"chapter6/#111-lagent-web-demo","title":"1.1.1 \u5b8c\u6210 Lagent Web Demo \u4f7f\u7528\uff0c\u5e76\u5728\u4f5c\u4e1a\u4e2d\u4e0a\u4f20\u622a\u56fe\u3002","text":"<ul> <li>\u7ed3\u679c\u622a\u56fe</li> </ul> <ul> <li>\u590d\u73b0\u6b65\u9aa4</li> </ul> <p>\u590d\u73b0\u7b14\u8bb0</p>"},{"location":"chapter6/#112-agentlego","title":"1.1.2 \u5b8c\u6210 AgentLego \u76f4\u63a5\u4f7f\u7528\u90e8\u5206\uff0c\u5e76\u5728\u4f5c\u4e1a\u4e2d\u4e0a\u4f20\u622a\u56fe\u3002","text":"<ul> <li>\u7ed3\u679c\u622a\u56fe</li> </ul> <ul> <li>\u590d\u73b0\u6b65\u9aa4</li> </ul> <p>\u590d\u73b0\u7b14\u8bb0</p>"},{"location":"chapter6/#12","title":"1.2 \u8fdb\u9636\u4f5c\u4e1a","text":""},{"location":"chapter6/#121-agentlego-webui","title":"1.2.1 \u5b8c\u6210 AgentLego WebUI \u4f7f\u7528\uff0c\u5e76\u5728\u4f5c\u4e1a\u4e2d\u4e0a\u4f20\u622a\u56fe\u3002","text":"<ul> <li>\u7ed3\u679c\u622a\u56fe</li> </ul> <ul> <li>\u590d\u73b0\u6b65\u9aa4</li> </ul> <p>\u590d\u73b0\u6587\u6863</p>"},{"location":"chapter6/#122-lagent-agentlego","title":"1.2.2 \u4f7f\u7528 Lagent \u6216 AgentLego \u5b9e\u73b0\u81ea\u5b9a\u4e49\u5de5\u5177\u5e76\u5b8c\u6210\u8c03\u7528\uff0c\u5e76\u5728\u4f5c\u4e1a\u4e2d\u4e0a\u4f20\u622a\u56fe\u3002","text":"<ul> <li>\u7ed3\u679c\u622a\u56fe</li> </ul> <ul> <li>\u590d\u73b0\u6b65\u9aa4</li> </ul> <p>\u590d\u73b0\u6587\u6863</p>"},{"location":"chapter6/#2","title":"2. \u6587\u6863\u590d\u73b0","text":"<p>\u6587\u6863\u5730\u5740</p>"},{"location":"chapter6/#21","title":"2.1 \u5f00\u53d1\u73af\u5883\u8bbe\u7f6e","text":"<ul> <li>\u521b\u5efa\u5f00\u53d1\u673a</li> </ul> <p>\u5728\u521b\u5efa\u5f00\u53d1\u673a\u754c\u9762\u9009\u62e9\u955c\u50cf\u4e3a Cuda12.2-conda\uff0c\u5e76\u9009\u62e9 GPU \u4e3a30% A100\u3002</p> <p></p> <ul> <li>\u914d\u7f6e\u73af\u5883</li> </ul> <p>\u540c\u65f6\u6ee1\u8db3 Lagent \u548c AgentLego \u8fd0\u884c\u65f6\u6240\u9700\u4f9d\u8d56\u3002</p> <pre><code>#\u521b\u5efa\u4e00\u4e2a\u7528\u4e8e\u5b58\u653e Agent \u76f8\u5173\u6587\u4ef6\u7684\u76ee\u5f55\nmkdir -p /root/agent\nstudio-conda -t agent -o pytorch-2.1.2\n</code></pre> <p></p> <p></p> <ul> <li>\u5b89\u88c5 Lagent \u548c AgentLego</li> </ul> <pre><code>cd /root/agent\nconda activate agent\ngit clone https://gitee.com/internlm/lagent.git\ncd lagent &amp;&amp; git checkout 581d9fb &amp;&amp; pip install -e . &amp;&amp; cd ..\ngit clone https://gitee.com/internlm/agentlego.git\ncd agentlego &amp;&amp; git checkout 7769e0d &amp;&amp; pip install -e . &amp;&amp; cd ..\n</code></pre> <p></p> <p></p> <ul> <li>\u5b89\u88c5\u4f9d\u8d56</li> </ul> <pre><code>conda activate agent\npip install lmdeploy==0.3.0\n</code></pre> <p></p> <ul> <li>\u83b7\u53d6\u6848\u4f8b\u6e90\u7801</li> </ul> <pre><code>cd /root/agent\ngit clone -b camp2 https://gitee.com/internlm/Tutorial.git\n</code></pre> <p></p>"},{"location":"chapter6/#22-lagent-web-demo","title":"2.2 Lagent Web Demo","text":"<p>\u6587\u6863\u5730\u5740</p>"},{"location":"chapter6/#221","title":"2.2.1 \u90e8\u7f72\u670d\u52a1","text":"<ul> <li>\u542f\u52a8api_server</li> </ul> <pre><code>conda activate agent\n\nlmdeploy serve api_server /root/share/new_models/Shanghai_AI_Laboratory/internlm2-chat-7b  --server-name 127.0.0.1  --model-name nternlm2-chat-7b   --cache-max-entry-count 0.1\n</code></pre>"},{"location":"chapter6/#222-web","title":"2.2.2 \u542f\u52a8web\u6848\u4f8b","text":"<p><pre><code>conda activate agent\ncd /root/agent/lagent/examples\nstreamlit run internlm2_agent_web_demo.py --server.address 127.0.0.1 --server.port 7860\n</code></pre> </p>"},{"location":"chapter6/#223","title":"2.2.3 \u672c\u5730\u8bbf\u95ee","text":"<ul> <li>\u672c\u5730\u6253\u5f00cmd\u547d\u4ee4\u884c </li> </ul> <pre><code>ssh -CNg -L 7860:127.0.0.1:7860 -L 23333:127.0.0.1:23333 root@ssh.intern-ai.org.cn -p 48061\n</code></pre> <ul> <li>\u672c\u5730\u8bbf\u95ee\u94fe\u63a5</li> </ul> <p><pre><code>http://localhost:7860/\n</code></pre> </p> <ul> <li>\u6682\u65f6\u62a5\u9519</li> </ul> <p></p>"},{"location":"chapter6/#23-agentlego","title":"2.3 \u76f4\u63a5\u4f7f\u7528 AgentLego","text":""},{"location":"chapter6/#231","title":"2.3.1 \u6587\u4ef6\u83b7\u53d6","text":"<ul> <li>\u83b7\u53d6\u56fe\u7247</li> </ul> <pre><code>cd /root/agent\nwget http://download.openmmlab.com/agentlego/road.jpg\n</code></pre>"},{"location":"chapter6/#232","title":"2.3.2 \u73af\u5883\u4f9d\u8d56","text":"<p>AgentLego \u6240\u5b9e\u73b0\u7684\u76ee\u6807\u68c0\u6d4b\u5de5\u5177\u662f\u57fa\u4e8e mmdet (MMDetection) \u7b97\u6cd5\u5e93\u4e2d\u7684 RTMDet-Large \u6a21\u578b\uff0c\u56e0\u6b64\u6211\u4eec\u9996\u5148\u5b89\u88c5 mim\uff0c\u7136\u540e\u901a\u8fc7 mim \u5de5\u5177\u6765\u5b89\u88c5 mmdet\u3002</p> <pre><code>conda activate agent\npip install openmim==0.3.9\nmim install mmdet==3.3.0\n</code></pre> <p></p> <p></p>"},{"location":"chapter6/#233","title":"2.3.3 \u4ee3\u7801\u68c0\u6d4b","text":"<ul> <li>\u521b\u5efa\u4ee3\u7801</li> </ul> <p>\u901a\u8fc7 touch /root/agent/direct_use.py\uff08\u5927\u5c0f\u5199\u654f\u611f\uff09\u7684\u65b9\u5f0f\u5728 /root/agent \u76ee\u5f55\u4e0b\u65b0\u5efa direct_use.py \u4ee5\u76f4\u63a5\u4f7f\u7528\u76ee\u6807\u68c0\u6d4b\u5de5\u5177\u3002 <pre><code>touch /root/agent/direct_use.py\n</code></pre></p> <ul> <li>\u7f16\u5199\u4ee3\u7801</li> </ul> <p>direct_use.py \u7684\u4ee3\u7801\u5982\u4e0b\uff1a</p> <pre><code>  import re\n\nimport cv2\nfrom agentlego.apis import load_tool\n\n# load tool\ntool = load_tool('ObjectDetection', device='cuda')\n\n# apply tool\nvisualization = tool('/root/agent/road.jpg')\nprint(visualization)\n\n# visualize\nimage = cv2.imread('/root/agent/road.jpg')\n\npreds = visualization.split('\\n')\npattern = r'(\\w+) \\((\\d+), (\\d+), (\\d+), (\\d+)\\), score (\\d+)'\n\nfor pred in preds:\n    name, x1, y1, x2, y2, score = re.match(pattern, pred).groups()\n    x1, y1, x2, y2, score = int(x1), int(y1), int(x2), int(y2), int(score)\n    cv2.rectangle(image, (x1, y1), (x2, y2), (0, 255, 0), 1)\n    cv2.putText(image, f'{name} {score}', (x1, y1), cv2.FONT_HERSHEY_SIMPLEX, 0.8, (0, 255, 0), 1)\n\ncv2.imwrite('/root/agent/road_detection_direct.jpg', image)\n</code></pre> <p></p> <ul> <li>\u6267\u884c\u4ee3\u7801</li> </ul> <pre><code>python /root/agent/direct_use.py\n</code></pre> <p></p> <ul> <li>\u6267\u884c\u7ed3\u679c</li> </ul> <p>/root/agent \u540d\u4e3a road_detection_direct.jpg \u7684\u56fe\u7247</p> <p></p>"},{"location":"chapter6/#24-agentlego-webui","title":"2.4 AgentLego WebUI","text":"<p>\u6587\u6863\u5730\u5740</p>"},{"location":"chapter6/#241","title":"2.4.1 \u4fee\u6539\u6a21\u578b\u8c03\u7528\u811a\u672c","text":"<p>\u4fee\u6539 /root/agent/agentlego/webui/modules/agents/lagent_agent.py \u6587\u4ef6\u7684\u7b2c 105\u884c\u4f4d\u7f6e\uff0c\u5c06 internlm2-chat-20b \u4fee\u6539\u4e3a internlm2-chat-7b</p> <p></p>"},{"location":"chapter6/#242-lmdeploy","title":"2.4.2 LMDeploy\u90e8\u7f72\u670d\u52a1","text":"<p>\u4f7f\u7528 LMDeploy \u542f\u52a8\u4e00\u4e2a api_server\u3002</p> <p><pre><code>conda activate agent\nlmdeploy serve api_server /root/share/new_models/Shanghai_AI_Laboratory/internlm2-chat-7b \\\n                            --server-name 127.0.0.1 \\\n                            --model-name internlm2-chat-7b \\\n                            --cache-max-entry-count 0.1\n</code></pre> </p>"},{"location":"chapter6/#243-agentlego-webui","title":"2.4.3 \u542f\u52a8 AgentLego WebUI","text":"<p>\u65b0\u5efa\u4e00\u4e2a terminal \u4ee5\u542f\u52a8 AgentLego WebUI</p> <pre><code>conda activate agent\ncd /root/agent/agentlego/webui\npython one_click.py\n</code></pre> <ul> <li>\u672c\u5730\u8fde\u63a5</li> </ul> <pre><code>ssh -CNg -L 7860:127.0.0.1:7860 -L 23333:127.0.0.1:23333 root@ssh.intern-ai.org.cn -p 48061 \n</code></pre> <p></p>"},{"location":"chapter6/#244-agentlego-webui","title":"2.4.4 \u4f7f\u7528 AgentLego WebUI","text":"<ul> <li>\u9009\u62e9Agent Tag\u9875</li> </ul> <ul> <li>\u4e0b\u62c9\u9009\u62e9New Agent</li> </ul> <ul> <li>\u9009\u62e9 Agent Class \u4e3a lagent.InternLM2Agent</li> </ul> <ul> <li> <p>\u8f93\u5165 Agent name\uff0c\u81ea\u5b9a\u4e49\u5373\u53ef\uff0c\u56fe\u4e2d\u8f93\u5165\u4e86acondess</p> </li> <li> <p>\u70b9\u51fb save to \u4ee5\u4fdd\u5b58\u914d\u7f6e\uff0c\u8fd9\u6837\u5728\u4e0b\u6b21\u4f7f\u7528\u65f6\u53ea\u9700\u5728\u7b2c2\u6b65\u65f6\u9009\u62e9 Agent \u4e3a internlm2 \u540e\u70b9\u51fb load \u4ee5\u52a0\u8f7d\u5c31\u53ef\u4ee5\u4e86\u3002</p> </li> </ul> <p></p> <ul> <li>\u70b9\u51fbLoad \u52a0\u8f7dAgent</li> </ul> <p></p> <ul> <li>\u914d\u7f6e\u5de5\u5177</li> </ul> <p></p> <ul> <li>\u52a0\u8f7d\u5b8c\u6210</li> </ul> <p></p> <ul> <li>\u5bf9\u8bdd</li> </ul> <p>\u7b49\u5f85\u5de5\u5177\u52a0\u8f7d\u5b8c\u6210\u540e\uff0c\u70b9\u51fb\u4e0a\u65b9 Chat \u4ee5\u8fdb\u5165\u5bf9\u8bdd\u9875\u9762\u3002\u5728\u9875\u9762\u4e0b\u65b9\u9009\u62e9\u5de5\u5177\u90e8\u5206\u53ea\u9009\u62e9 ObjectDetection \u5de5\u5177\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002\u4e3a\u4e86\u786e\u4fdd\u8c03\u7528\u5de5\u5177\u7684\u6210\u529f\u7387\uff0c\u8bf7\u5728\u4f7f\u7528\u65f6\u786e\u4fdd\u4ec5\u6709\u8fd9\u4e00\u4e2a\u5de5\u5177\u542f\u7528\u3002</p> <p></p> <ul> <li>\u4e0a\u4f20\u56fe\u7247\uff0c\u8f93\u5165\u68c0\u6d4b\u8981\u6c42</li> </ul> <p></p>"},{"location":"chapter6/#25-agentlego","title":"2.5 AgentLego \u81ea\u5b9a\u4e49\u5de5\u5177","text":"<p>\u5b9e\u73b0\u4e00\u4e2a\u8c03\u7528 MagicMaker \u7684 API \u4ee5\u5b9e\u73b0\u56fe\u50cf\u751f\u6210\u7684\u5de5\u5177,\u63d0\u4f9b\u56fe\u50cf\u751f\u6210\u3001\u56fe\u50cf\u7f16\u8f91\u548c\u89c6\u9891\u751f\u6210\u3002</p> <p>MagicMaker\u5730\u5740</p>"},{"location":"chapter6/#251","title":"2.5.1 \u521b\u5efa\u5de5\u5177\u6587\u4ef6","text":"<ul> <li>\u65b0\u5efapython\u811a\u672c</li> </ul> <pre><code>touch /root/agent/agentlego/agentlego/tools/magicmaker_image_generation.py\n</code></pre> <ul> <li>\u7f16\u5199python\u811a\u672c</li> </ul> <pre><code>import json\nimport requests\n\nimport numpy as np\n\nfrom agentlego.types import Annotated, ImageIO, Info\nfrom agentlego.utils import require\nfrom .base import BaseTool\n\n\nclass MagicMakerImageGeneration(BaseTool):\n\n    default_desc = ('This tool can call the api of magicmaker to '\n                    'generate an image according to the given keywords.')\n\n    styles_option = [\n        'dongman',  # \u52a8\u6f2b\n        'guofeng',  # \u56fd\u98ce\n        'xieshi',   # \u5199\u5b9e\n        'youhua',   # \u6cb9\u753b\n        'manghe',   # \u76f2\u76d2\n    ]\n    aspect_ratio_options = [\n        '16:9', '4:3', '3:2', '1:1',\n        '2:3', '3:4', '9:16'\n    ]\n\n    @require('opencv-python')\n    def __init__(self,\n                 style='guofeng',\n                 aspect_ratio='4:3'):\n        super().__init__()\n        if style in self.styles_option:\n            self.style = style\n        else:\n            raise ValueError(f'The style must be one of {self.styles_option}')\n\n        if aspect_ratio in self.aspect_ratio_options:\n            self.aspect_ratio = aspect_ratio\n        else:\n            raise ValueError(f'The aspect ratio must be one of {aspect_ratio}')\n\n    def apply(self,\n              keywords: Annotated[str,\n                                  Info('A series of Chinese keywords separated by comma.')]\n        ) -&gt; ImageIO:\n        import cv2\n        response = requests.post(\n            url='https://magicmaker.openxlab.org.cn/gw/edit-anything/api/v1/bff/sd/generate',\n            data=json.dumps({\n                \"official\": True,\n                \"prompt\": keywords,\n                \"style\": self.style,\n                \"poseT\": False,\n                \"aspectRatio\": self.aspect_ratio\n            }),\n            headers={'content-type': 'application/json'}\n        )\n        image_url = response.json()['data']['imgUrl']\n        image_response = requests.get(image_url)\n        image = cv2.cvtColor(cv2.imdecode(np.frombuffer(image_response.content, np.uint8), cv2.IMREAD_COLOR),cv2.COLOR_BGR2RGB)\n        return ImageIO(image)\n</code></pre>"},{"location":"chapter6/#252","title":"2.5.2 \u6ce8\u518c\u65b0\u5de5\u5177","text":"<p>\u4fee\u6539 /root/agent/agentlego/agentlego/tools/init.py \u6587\u4ef6\uff0c\u5c06\u6211\u4eec\u7684\u5de5\u5177\u6ce8\u518c\u5728\u5de5\u5177\u5217\u8868\u4e2d\u3002</p> <p>\u5c06 MagicMakerImageGeneration \u901a\u8fc7 from .magicmaker_image_generation import MagicMakerImageGeneration \u5bfc\u5165\u5230\u4e86\u6587\u4ef6\u4e2d\uff0c\u5e76\u4e14\u5c06\u5176\u52a0\u5165\u4e86 all \u5217\u8868\u4e2d\u3002</p> <p></p> <pre><code>from .base import BaseTool\nfrom .calculator import Calculator\nfrom .func import make_tool\nfrom .image_canny import CannyTextToImage, ImageToCanny\nfrom .image_depth import DepthTextToImage, ImageToDepth\nfrom .image_editing import ImageExpansion, ImageStylization, ObjectRemove, ObjectReplace\nfrom .image_pose import HumanBodyPose, HumanFaceLandmark, PoseToImage\nfrom .image_scribble import ImageToScribble, ScribbleTextToImage\nfrom .image_text import ImageDescription, TextToImage\nfrom .imagebind import AudioImageToImage, AudioTextToImage, AudioToImage, ThermalToImage\nfrom .object_detection import ObjectDetection, TextToBbox\nfrom .ocr import OCR\nfrom .scholar import *  # noqa: F401, F403\nfrom .search import BingSearch, GoogleSearch\nfrom .segmentation import SegmentAnything, SegmentObject, SemanticSegmentation\nfrom .speech_text import SpeechToText, TextToSpeech\nfrom .translation import Translation\nfrom .vqa import VQA\n\nfrom .magicmaker_image_generation import MagicMakerImageGeneration\n\n__all__ = [\n    'CannyTextToImage', 'ImageToCanny', 'DepthTextToImage', 'ImageToDepth',\n    'ImageExpansion', 'ObjectRemove', 'ObjectReplace', 'HumanFaceLandmark',\n    'HumanBodyPose', 'PoseToImage', 'ImageToScribble', 'ScribbleTextToImage',\n    'ImageDescription', 'TextToImage', 'VQA', 'ObjectDetection', 'TextToBbox', 'OCR',\n    'SegmentObject', 'SegmentAnything', 'SemanticSegmentation', 'ImageStylization',\n    'AudioToImage', 'ThermalToImage', 'AudioImageToImage', 'AudioTextToImage',\n    'SpeechToText', 'TextToSpeech', 'Translation', 'GoogleSearch', 'Calculator',\n    'BaseTool', 'make_tool', 'BingSearch','MagicMakerImageGeneration',\n]\n</code></pre>"},{"location":"chapter6/#253","title":"2.5.3 \u542f\u52a8\u81ea\u5b9a\u4e49\u5de5\u5177","text":"<p>\u5728\u4e24\u4e2a terminal \u4e2d\u5206\u522b\u542f\u52a8 LMDeploy \u670d\u52a1\u548c AgentLego \u7684 WebUI \u4ee5\u4f53\u9a8c\u6211\u4eec\u81ea\u5b9a\u4e49\u7684\u5de5\u5177\u7684\u6548\u679c\u3002</p> <ul> <li>\u542f\u52a8 LMDeploy \u670d\u52a1</li> </ul> <pre><code>conda activate agent\nlmdeploy serve api_server /root/share/new_models/Shanghai_AI_Laboratory/internlm2-chat-7b \\\n                            --server-name 127.0.0.1 \\\n                            --model-name internlm2-chat-7b \\\n                            --cache-max-entry-count 0.1\n</code></pre> <ul> <li>\u542f\u52a8 AgentLego \u670d\u52a1</li> </ul> <p><pre><code>conda activate agent\ncd /root/agent/agentlego/webui\npython one_click.py\n</code></pre> </p> <ul> <li>\u672c\u5730\u8fde\u63a5</li> </ul> <pre><code>ssh -CNg -L 7860:127.0.0.1:7860 -L 23333:127.0.0.1:23333 root@ssh.intern-ai.org.cn -p 48061 \n</code></pre> <ul> <li>\u8bbe\u7f6eTools</li> </ul> <p>Tool class \u9009\u62e9MagicMakerImageGeneration\u5e76\u70b9\u51fbsave</p> <p></p>"},{"location":"chapter6/#254","title":"2.5.4 \u5e94\u7528\u7ed3\u679c","text":"<ul> <li>\u9009\u62e9\u81ea\u5b9a\u4e49tools</li> </ul> <ul> <li>\u8f93\u5165\u6587\u5b57\u8981\u6c42</li> </ul>"},{"location":"chapter7/","title":"\u8bfe\u65f6\u4e03 OpenCompass \u5927\u6a21\u578b\u6d4b\u8bc4","text":"<p>\u98de\u4e66\u5730\u5740</p> <p>\u7b97\u529b\u5e73\u53f0</p>"},{"location":"chapter7/#1","title":"1. \u63d0\u4ea4\u7684\u4f5c\u4e1a\u7ed3\u679c","text":"<p>\u4f5c\u4e1a\u8981\u6c42\u5730\u5740</p>"},{"location":"chapter7/#11","title":"1.1 \u57fa\u7840\u4f5c\u4e1a","text":""},{"location":"chapter7/#111-opencompass-internlm2-chat-1_8b-c-eval","title":"1.1.1 \u4f7f\u7528 OpenCompass \u8bc4\u6d4b internlm2-chat-1_8b \u6a21\u578b\u5728 C-Eval \u6570\u636e\u96c6\u4e0a\u7684\u6027\u80fd","text":"<ul> <li>\u7ed3\u679c\u622a\u56fe  </li> </ul> <ul> <li> <p>\u590d\u73b0\u6b65\u9aa4</p> <p>\u590d\u73b0\u6587\u6863</p> </li> </ul>"},{"location":"chapter7/#12","title":"1.2 \u8fdb\u9636\u4f5c\u4e1a","text":""},{"location":"chapter7/#121-opencompass","title":"1.2.1 \u5c06\u81ea\u5b9a\u4e49\u6570\u636e\u96c6\u63d0\u4ea4\u81f3OpenCompass\u5b98\u7f51","text":"<ul> <li> <p>\u7ed3\u679c\u622a\u56fe</p> </li> <li> <p>\u590d\u73b0\u6b65\u9aa4</p> </li> </ul>"},{"location":"chapter7/#2","title":"2. \u6587\u6863\u590d\u73b0","text":"<p>\u6587\u6863\u5730\u5740</p> <p>\u5728 OpenCompass \u4e2d\u8bc4\u4f30\u4e00\u4e2a\u6a21\u578b\u901a\u5e38\u5305\u62ec\u4ee5\u4e0b\u51e0\u4e2a\u9636\u6bb5\uff1a\u914d\u7f6e -&gt; \u63a8\u7406 -&gt; \u8bc4\u4f30 -&gt; \u53ef\u89c6\u5316\u3002</p> <ul> <li>\u914d\u7f6e\uff1a\u8fd9\u662f\u6574\u4e2a\u5de5\u4f5c\u6d41\u7684\u8d77\u70b9\u3002\u60a8\u9700\u8981\u914d\u7f6e\u6574\u4e2a\u8bc4\u4f30\u8fc7\u7a0b\uff0c\u9009\u62e9\u8981\u8bc4\u4f30\u7684\u6a21\u578b\u548c\u6570\u636e\u96c6\u3002\u6b64\u5916\uff0c\u8fd8\u53ef\u4ee5\u9009\u62e9\u8bc4\u4f30\u7b56\u7565\u3001\u8ba1\u7b97\u540e\u7aef\u7b49\uff0c\u5e76\u5b9a\u4e49\u663e\u793a\u7ed3\u679c\u7684\u65b9\u5f0f\u3002</li> <li>\u63a8\u7406\u4e0e\u8bc4\u4f30\uff1a\u5728\u8fd9\u4e2a\u9636\u6bb5\uff0cOpenCompass \u5c06\u4f1a\u5f00\u59cb\u5bf9\u6a21\u578b\u548c\u6570\u636e\u96c6\u8fdb\u884c\u5e76\u884c\u63a8\u7406\u548c\u8bc4\u4f30\u3002\u63a8\u7406\u9636\u6bb5\u4e3b\u8981\u662f\u8ba9\u6a21\u578b\u4ece\u6570\u636e\u96c6\u4ea7\u751f\u8f93\u51fa\uff0c\u800c\u8bc4\u4f30\u9636\u6bb5\u5219\u662f\u8861\u91cf\u8fd9\u4e9b\u8f93\u51fa\u4e0e\u6807\u51c6\u7b54\u6848\u7684\u5339\u914d\u7a0b\u5ea6\u3002\u8fd9\u4e24\u4e2a\u8fc7\u7a0b\u4f1a\u88ab\u62c6\u5206\u4e3a\u591a\u4e2a\u540c\u65f6\u8fd0\u884c\u7684\u201c\u4efb\u52a1\u201d\u4ee5\u63d0\u9ad8\u6548\u7387\uff0c\u4f46\u8bf7\u6ce8\u610f\uff0c\u5982\u679c\u8ba1\u7b97\u8d44\u6e90\u6709\u9650\uff0c\u8fd9\u79cd\u7b56\u7565\u53ef\u80fd\u4f1a\u4f7f\u8bc4\u6d4b\u53d8\u5f97\u66f4\u6162\u3002\u5982\u679c\u9700\u8981\u4e86\u89e3\u8be5\u95ee\u9898\u53ca\u89e3\u51b3\u65b9\u6848\uff0c\u53ef\u4ee5\u53c2\u8003 FAQ: \u6548\u7387\u3002</li> <li>\u53ef\u89c6\u5316\uff1a\u8bc4\u4f30\u5b8c\u6210\u540e\uff0cOpenCompass \u5c06\u7ed3\u679c\u6574\u7406\u6210\u6613\u8bfb\u7684\u8868\u683c\uff0c\u5e76\u5c06\u5176\u4fdd\u5b58\u4e3a CSV \u548c TXT \u6587\u4ef6\u3002\u4f60\u4e5f\u53ef\u4ee5\u6fc0\u6d3b\u98de\u4e66\u72b6\u6001\u4e0a\u62a5\u529f\u80fd\uff0c\u6b64\u540e\u53ef\u4ee5\u5728\u98de\u4e66\u5ba2\u6237\u7aef\u4e2d\u53ca\u65f6\u83b7\u5f97\u8bc4\u6d4b\u72b6\u6001\u62a5\u544a\u3002 \u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u5c55\u793a OpenCompass \u7684\u57fa\u7840\u7528\u6cd5\uff0c\u5c55\u793a\u4e66\u751f\u6d66\u8bed\u5728 C-Eval \u57fa\u51c6\u4efb\u52a1\u4e0a\u7684\u8bc4\u4f30\u3002\u5b83\u4eec\u7684\u914d\u7f6e\u6587\u4ef6\u53ef\u4ee5\u5728 configs/eval_demo.py \u4e2d\u627e\u5230\u3002</li> </ul>"},{"location":"chapter7/#21","title":"2.1 \u73af\u5883\u914d\u7f6e","text":""},{"location":"chapter7/#211","title":"2.1.1 \u5f00\u53d1\u673a\u521b\u5efa","text":"<p>\u5728\u521b\u5efa\u5f00\u53d1\u673a\u754c\u9762\u9009\u62e9\u955c\u50cf\u4e3a Cuda11.7-conda\uff0c\u5e76\u9009\u62e9 GPU \u4e3a10% A100\u3002</p> <p></p>"},{"location":"chapter7/#212-conda","title":"2.1.2 conda\u73af\u5883\u3001\u6e90\u7801\u53ca\u4f9d\u8d56\u5b89\u88c5","text":"<p><pre><code>studio-conda -o internlm-base -t opencompass\nsource activate opencompass\ngit clone -b 0.2.4 https://github.com/open-compass/opencompass\ncd opencompass\npip install -e .\n</code></pre> </p> <p></p> <p></p> <p></p>"},{"location":"chapter7/#22","title":"2.2 \u6570\u636e","text":"<ul> <li>\u62f7\u8d1d\u89e3\u538b\u5f00\u53d1\u673a\u63d0\u4f9b\u7684\u6570\u636e</li> </ul> <p><pre><code>cp /share/temp/datasets/OpenCompassData-core-20231110.zip /root/opencompass/\nunzip OpenCompassData-core-20231110.zip\n</code></pre> </p> <ul> <li>\u67e5\u770b\u652f\u6301\u7684\u6570\u636e\u96c6\u548c\u6a21\u578b</li> </ul> <pre><code>python tools/list_configs.py internlm ceval\n</code></pre> <p>\u51fa\u73b0\u6a21\u5757\u672a\u5b89\u88c5\u95ee\u9898 </p> <p>\u6267\u884crequirements.txt\u5b89\u88c5</p> <p><pre><code>pip install -r requirements.txt\n</code></pre> </p> <p>\u518d\u6b21\u8fd0\u884c\u53ef\u67e5\u770b\u5230\u6a21\u578b\u548c\u6570\u636e\u5bf9\u5e94\u7684\u914d\u7f6e\u8def\u5f84</p> <p></p>"},{"location":"chapter7/#23","title":"2.3 \u542f\u52a8\u6d4b\u8bc4","text":"<p>\u8bc4\u6d4b InternLM2-Chat-1.8B \u6a21\u578b\u5728 C-Eval \u6570\u636e\u96c6\u4e0a\u7684\u6027\u80fd\u3002</p> <pre><code>python run.py --datasets ceval_gen --hf-path /share/new_models/Shanghai_AI_Laboratory/internlm2-chat-1_8b --tokenizer-path /share/new_models/Shanghai_AI_Laboratory/internlm2-chat-1_8b --tokenizer-kwargs padding_side='left' truncation='left' trust_remote_code=True --model-kwargs trust_remote_code=True device_map='auto' --max-seq-len 1024 --max-out-len 16 --batch-size 2 --num-gpus 1 --debug\n</code></pre> <ul> <li> <p>\u547d\u4ee4\u89e3\u6790 <pre><code>python run.py\n--datasets ceval_gen \\\n--hf-path /share/new_models/Shanghai_AI_Laboratory/internlm2-chat-1_8b \\  # HuggingFace \u6a21\u578b\u8def\u5f84\n--tokenizer-path /share/new_models/Shanghai_AI_Laboratory/internlm2-chat-1_8b \\  # HuggingFace tokenizer \u8def\u5f84\uff08\u5982\u679c\u4e0e\u6a21\u578b\u8def\u5f84\u76f8\u540c\uff0c\u53ef\u4ee5\u7701\u7565\uff09\n--tokenizer-kwargs padding_side='left' truncation='left' trust_remote_code=True \\  # \u6784\u5efa tokenizer \u7684\u53c2\u6570\n--model-kwargs device_map='auto' trust_remote_code=True \\  # \u6784\u5efa\u6a21\u578b\u7684\u53c2\u6570\n--max-seq-len 1024 \\  # \u6a21\u578b\u53ef\u4ee5\u63a5\u53d7\u7684\u6700\u5927\u5e8f\u5217\u957f\u5ea6\n--max-out-len 16 \\  # \u751f\u6210\u7684\u6700\u5927 token \u6570\n--batch-size 2  \\  # \u6279\u91cf\u5927\u5c0f\n--num-gpus 1  # \u8fd0\u884c\u6a21\u578b\u6240\u9700\u7684 GPU \u6570\u91cf\n--debug\n</code></pre></p> </li> <li> <p>Debug\u51fa\u7684\u9519\u8bef</p> </li> </ul> <p>mkl-service + Intel(R) MKL MKL_THREADING_LAYER=INTEL is incompatible with libgomp.so.1 ... </p> <p></p> <p>\u65b0\u589e\u73af\u5883\u53d8\u91cf <pre><code> export MKL_SERVICE_FORCE_INTEL=1\n</code></pre></p> <p>\u95ee\u9898\u89e3\u51b3\u53c2\u8003</p> <p>\u4e2a\u4eba\u7406\u89e3\u4e3a\u591a\u5361\u8bad\u7ec3\u4e2d\u73af\u5883\u8bbe\u7f6e\u7684\u95ee\u9898\u3002\uff08\u663e\u5361\u8d44\u6e90\u865a\u62df\u5316\u3001\u5bb9\u5668\u7f16\u6392\u8c03\u5ea6\uff09</p> <p></p>"},{"location":"chapter7/#24","title":"2.4 \u6d4b\u8bc4\u7ed3\u679c","text":"<ul> <li>\u8f93\u51fa\u5185\u5bb9  </li> </ul>"}]}